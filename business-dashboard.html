<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dashboard - BlkPages</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Security & GDPR Features -->
    <script src="js/security-utils.js"></script>
    <script src="js/cookie-consent.js"></script>
    
    <!-- SMS System -->
    <script src="backend/sms-credit-system.js"></script>
    <script src="backend/verified-business-numbers.js"></script>
    <script src="backend/verified-customer-numbers.js"></script>
    <script src="backend/sms-messaging-system.js"></script>
    <script src="backend/notification-automation-system.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #121212 0%, #1A1A1A 50%, #0F0F0F 100%);
            min-height: 100vh;
            color: #ffffff; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        
        /* Navigation */
        .navbar { 
            background: rgba(0, 0, 0, 0.95); 
            backdrop-filter: blur(10px);
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 1000; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-wrapper { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem 0;
        }
        
        .logo { 
            font-size: 1.8rem; 
            font-weight: 700; 
            color: #ffffff; 
            text-decoration: none; 
            background: linear-gradient(135deg, #FF3CAC, #784BA0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-links { 
            display: flex; 
            list-style: none; 
            gap: 2rem; 
        }
        
        .nav-links a { 
            text-decoration: none; 
            color: #ffffff; 
            font-weight: 500; 
            transition: color 0.3s; 
        }
        
        .nav-links a:hover {
            color: #FF3CAC;
        }
        
        .user-menu { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .user-info { 
            color: #cccccc; 
            font-size: 0.9rem; 
        }
        
        .btn-logout { 
            background: #dc3545;
            color: white; 
            border: none; 
            padding: 0.5rem 1rem; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: background 0.3s;
        }
        
        .btn-logout:hover {
            background: #c82333;
        }
        
        /* SMS Credit Tracker Styles */
        .sms-credit-section {
            margin: 2rem 0;
        }
        
        .sms-credit-section h3 {
            color: #ffffff;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .sms-credit-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }
        
        .sms-credit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        
        .sms-credit-info {
            flex: 1;
        }
        
        .sms-credit-title {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .sms-credit-subtitle {
            color: #cccccc;
            font-size: 0.9rem;
        }
        
        .sms-credit-actions {
            display: flex;
            gap: 1rem;
        }
        
        .btn-sms-add {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-sms-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .sms-credit-tracker {
            margin-bottom: 1.5rem;
        }
        
        .credit-progress {
            margin-bottom: 1rem;
        }
        
        .credit-progress-bar {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .credit-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #059669);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 64%; /* 32/50 = 64% */
        }
        
        .credit-progress-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #D97706);
        }
        
        .credit-progress-fill.critical {
            background: linear-gradient(90deg, #EF4444, #DC2626);
        }
        
        .credit-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .credits-remaining {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .credits-total {
            color: #cccccc;
            font-size: 0.9rem;
        }
        
        .credit-alerts {
            margin-top: 1rem;
        }
        
        .credit-alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .credit-alert.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #F59E0B;
        }
        
        .credit-alert.critical {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #EF4444;
        }
        
        .sms-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .analytics-item {
            text-align: center;
        }
        
        .analytics-label {
            color: #cccccc;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        
        .analytics-value {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        /* SMS Add-on Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h3 {
            color: #ffffff;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #cccccc;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #ffffff;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .sms-addon-options {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .addon-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .addon-info h4 {
            color: #ffffff;
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }
        
        .addon-info p {
            color: #cccccc;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .addon-price {
            color: #10B981;
            font-size: 1.2rem;
            font-weight: 600;
            margin-right: 1rem;
        }
        
        .btn-addon {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-addon:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .sms-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .sms-info p {
            color: #cccccc;
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sms-info p:last-child {
            margin-bottom: 0;
        }
        
        .sms-info i {
            color: #10B981;
        }
        
        /* Main Content */
        .main-content { 
            padding: 120px 0 80px; 
        }
        
        .dashboard-header { 
            margin-bottom: 3rem; 
        }
        
        .dashboard-title { 
            font-size: 2.5rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            background: linear-gradient(135deg, #FF3CAC, #784BA0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-subtitle { 
            color: #cccccc; 
            font-size: 1.1rem; 
        }
        
        /* Stats Cards */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 2rem; 
            margin-bottom: 3rem; 
        }
        
        .stat-card { 
            background: #1A1A1A;
            padding: 2rem; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center; 
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 { 
            font-size: 2rem; 
            font-weight: 700; 
            color: #FF3CAC;
            margin-bottom: 0.5rem; 
        }
        
        .stat-card p { 
            color: #cccccc; 
            font-size: 0.9rem; 
        }
        
        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #1A1A1A;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem 0;
            position: fixed;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            margin: 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            color: #ffffff; 
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #007bff;
        }
        
        .sidebar-menu a i {
            margin-right: 0.75rem;
            width: 20px;
        }
        
        .sidebar-menu .badge {
            background: #ff6b6b;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: auto;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Dashboard Grid */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 3rem; 
            margin-bottom: 3rem; 
        }
        
        /* Cards */
        .card {
            background: #1A1A1A;
            padding: 2rem; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card h3 {
            font-size: 1.5rem; 
            font-weight: 600; 
            margin-bottom: 1.5rem; 
            color: #ffffff; 
        }
        
        .profile-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.8rem 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-item:last-child { 
            border-bottom: none; 
        }
        
        .profile-label { 
            color: #cccccc; 
        }
        
        .profile-value { 
            color: #ffffff; 
            font-weight: 500; 
        }
        
        /* Booking Options Section */
        .booking-options-section {
            background: #1A1A1A;
            padding: 2rem; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 3rem; 
        }
        
        .booking-options-section h3 {
            font-size: 1.5rem; 
            font-weight: 600; 
            margin-bottom: 1.5rem; 
            color: #ffffff; 
        }
        
        .booking-options-card {
            background: #2A2A2A;
            padding: 1.5rem; 
            border-radius: 10px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .setting-info {
            flex: 1;
        }
        
        .setting-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff; 
            margin-bottom: 0.5rem;
        }
        
        .setting-description {
            color: #cccccc; 
            font-size: 0.9rem; 
        }
        
        .setting-control {
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #FF3CAC;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .help-tooltip {
            position: relative;
            cursor: help;
            color: #FF3CAC;
            font-size: 1.2rem;
        }
        
        .tooltip-content {
            visibility: hidden;
            width: 250px;
            background-color: #1A1A1A;
            color: #ffffff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .help-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        .setting-disclaimer {
            background: #2A2A2A;
            border: 1px solid #FF3CAC;
            border-left: 4px solid #FF3CAC;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: flex; 
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .setting-disclaimer i {
            color: #FF3CAC;
            margin-top: 0.2rem;
        }
        
        .setting-disclaimer span {
            color: #cccccc; 
            font-size: 0.9rem; 
            line-height: 1.4;
        }
        
        /* Cancellation Policy Styles */
        .custom-policy {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group {
            margin-bottom: 1rem; 
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #ffffff; 
        }
        
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background: #1A1A1A;
            color: #ffffff;
            resize: vertical;
            min-height: 100px;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #FF3CAC;
            box-shadow: 0 0 0 3px rgba(255, 60, 172, 0.1);
        }
        
        .form-help {
            color: #888888;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: block;
        }
        
        .policy-disclaimer {
            background: rgba(255, 60, 172, 0.1);
            border: 1px solid rgba(255, 60, 172, 0.3);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .policy-disclaimer i {
            color: #FF3CAC;
            font-size: 0.9rem;
            margin-top: 0.1rem;
            flex-shrink: 0;
        }
        
        .policy-disclaimer span {
            color: #e5e7eb;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .policy-preview {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .policy-preview h4 {
            color: #FF3CAC;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .preview-content {
            background: #1A1A1A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 1rem;
            color: #cccccc; 
            font-style: italic;
        }
        
        /* Loyalty Rewards Styles */
        .loyalty-preview-card {
            background: #2A2A2A;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .preview-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #FF3CAC;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .loyalty-progress {
            background: #333; 
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .loyalty-progress-bar {
            background: #444;
            border-radius: 4px; 
            height: 8px;
            margin: 0.5rem 0;
            overflow: hidden; 
        }
        
        .loyalty-progress-fill {
            background: linear-gradient(135deg, #FF3CAC, #784BA0);
            height: 100%; 
            border-radius: 4px; 
            transition: width 0.3s ease;
        }
        
        .loyalty-reward {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        
        .loyalty-reward.unlocked {
            background: rgba(40, 167, 69, 0.2);
            border-color: #28a745;
        }
        
        /* Action Buttons */
        .action-buttons { 
            display: flex; 
            gap: 1rem; 
            flex-wrap: wrap; 
        }
        
        .btn-action { 
            background: linear-gradient(135deg, #FF3CAC, #784BA0);
            color: white; 
            border: none; 
            padding: 0.8rem 1.5rem; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 500; 
            text-decoration: none; 
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-action:hover { 
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 60, 172, 0.3);
        }
        
        .btn-action.secondary { 
            background: transparent; 
            color: #FF3CAC;
            border: 2px solid #FF3CAC;
        }
        
        .btn-action.secondary:hover { 
            background: #FF3CAC;
            color: white; 
        }
        
        /* Reviews Tab Styles */
        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .reviews-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-size: 0.9rem;
            color: #cccccc;
            font-weight: 500;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #333;
            border-radius: 6px;
            background: #2a2a2a; 
            color: #ffffff;
            font-size: 0.9rem;
        }
        
        .review-card {
            background: #1A1A1A;
            border: 1px solid #333; 
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .review-card:hover {
            border-color: #007bff;
        }
        
        .review-card.new {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .review-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            margin-bottom: 1rem; 
        }
        
        .review-customer {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .review-stars {
            color: #ffd700;
            font-size: 1.2rem;
        }
        
        .review-customer-info h4 {
            margin: 0;
            color: #ffffff; 
            font-size: 1.1rem;
        }
        
        .review-customer-info p {
            margin: 0.25rem 0 0 0;
            color: #cccccc;
            font-size: 0.9rem; 
        }
        
        .review-dates {
            text-align: right;
            color: #999;
            font-size: 0.85rem;
        }
        
        .review-text { 
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .review-reply {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .review-reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .review-reply-header h5 {
            margin: 0;
            color: #007bff;
            font-size: 0.9rem;
        }
        
        .review-reply-date {
            color: #999;
            font-size: 0.8rem;
        }
        
        .review-reply-text {
            color: #ffffff;
            line-height: 1.5; 
        }
        
        .reply-form {
            margin-top: 1rem;
            padding: 1rem;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        .reply-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #333;
            border-radius: 6px;
            background: #1a1a1a;
            color: #ffffff;
            font-family: inherit;
            resize: vertical;
        }
        
        .reply-form textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .reply-form-actions {
            display: flex; 
            gap: 1rem; 
            margin-top: 1rem;
        }
        
        .btn-reply {
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.3s ease;
        }
        
        .btn-reply:hover {
            background: #0056b3; 
        }
        
        .btn-cancel {
            background: transparent; 
            color: #cccccc;
            border: 1px solid #333;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-cancel:hover {
            background: #333;
            color: #ffffff;
        }
        
        .reply-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .reply-status.pending {
            background: #ff6b6b;
            color: white; 
        }
        
        .reply-status.posted {
            background: #28a745;
            color: white; 
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        .notification-success {
            background: #28a745;
        }
        
        .notification-error {
            background: #dc3545;
        }
        
        .notification-info {
            background: #007bff;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Upgrade Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #333;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #ffffff;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #cccccc;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #ffffff;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-body p {
            color: #cccccc;
            margin-bottom: 1rem;
        }
        
        .upgrade-benefits {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .upgrade-benefits h4 {
            color: #ffffff;
            margin: 0 0 0.5rem 0;
        }
        
        .upgrade-benefits ul {
            margin: 0;
            padding-left: 1.5rem;
            color: #cccccc;
        }
        
        .upgrade-benefits li {
            margin-bottom: 0.5rem;
        }
        
        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid #333;
        }
        
        .btn-upgrade {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }
        
        .btn-upgrade:hover {
            background: #0056b3;
        }
        
        .btn-cancel {
            background: transparent;
            color: #cccccc;
            border: 1px solid #333;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            flex: 1;
        }
        
        .btn-cancel:hover {
            background: #333;
            color: #ffffff;
        }
        
        /* Refund Information Styling */
        .refund-info {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #EF4444;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .refund-amount {
            color: #EF4444;
            font-weight: 600;
        }
        
        /* Booking Reference Styles */
        .booking-reference {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.25rem;
            font-family: 'Courier New', monospace;
            background: #2a2a2a;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        /* Waiting List Styles */
        .waiting-list-header {
            margin-bottom: 2rem;
        }

        .waiting-list-header h2 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .waiting-list-header p {
            color: #666;
            margin: 0;
        }

        .waiting-list-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .waiting-list-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .waiting-list-actions button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .waiting-list-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .waiting-list-filters select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .waiting-list-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .waiting-list-item.waiting {
            border-left: 4px solid #ffc107;
        }

        .waiting-list-item.offered {
            border-left: 4px solid #17a2b8;
        }

        .waiting-list-item.accepted {
            border-left: 4px solid #28a745;
        }

        .customer-info {
            flex: 1;
        }

        .customer-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .position-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .privacy-notice {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .privacy-notice i {
            color: #28a745;
        }

        /* Notification Status Styles */
        .notification-status {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }

        .notification-header i {
            color: #007bff;
        }

        .notification-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .notification-label {
            font-weight: 500;
            color: #666;
        }

        .notification-status-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .notification-status-badge.sent {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification-status-badge.failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification-status-badge.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .notification-status .privacy-notice {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
            font-size: 0.8rem;
            color: #666;
        }

        .customer-details {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .service-info {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .waiting-list-actions-item {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .waiting-list-empty {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .waiting-list-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ddd;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1A1A1A;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #cccccc;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #ffffff;
            font-size: 0.95rem;
        }

        .form-select,
        .form-input {
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: #2A2A2A;
            color: #ffffff;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: #FF3CAC;
            box-shadow: 0 0 0 3px rgba(255, 60, 172, 0.1);
        }

        .form-help {
            color: #888888;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .modal-preview {
            background: #2A2A2A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .modal-preview-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #FF3CAC;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-modal {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-modal-primary {
            background: linear-gradient(135deg, #FF3CAC, #784BA0);
            color: white;
        }

        .btn-modal-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 60, 172, 0.3);
        }

        .btn-modal-secondary {
            background: transparent;
            color: #cccccc;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-modal-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        /* Loyalty Tab Styles */
        
        /* Loyalty Analytics Styles */
        .loyalty-analytics-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .loyalty-analytics-section h3 {
            color: #374151;
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .analytics-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .analytics-header {
            margin-bottom: 1rem;
        }

        .analytics-header h4 {
            color: #374151;
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .analytics-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .customer-progress-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .customer-initials {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #FF3CAC;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .customer-details {
            flex: 1;
        }

        .customer-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .customer-progress {
            color: #6b7280;
            font-size: 0.75rem;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar-small {
            width: 60px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }

        .progress-percentage {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        .issued-reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .reward-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .reward-code {
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #374151;
            font-weight: 600;
        }

        .reward-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.issued {
            background: #f59e0b;
        }

        .status-dot.redeemed {
            background: #10b981;
        }

        .status-dot.expired {
            background: #6b7280;
        }

        .status-text {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        .reward-date {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
        .loyalty-header {
            margin-bottom: 2rem;
        }
        
        .loyalty-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }
        
        .loyalty-header p {
            color: #cccccc;
            font-size: 1.1rem;
        }
        
        .loyalty-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .loyalty-config-section,
        .loyalty-preview-section {
            background: #1A1A1A;
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .loyalty-config-section h3,
        .loyalty-preview-section h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1.5rem;
        }
        
        .loyalty-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: #ffffff;
            font-size: 0.95rem;
        }
        
        .form-select,
        .form-input {
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: #2A2A2A;
            color: #ffffff;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }
        
        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: #FF3CAC;
            box-shadow: 0 0 0 3px rgba(255, 60, 172, 0.1);
        }
        
        .form-help {
            color: #888888;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .toggle-label {
            color: #cccccc;
            font-size: 0.95rem;
        }
        
        .form-actions {
            margin-top: 1rem;
        }
        
        .customer-preview-card {
            background: #2A2A2A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .preview-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #FF3CAC;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .loyalty-examples-section {
            grid-column: 1 / -1;
            background: #1A1A1A;
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 2rem;
        }
        
        .loyalty-examples-section h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1.5rem;
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .example-card {
            background: #2A2A2A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .example-card:hover {
            border-color: #FF3CAC;
            transform: translateY(-2px);
        }
        
        .example-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .example-header i {
            background: linear-gradient(135deg, #FF3CAC, #784BA0);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        
        .example-header h4 {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .example-details p {
            color: #cccccc;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .example-details strong {
            color: #ffffff;
        }
        
        /* Footer */
        .footer { 
            background: #1A1A1A;
            color: white; 
            padding: 40px 0; 
            text-align: center; 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .nav-links { 
                display: none; 
            }
            
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
            
            .action-buttons { 
                flex-direction: column; 
            }
            
            .reviews-filters {
                flex-direction: column; 
                gap: 1rem; 
            }
            
            .filter-group {
                width: 100%;
            }
            
            .review-header {
                flex-direction: column; 
                gap: 1rem;
            }
            
            .review-dates {
                text-align: left;
            }
            
            .loyalty-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .examples-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Payment Model Display Styles */
        .payment-model-display {
            background: linear-gradient(135deg, #1E90FF, #007bff);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .payment-details-display {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .payment-model-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .payment-model-info i {
            color: #1E90FF;
            font-size: 1.2rem;
        }
        
        .payment-model-info h4 {
            color: #ffffff;
            margin: 0;
            font-size: 1rem;
        }
        
        .payment-model-description {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .payment-model-breakdown {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .payment-model-breakdown h5 {
            color: #1E90FF;
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }
        
        .payment-model-breakdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .payment-model-breakdown li {
            color: #cccccc;
            font-size: 0.85rem;
            padding: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .payment-model-breakdown li i {
            color: #28a745;
            font-size: 0.8rem;
        }

        /* Business Notification Styles */
        .business-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        .business-notification-success {
            border-left: 4px solid #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .business-notification-error {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .business-notification-info {
            border-left: 4px solid #007bff;
            background: rgba(0, 123, 255, 0.1);
        }

        .business-notification .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .business-notification .notification-content i {
            font-size: 1.2rem;
        }

        .business-notification-success .notification-content i {
            color: #28a745;
        }

        .business-notification-error .notification-content i {
            color: #dc3545;
        }

        .business-notification-info .notification-content i {
            color: #007bff;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Notification Log Styles */
        .notification-log-header {
            margin-bottom: 2rem;
        }

        .notification-log-header h2 {
            color: #ffffff;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .notification-log-header p {
            color: #cccccc;
            font-size: 1rem;
        }

        .notification-log-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .notification-log-filters {
            background: #2A2A2A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-group label {
            color: #ffffff;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: #1A1A1A;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #FF3CAC;
            box-shadow: 0 0 0 3px rgba(255, 60, 172, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .notification-log-container {
            background: #2A2A2A;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .notification-log-table {
            overflow-x: auto;
        }

        .notification-log-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .notification-log-table th {
            background: #1A1A1A;
            color: #ffffff;
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .notification-log-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #cccccc;
        }

        .notification-log-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-sent {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid #28a745;
        }

        .status-failed {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .status-queued {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .status-suppressed {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        .status-bounced {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid #dc3545;
            border-style: dashed;
        }

        .notification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-resend {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-resend:hover {
            background: #0056b3;
        }

        .btn-resend:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-details {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn-details:hover {
            background: #5a6268;
        }

        .recipient-masked {
            color: #888888;
            font-family: monospace;
        }

        .attempts-info {
            color: #ffc107;
            font-weight: 600;
        }

        .error-details {
            background: #1A1A1A;
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            color: #dc3545;
            font-size: 0.9rem;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .notification-log-filters {
                padding: 1rem;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .notification-log-table {
                font-size: 0.9rem;
            }
            
            .notification-log-table th,
            .notification-log-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <a href="index.html" class="logo">BlkPages</a>
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="search-results.html">Browse</a></li>
                    <li><a href="offers.html">Offers</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="preview-test.html" style="background: linear-gradient(135deg, #FF3CAC, #784BA0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600;">
                        <i class="fas fa-flask"></i> Preview Test
                    </a></li>
                </ul>
                <div class="user-menu">
                    <span class="user-info" id="userEmail">demo@royalhairstudio.com</span>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" onclick="showSection('dashboard')" class="active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a></li>
                <li><a href="business-bookings-dashboard.html">
                    <i class="fas fa-calendar"></i> Bookings
                </a></li>
                <li><a href="business-services-dashboard.html">
                    <i class="fas fa-cogs"></i> Services
                </a></li>
                <li><a href="business-reviews-dashboard.html">
                    <i class="fas fa-star"></i> Reviews
                    <span class="badge" id="reviewsBadge" style="display: none;">1 new</span>
                </a></li>
                <li><a href="#" onclick="showSection('payouts')">
                    <i class="fas fa-credit-card"></i> Payouts
                </a></li>
                <li><a href="business-analytics-dashboard.html">
                    <i class="fas fa-chart-bar"></i> Analytics
                </a></li>
                <li><a href="#" onclick="showSection('waiting-list')">
                    <i class="fas fa-clock"></i> Waiting List
                    <span class="badge" id="waitingListBadge" style="display: none;">0</span>
                </a></li>
                <li><a href="business-loyalty-dashboard.html" id="loyaltyTab" style="display: block;">
                    <i class="fas fa-gift"></i> Loyalty Rewards
                </a></li>
                <li><a href="#" onclick="showSection('notification-log')">
                    <i class="fas fa-bell"></i> Notification Log
                </a></li>
            </ul>
        </aside>

    <!-- Main Content -->
    <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Business Dashboard</h1>
                <p class="dashboard-subtitle">Manage your business listing and track your performance</p>
            </div>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>127</h3>
                    <p>Total Reviews</p>
                </div>
                <div class="stat-card">
                    <h3>4.9</h3>
                    <p>Average Rating</p>
                </div>
                <div class="stat-card">
                    <h3>1,234</h3>
                    <p>Profile Views</p>
                </div>
                <div class="stat-card">
                    <h3>89</h3>
                    <p>Bookings This Month</p>
                </div>
            </div>
            
            <!-- SMS Credit Tracker -->
            <div class="sms-credit-section">
                <h3>SMS Credits</h3>
                <div class="sms-credit-card">
                    <div class="sms-credit-header">
                        <div class="sms-credit-info">
                            <div class="sms-credit-title">SMS Message Credits</div>
                            <div class="sms-credit-subtitle">Automatic booking notifications and promotional messages</div>
                        </div>
                        <div class="sms-credit-actions">
                            <button class="btn-sms-add" onclick="showSMSAddOnModal()">
                                <i class="fas fa-plus"></i> Buy More Credits
                            </button>
                        </div>
                    </div>
                    
                    <div class="sms-credit-tracker">
                        <div class="credit-progress">
                            <div class="credit-progress-bar">
                                <div class="credit-progress-fill" id="smsProgressFill"></div>
                            </div>
                            <div class="credit-stats">
                                <span class="credits-remaining" id="smsCreditsRemaining">32</span>
                                <span class="credits-total">of 50 SMS remaining</span>
                            </div>
                        </div>
                        
                        <div class="credit-alerts" id="smsCreditAlerts">
                            <!-- Alerts will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="sms-analytics">
                        <div class="analytics-item">
                            <div class="analytics-label">Booking SMS</div>
                            <div class="analytics-value" id="bookingSMS">15</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-label">Promotional SMS</div>
                            <div class="analytics-value" id="promotionalSMS">3</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-label">Weekly Usage</div>
                            <div class="analytics-value" id="weeklyUsage">12</div>
                        </div>
                        <div class="analytics-item">
                            <div class="analytics-label">Days Remaining</div>
                            <div class="analytics-value" id="daysRemaining">15</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loyalty Rewards Section -->
            <div class="booking-options-section">
                <h3>Loyalty Rewards</h3>
                <div class="booking-options-card">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Customer Loyalty Programme</div>
                            <div class="setting-description">Create loyalty programs to encourage repeat bookings and reward your customers</div>
                    </div>
                        <div class="setting-control">
                            <a href="business-loyalty-dashboard.html" class="btn-action" style="background: linear-gradient(135deg, #10B981, #059669); text-decoration: none;">
                                <i class="fas fa-gift"></i> Manage Loyalty Programme
                            </a>
                        </div>
                    </div>
                    </div>
                </div>
                
            <div class="dashboard-grid">
                <!-- Business Profile -->
                <div class="card">
                    <h3>Business Profile</h3>
                        <div class="profile-item">
                            <span class="profile-label">Business Name</span>
                            <span class="profile-value">Royal Hair Studio</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">Category</span>
                            <span class="profile-value">Hairdresser</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">Location</span>
                            <span class="profile-value">Beauty City, BC</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">Status</span>
                        <span class="profile-value" style="color: #28a745;">Active</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-label">Last Updated</span>
                            <span class="profile-value">2 days ago</span>
                        </div>
                    </div>
                
                <!-- Subscription -->
                <div class="card">
                    <h3>Subscription Plan</h3>
                    <div style="background: #2A2A2A; padding: 1.5rem; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ffffff; margin-bottom: 0.5rem;">Professional Plan</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #FF3CAC; margin-bottom: 0.5rem;">£29/month</div>
                        <div style="font-size: 0.9rem; color: #cccccc; margin-bottom: 1.5rem;">Included:</div>
                        <ul style="list-style: none; color: #cccccc;">
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Business listing with category visibility
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Basic contact details
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Standard search placement
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Business logo and photo gallery (up to 10 photos)
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Enhanced profile visibility
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Customer review highlights
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Basic booking system
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Advanced booking system with calendar sync
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Customer management dashboard
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Priority placement in search
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Basic analytics
                            </li>
                            <li style="margin-bottom: 0.5rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                                <i class="fas fa-check" style="color: #28a745; margin-top: 2px; flex-shrink: 0;"></i> Marketing tools
                            </li>
                        </ul>
                    </div>
                    <a href="business-plan-management.html" class="btn-action" style="margin-top: 1.5rem; text-decoration: none; display: inline-block;">
                        <i class="fas fa-credit-card"></i> Manage Plan
                    </a>
                </div>
            </div>
            
            <!-- Booking Options Section -->
            <div class="booking-options-section">
                <h3>Booking Options</h3>
                <div class="booking-options-card">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Enable Pay at Venue</div>
                            <div class="setting-description">Allow customers to book now and pay you directly at your location</div>
                    </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="payAtVenueToggle" onchange="togglePayAtVenue()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="help-tooltip">
                                <i class="fas fa-question-circle"></i>
                                <div class="tooltip-content">
                                    Customers can book now and pay you directly. You are responsible for collecting payment.
                            </div>
                        </div>
                            </div>
                        </div>
                    <div class="setting-disclaimer" id="payAtVenueDisclaimer" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <span>When enabled, customers will see a "Pay at Venue" option on your business profile. You are responsible for collecting payment and handling any payment-related issues.</span>
                            </div>
                        </div>
                            </div>
                
            <!-- Payment Model Section -->
            <div class="booking-options-section">
                <h3>Payment Model Configuration</h3>
                <div class="booking-options-card">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Current Payment Model</div>
                            <div class="setting-description">How customers pay for your services</div>
                        </div>
                        <div class="setting-control">
                            <div id="currentPaymentModel" class="payment-model-display">
                                <!-- Payment model will be loaded from registration data -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Payment Model Details</div>
                            <div class="setting-description">Detailed breakdown of your payment configuration</div>
                        </div>
                        <div class="setting-control">
                            <div id="paymentModelDetails" class="payment-details-display">
                                <!-- Payment details will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-disclaimer">
                        <i class="fas fa-info-circle"></i>
                        <span>Your payment model was set during business registration and cannot be changed here. Contact support if you need to modify your payment settings.</span>
                    </div>
                </div>
            </div>
                
            <!-- Cancellation Policy Section -->
            <div class="booking-options-section">
                <h3>Cancellation Policy</h3>
                <div class="booking-options-card">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Cancellation Terms</div>
                            <div class="setting-description">Define your cancellation and refund policy for customers</div>
                        </div>
                        <div class="setting-control">
                            <select id="cancellationPolicy" class="form-select" onchange="updateCancellationPolicy()">
                                <option value="">Select Cancellation Policy</option>
                                <option value="flexible">Flexible - 24h notice for full refund</option>
                                <option value="moderate">Moderate - 48h notice for full refund</option>
                                <option value="strict">Strict - Non-refundable once confirmed</option>
                                <option value="custom" id="customOption" style="display: none;">Custom (Professional Package Required)</option>
                            </select>
                            <div class="policy-disclaimer">
                                <i class="fas fa-info-circle"></i>
                                <span>This policy is set by Royal Hair Studio. BlkPages processes payments via Stripe on behalf of the venue but is not responsible for enforcing refunds.</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="custom-policy" id="customPolicy" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Custom Cancellation Policy</label>
                            <textarea id="customPolicyText" class="form-textarea" placeholder="Enter your custom cancellation policy..." onchange="updateCustomPolicy()" oninput="updateCustomPolicy()">[Business Name] – Cancellation Policy:
Cancellations: You may cancel your appointment up to [X hours/days] before the scheduled time for a full refund.
Late Cancellations: Cancellations made within [X hours/days] will be charged [X%] of the service price.
No-Shows: If you do not attend your appointment without notice, you will be charged [100%] of the service price.
Refunds: Refunds (where applicable) will be processed back to your original payment method within [X working days].</textarea>
                            <small class="form-help">You can customize the policy text. Use [Business Name] to insert your business name automatically. Replace [X hours/days] and [X%] with your specific terms.</small>
                    </div>
                </div>
                
                    <div class="policy-preview">
                        <h4>Policy Preview</h4>
                        <div class="preview-content" id="previewContent">
                            Free cancellation up to 24 hours before appointment
                            </div>
                        </div>
                        </div>
                    </div>
                    
            <!-- Loyalty Rewards Section -->
            <div class="booking-options-section" id="loyaltySection" style="display: none;">
                <h3>Loyalty Rewards</h3>
                <div class="booking-options-card">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Loyalty Program Type</div>
                            <div class="setting-description">Choose how customers earn rewards</div>
                            </div>
                        <div class="setting-control">
                            <select id="loyaltyType" class="form-select" onchange="updateLoyaltyType()">
                                <option value="">Select Loyalty Type</option>
                                <option value="visitBased">Visit-based: Book X visits, get reward</option>
                                <option value="spendBased">Spend-based: Spend £Y, get reward</option>
                                <option value="timeLimited">Time-limited: Book X visits within Z weeks, get reward</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item" id="thresholdSetting" style="display: none;">
                        <div class="setting-info">
                            <div class="setting-title">Threshold</div>
                            <div class="setting-description" id="thresholdDescription">Set the number of visits or amount to spend</div>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="loyaltyThreshold" class="form-input" placeholder="Enter threshold" min="1">
                        </div>
                    </div>
                    
                    <div class="setting-item" id="timeLimitSetting" style="display: none;">
                        <div class="setting-info">
                            <div class="setting-title">Time Limit (Weeks)</div>
                            <div class="setting-description">How many weeks customers have to complete visits</div>
                            </div>
                        <div class="setting-control">
                            <input type="number" id="loyaltyTimeLimit" class="form-input" placeholder="Enter weeks" min="1">
                        </div>
                        </div>
                    
                    <div class="setting-item" id="rewardTypeSetting" style="display: none;">
                        <div class="setting-info">
                            <div class="setting-title">Reward Type</div>
                            <div class="setting-description">What reward customers receive</div>
                        </div>
                        <div class="setting-control">
                            <select id="rewardType" class="form-select" onchange="updateRewardType()">
                                <option value="">Select Reward Type</option>
                                <option value="freeService">1 Free Service</option>
                                <option value="fixedDiscount">Fixed £ Discount</option>
                                <option value="percentageDiscount">% Discount</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item" id="rewardValueSetting" style="display: none;">
                        <div class="setting-info">
                            <div class="setting-title">Reward Value</div>
                            <div class="setting-description" id="rewardValueDescription">Set the discount amount or percentage</div>
                        </div>
                        <div class="setting-control">
                            <input type="number" id="loyaltyRewardValue" class="form-input" placeholder="Enter value" min="1">
                        </div>
                    </div>
                    
                    <div class="setting-item" id="loyaltyPreview" style="display: none;">
                        <div class="setting-info">
                            <div class="setting-title">Customer Preview</div>
                            <div class="setting-description">How customers will see your loyalty program</div>
                        </div>
                        <div class="setting-control">
                            <div class="loyalty-preview-card">
                                <div class="preview-header">
                                    <i class="fas fa-gift"></i>
                                    <span>Loyalty Rewards</span>
                                </div>
                                <div class="preview-content" id="loyaltyPreviewContent">
                                    <!-- Preview content will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Enable Loyalty Programme</div>
                            <div class="setting-description">Turn your loyalty programme on or off</div>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="loyaltyEnabled" onchange="toggleLoyaltyProgram()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-control">
                            <button class="btn-action" onclick="saveLoyaltyProgram()" id="saveLoyaltyBtn" style="display: none;">
                                <i class="fas fa-save"></i> Save Loyalty Program
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loyalty Analytics Section -->
                    <div class="loyalty-analytics-section">
                        <h3>Loyalty Analytics</h3>
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <div class="analytics-header">
                                    <h4>Customer Progress</h4>
                                    <span class="analytics-subtitle">Anonymized customer data</span>
                                </div>
                                <div class="customer-progress-list" id="customerProgressList">
                                    <!-- Customer progress items will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="analytics-header">
                                    <h4>Issued Rewards</h4>
                                    <span class="analytics-subtitle">Reward codes and redemption status</span>
                                </div>
                                <div class="issued-rewards-list" id="issuedRewardsList">
                                    <!-- Issued rewards will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add-Ons Section -->
            <div class="booking-options-section">
                <h3>Add-Ons</h3>
                <div class="booking-options-card">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-title">Premium Features</div>
                            <div class="setting-description">Additional features and tools to enhance your business listing</div>
                        </div>
                        <div class="setting-control">
                            <span style="color: #10B981; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Available
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="business-booking-manager.html" class="btn-action">
                    <i class="fas fa-magic"></i> Generate Booking Link
                </a>
                <a href="business-profile.html" class="btn-action">
                    <i class="fas fa-eye"></i> View Public Profile
                </a>
                <a href="business-analytics-dashboard.html" class="btn-action secondary">
                    <i class="fas fa-chart-bar"></i> View Analytics
                </a>
                <a href="business-bookings-dashboard.html" class="btn-action secondary">
                    <i class="fas fa-calendar"></i> Manage Bookings
                </a>
                <a href="business-photo-upload.html" class="btn-action secondary">
                    <i class="fas fa-camera"></i> Upload Photos
                </a>
            </div>
        </div>
        
        <!-- Reviews Section -->
        <div id="reviews" class="content-section">
            <div class="reviews-header">
                <h2>Customer Reviews</h2>
                <div class="reply-status pending">3 Pending Reply</div>
            </div>
            
            <!-- Filters -->
            <div class="reviews-filters">
                <div class="filter-group">
                    <label for="ratingFilter">⭐ Rating</label>
                    <select id="ratingFilter" onchange="filterReviews()">
                        <option value="all">All Ratings</option>
                        <option value="5">5 Stars</option>
                        <option value="4">4 Stars</option>
                        <option value="3">3 Stars</option>
                        <option value="2">2 Stars</option>
                        <option value="1">1 Star</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFilter">📅 Date Range</label>
                    <select id="dateFilter" onchange="filterReviews()">
                        <option value="all">All Time</option>
                        <option value="week">Last Week</option>
                        <option value="month">Last Month</option>
                        <option value="quarter">Last 3 Months</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="replyFilter">📝 Reply Status</label>
                    <select id="replyFilter" onchange="filterReviews()">
                        <option value="all">All Reviews</option>
                        <option value="pending">Pending Reply</option>
                        <option value="replied">Replied</option>
                    </select>
                </div>
            </div>
            
            <!-- Reviews List -->
            <div id="reviewsList">
                <!-- Review 1: Jane S. - 5 stars - Reply posted -->
                <div class="review-card" data-rating="5" data-date="2024-01-15" data-reply="replied">
                    <div class="review-header">
                        <div class="review-customer">
                            <div class="review-stars">★★★★★</div>
                            <div class="review-customer-info">
                                <h4>Jane S.</h4>
                                <p>Haircut • Appointment: Jan 10, 2024</p>
                                <div class="booking-reference">Booking Ref: #BK-2024-001</div>
                            </div>
                        </div>
                        <div class="review-dates">
                            <div>Review: Jan 15, 2024</div>
                            <span class="reply-status posted">Reply posted</span>
                        </div>
                    </div>
                    <div class="review-text">
                        "Great haircut and friendly staff! Sarah was amazing and really listened to what I wanted. The salon is clean and modern. Will definitely be back!"
                    </div>
                    <div class="review-reply">
                        <div class="review-reply-header">
                            <h5>Your Reply</h5>
                            <span class="review-reply-date">Posted on Jan 15, 2024</span>
                        </div>
                        <div class="review-reply-text">
                            "Thanks Jane, we look forward to seeing you again! Sarah will be thrilled to hear you enjoyed your visit."
                        </div>
                    </div>
                </div>
                
                <!-- Review 2: Tom B. - 3 stars - No reply -->
                <div class="review-card new" data-rating="3" data-date="2024-01-14" data-reply="pending">
                    <div class="review-header">
                        <div class="review-customer">
                            <div class="review-stars">★★★☆☆</div>
                            <div class="review-customer-info">
                                <h4>Tom B.</h4>
                                <p>Massage • Appointment: Jan 12, 2024</p>
                                <div class="booking-reference">Booking Ref: #BK-2024-002</div>
                            </div>
                        </div>
                        <div class="review-dates">
                            <div>Review: Jan 14, 2024</div>
                            <span class="reply-status pending">Reply pending</span>
                        </div>
                    </div>
                    <div class="review-text">
                        "Service was ok but waited 15 minutes past my appointment time. The massage itself was decent but the delay was frustrating."
                    </div>
                    <div class="reply-form" id="replyForm-2" style="display: none;">
                        <textarea placeholder="Write your reply to Tom B..."></textarea>
                        <div class="reply-form-actions">
                            <button class="btn-reply" onclick="submitReply(2)">Submit Reply</button>
                            <button class="btn-cancel" onclick="cancelReply(2)">Cancel</button>
                        </div>
                    </div>
                    <button class="btn-reply" onclick="showReplyForm(2)" style="margin-top: 1rem;">Reply</button>
                </div>
                
                <!-- Review 3: Sara L. - 4 stars - No reply -->
                <div class="review-card" data-rating="4" data-date="2024-01-13" data-reply="pending">
                    <div class="review-header">
                        <div class="review-customer">
                            <div class="review-stars">★★★★☆</div>
                            <div class="review-customer-info">
                                <h4>Sara L.</h4>
                                <p>Manicure • Appointment: Jan 11, 2024</p>
                                <div class="booking-reference">Booking Ref: #BK-2024-003</div>
                            </div>
                        </div>
                        <div class="review-dates">
                            <div>Review: Jan 13, 2024</div>
                            <span class="reply-status pending">Reply pending</span>
                        </div>
                    </div>
                    <div class="review-text">
                        "Good job, but polish chipped the next day. The technician was friendly and the salon was clean. Maybe need better quality polish?"
                    </div>
                    <div class="reply-form" id="replyForm-3" style="display: none;">
                        <textarea placeholder="Write your reply to Sara L..."></textarea>
                        <div class="reply-form-actions">
                            <button class="btn-reply" onclick="submitReply(3)">Submit Reply</button>
                            <button class="btn-cancel" onclick="cancelReply(3)">Cancel</button>
                        </div>
                    </div>
                    <button class="btn-reply" onclick="showReplyForm(3)" style="margin-top: 1rem;">Reply</button>
                </div>
                
                <!-- Review 4: Mike D. - 5 stars - No reply -->
                <div class="review-card" data-rating="5" data-date="2024-01-12" data-reply="pending">
                    <div class="review-header">
                        <div class="review-customer">
                            <div class="review-stars">★★★★★</div>
                            <div class="review-customer-info">
                                <h4>Mike D.</h4>
                                <p>Beard Trim • Appointment: Jan 10, 2024</p>
                                <div class="booking-reference">Booking Ref: #BK-2024-004</div>
                            </div>
                        </div>
                        <div class="review-dates">
                            <div>Review: Jan 12, 2024</div>
                            <span class="reply-status pending">Reply pending</span>
                        </div>
                    </div>
                    <div class="review-text">
                        "Perfect beard trim! The barber was professional and took his time. Great attention to detail. Highly recommend!"
                    </div>
                    <div class="reply-form" id="replyForm-4" style="display: none;">
                        <textarea placeholder="Write your reply to Mike D..."></textarea>
                        <div class="reply-form-actions">
                            <button class="btn-reply" onclick="submitReply(4)">Submit Reply</button>
                            <button class="btn-cancel" onclick="cancelReply(4)">Cancel</button>
                        </div>
                    </div>
                    <button class="btn-reply" onclick="showReplyForm(4)" style="margin-top: 1rem;">Reply</button>
                </div>
            </div>
        </div>
        
        <!-- Other sections (Bookings, Services, etc.) -->
        <div id="bookings" class="content-section">
            <h2>Bookings Management</h2>
            <p>Manage your appointments and availability here.</p>
        </div>
        
        <div id="services" class="content-section">
            <h2>Services Management</h2>
            <p>Manage your services and pricing here.</p>
        </div>
        
        <div id="payouts" class="content-section">
            <h2>Payouts</h2>
            <p>Track your earnings and payouts here.</p>
        </div>
        
        <div id="analytics" class="content-section">
            <h2>Analytics</h2>
            <p>View detailed analytics and insights here.</p>
        </div>
        
        <!-- Waiting List Section -->
        <div id="waiting-list" class="content-section">
            <div class="waiting-list-header">
                <h2>Waiting List</h2>
                <p>Manage customers waiting for appointment slots</p>
            </div>
            
            <div class="waiting-list-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalWaiting">0</div>
                    <div class="stat-label">Total Waiting</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="offersSent">0</div>
                    <div class="stat-label">Offers Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="acceptedOffers">0</div>
                    <div class="stat-label">Accepted</div>
                </div>
            </div>
            
            <div class="waiting-list-actions">
                <button class="btn-primary" onclick="sendOfferToNextCustomer()">
                    <i class="fas fa-paper-plane"></i> Send Offer to Next Customer
                </button>
                <button class="btn-secondary" onclick="refreshWaitingList()">
                    <i class="fas fa-sync"></i> Refresh List
                </button>
            </div>
            
            <div class="waiting-list-container">
                <div class="waiting-list-filters">
                    <select id="statusFilter" onchange="filterWaitingList()">
                        <option value="all">All Status</option>
                        <option value="waiting">Waiting</option>
                        <option value="offered">Offered</option>
                        <option value="accepted">Accepted</option>
                    </select>
                    <select id="serviceFilter" onchange="filterWaitingList()">
                        <option value="all">All Services</option>
                        <option value="haircut">Haircut</option>
                        <option value="styling">Styling</option>
                        <option value="coloring">Coloring</option>
                    </select>
                </div>
                
                <div id="waitingListContent">
                    <!-- Waiting list items will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Loyalty Rewards Tab -->
        <div id="loyalty" class="content-section">
            <div class="loyalty-header">
                <h2>Loyalty Rewards Programme</h2>
                <p>Create and manage customer loyalty programs to encourage repeat bookings</p>
            </div>
            
            <div class="loyalty-container">
                <!-- Loyalty Program Configuration -->
                <div class="loyalty-config-section">
                    <h3>Configure Your Loyalty Programme</h3>
                    
                    <div class="loyalty-form">
                        <!-- Loyalty Type -->
                        <div class="form-group">
                            <label for="tabLoyaltyType">Loyalty Program Type</label>
                            <select id="tabLoyaltyType" class="form-select" onchange="updateTabLoyaltyType()">
                                <option value="">Select Loyalty Type</option>
                                <option value="visitBased">Visit-based: Book X visits, get reward</option>
                                <option value="spendBased">Spend-based: Spend £Y, get reward</option>
                                <option value="timeLimited">Time-limited: Book X visits within Z weeks, get reward</option>
                            </select>
                            <small class="form-help">Choose how customers earn rewards</small>
                        </div>
                        
                        <!-- Threshold Setting -->
                        <div class="form-group" id="tabThresholdSetting" style="display: none;">
                            <label for="tabLoyaltyThreshold">Threshold</label>
                            <input type="number" id="tabLoyaltyThreshold" class="form-input" placeholder="Enter threshold" min="1" onchange="updateTabLoyaltyPreview()">
                            <small class="form-help" id="tabThresholdDescription">Set the number of visits or amount to spend</small>
                        </div>
                        
                        <!-- Time Limit Setting -->
                        <div class="form-group" id="tabTimeLimitSetting" style="display: none;">
                            <label for="tabLoyaltyTimeLimit">Time Limit (Weeks)</label>
                            <input type="number" id="tabLoyaltyTimeLimit" class="form-input" placeholder="Enter weeks" min="1" onchange="updateTabLoyaltyPreview()">
                            <small class="form-help">How many weeks customers have to complete visits</small>
                        </div>
                        
                        <!-- Reward Type -->
                        <div class="form-group" id="tabRewardTypeSetting" style="display: none;">
                            <label for="tabRewardType">Reward Type</label>
                            <select id="tabRewardType" class="form-select" onchange="updateTabRewardType()">
                                <option value="">Select Reward Type</option>
                                <option value="freeService">1 Free Service</option>
                                <option value="fixedDiscount">Fixed £ Discount</option>
                                <option value="percentageDiscount">% Discount</option>
                            </select>
                            <small class="form-help">What reward customers receive</small>
                        </div>
                        
                        <!-- Reward Value -->
                        <div class="form-group" id="tabRewardValueSetting" style="display: none;">
                            <label for="tabLoyaltyRewardValue">Reward Value</label>
                            <input type="number" id="tabLoyaltyRewardValue" class="form-input" placeholder="Enter value" min="1" onchange="updateTabLoyaltyPreview()">
                            <small class="form-help" id="tabRewardValueDescription">Set the discount amount or percentage</small>
                        </div>
                        
                        <!-- Expiry Days -->
                        <div class="form-group" id="tabExpiryDaysSetting" style="display: none;">
                            <label for="tabLoyaltyExpiryDays">Reward Expiry Days</label>
                            <input type="number" id="tabLoyaltyExpiryDays" class="form-input" placeholder="Enter days" min="1" max="365" onchange="updateTabLoyaltyPreview()">
                            <small class="form-help">How many days customers have to use their reward (1-365 days)</small>
                        </div>
                        
                        <!-- Terms -->
                        <div class="form-group" id="tabTermsSetting" style="display: none;">
                            <label for="tabLoyaltyTerms">Terms & Conditions</label>
                            <textarea id="tabLoyaltyTerms" class="form-textarea" placeholder="Enter terms and conditions (optional)" rows="3" onchange="updateTabLoyaltyPreview()"></textarea>
                            <small class="form-help">Optional terms and conditions for your loyalty programme</small>
                        </div>
                        
                        <!-- Enable Toggle -->
                        <div class="form-group">
                            <label>Enable Loyalty Programme</label>
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="tabLoyaltyEnabled" onchange="updateTabLoyaltyPreview()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label">Turn your loyalty programme on or off</span>
                            </div>
                        </div>
                        
                        <!-- Save Button -->
                        <div class="form-actions">
                            <button class="btn-action" onclick="saveTabLoyaltyProgram()" id="tabSaveLoyaltyBtn" style="display: none;">
                                <i class="fas fa-save"></i> Save Programme
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Preview -->
                <div class="loyalty-preview-section">
                    <h3>Customer Preview</h3>
                    <div class="customer-preview-card" id="tabLoyaltyPreview" style="display: none;">
                        <div class="preview-header">
                            <i class="fas fa-eye"></i>
                            <span>How customers will see your loyalty program</span>
                        </div>
                        <div id="tabLoyaltyPreviewContent">
                            <!-- Preview content will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Dummy Data Examples -->
                <div class="loyalty-examples-section">
                    <h3>Example Loyalty Programmes</h3>
                    <div class="examples-grid">
                        <div class="example-card">
                            <div class="example-header">
                                <i class="fas fa-cut"></i>
                                <h4>Glow Hair</h4>
                            </div>
                            <div class="example-details">
                                <p><strong>Type:</strong> Visit-based</p>
                                <p><strong>Threshold:</strong> 5 visits</p>
                                <p><strong>Reward:</strong> Free haircut</p>
                                <p><strong>Customer sees:</strong> "3 of 5 visits complete. Reward: Free haircut."</p>
                            </div>
                        </div>
                        
                        <div class="example-card">
                            <div class="example-header">
                                <i class="fas fa-spa"></i>
                                <h4>Zen Spa</h4>
                            </div>
                            <div class="example-details">
                                <p><strong>Type:</strong> Spend-based</p>
                                <p><strong>Threshold:</strong> £100 spend</p>
                                <p><strong>Reward:</strong> £10 credit</p>
                                <p><strong>Customer sees:</strong> "£75 of £100 spent. Reward: £10 off next booking."</p>
                            </div>
                        </div>
                        
                        <div class="example-card">
                            <div class="example-header">
                                <i class="fas fa-dumbbell"></i>
                                <h4>Fit Gym</h4>
                            </div>
                            <div class="example-details">
                                <p><strong>Type:</strong> Time-limited</p>
                                <p><strong>Threshold:</strong> 3 visits in 6 weeks</p>
                                <p><strong>Reward:</strong> 50% off</p>
                                <p><strong>Customer sees:</strong> "2 of 3 visits complete (4 weeks remaining). Reward: 50% off next booking."</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification Log Section -->
        <div id="notification-log" class="content-section">
            <div class="notification-log-header">
                <h2>Notification Log</h2>
                <p>Track all notifications sent to customers and view delivery status</p>
            </div>
            
            <div class="notification-log-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalNotifications">0</div>
                    <div class="stat-label">Total Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successfulNotifications">0</div>
                    <div class="stat-label">Successful</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failedNotifications">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingNotifications">0</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>
            
            <div class="notification-log-filters">
                <div class="filter-group">
                    <label for="notificationTypeFilter">Type</label>
                    <select id="notificationTypeFilter" onchange="filterNotifications()">
                        <option value="all">All Types</option>
                        <option value="booking.create">Booking Confirmation</option>
                        <option value="booking.cancel">Booking Cancellation</option>
                        <option value="waitinglist.slot.opened">Waiting List Offer</option>
                        <option value="stripe.payment_failed">Payment Failed</option>
                        <option value="sms.credits.threshold">SMS Low Credit</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="notificationStatusFilter">Status</label>
                    <select id="notificationStatusFilter" onchange="filterNotifications()">
                        <option value="all">All Status</option>
                        <option value="sent">Sent</option>
                        <option value="failed">Failed</option>
                        <option value="queued">Queued</option>
                        <option value="suppressed">Suppressed</option>
                        <option value="bounced">Bounced</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="notificationChannelFilter">Channel</label>
                    <select id="notificationChannelFilter" onchange="filterNotifications()">
                        <option value="all">All Channels</option>
                        <option value="email">Email</option>
                        <option value="sms">SMS</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="notificationDateFilter">Date Range</label>
                    <input type="date" id="notificationDateFilter" onchange="filterNotifications()">
                </div>
                
                <div class="filter-actions">
                    <button class="btn-secondary" onclick="exportNotificationLog()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button class="btn-primary" onclick="refreshNotificationLog()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="notification-log-container">
                <div class="notification-log-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Recipient</th>
                                <th>Channel</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Attempts</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notificationLogContent">
                            <!-- Notification log entries will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    </div>

    <!-- Loyalty Rewards Modal -->
    <div id="loyaltyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-gift"></i>
                    Loyalty Rewards Programme
                </h2>
                <button class="modal-close" onclick="closeLoyaltyModal()">
                    <i class="fas fa-times"></i>
                </button>
                </div>
            
            <div class="modal-body">
                <form class="modal-form" id="loyaltyForm">
                    <!-- Loyalty Type -->
                    <div class="form-group">
                        <label class="form-label" for="modalLoyaltyType">Loyalty Program Type</label>
                        <select id="modalLoyaltyType" class="form-select" onchange="updateModalLoyaltyType()">
                            <option value="">Select Loyalty Type</option>
                            <option value="visitBased">Visit-based: Book X visits, get reward</option>
                            <option value="spendBased">Spend-based: Spend £Y, get reward</option>
                            <option value="timeLimited">Time-limited: Book X visits within Z weeks, get reward</option>
                        </select>
                        <small class="form-help">Choose how customers earn rewards</small>
                </div>
                    
                    <!-- Threshold Setting -->
                    <div class="form-group" id="modalThresholdSetting" style="display: none;">
                        <label class="form-label" for="modalLoyaltyThreshold">Threshold</label>
                        <input type="number" id="modalLoyaltyThreshold" class="form-input" placeholder="Enter threshold" min="1" onchange="updateModalLoyaltyPreview()">
                        <small class="form-help" id="modalThresholdDescription">Set the number of visits or amount to spend</small>
            </div>
                    
                    <!-- Time Limit Setting -->
                    <div class="form-group" id="modalTimeLimitSetting" style="display: none;">
                        <label class="form-label" for="modalLoyaltyTimeLimit">Time Limit (Weeks)</label>
                        <input type="number" id="modalLoyaltyTimeLimit" class="form-input" placeholder="Enter weeks" min="1" onchange="updateModalLoyaltyPreview()">
                        <small class="form-help">How many weeks customers have to complete visits</small>
                    </div>
                    
                    <!-- Reward Type -->
                    <div class="form-group" id="modalRewardTypeSetting" style="display: none;">
                        <label class="form-label" for="modalRewardType">Reward Type</label>
                        <select id="modalRewardType" class="form-select" onchange="updateModalRewardType()">
                            <option value="">Select Reward Type</option>
                            <option value="freeService">1 Free Service</option>
                            <option value="fixedDiscount">Fixed £ Discount</option>
                            <option value="percentageDiscount">% Discount</option>
                        </select>
                        <small class="form-help">What reward customers receive</small>
                    </div>
                    
                    <!-- Reward Value -->
                    <div class="form-group" id="modalRewardValueSetting" style="display: none;">
                        <label class="form-label" for="modalLoyaltyRewardValue">Reward Value</label>
                        <input type="number" id="modalLoyaltyRewardValue" class="form-input" placeholder="Enter value" min="1" onchange="updateModalLoyaltyPreview()">
                        <small class="form-help" id="modalRewardValueDescription">Set the discount amount or percentage</small>
                    </div>
                    
                    <!-- Preview -->
                    <div class="modal-preview" id="modalLoyaltyPreview" style="display: none;">
                        <div class="modal-preview-header">
                            <i class="fas fa-eye"></i>
                            Customer Preview
                        </div>
                        <div id="modalLoyaltyPreviewContent">
                            <!-- Preview content will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Enable Toggle -->
                    <div class="form-group">
                        <label class="form-label">Enable Loyalty Programme</label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="modalLoyaltyEnabled" onchange="updateModalLoyaltyPreview()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span style="color: #cccccc;">Turn your loyalty programme on or off</span>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="closeLoyaltyModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-modal btn-modal-primary" onclick="saveModalLoyaltyProgram()" id="modalSaveLoyaltyBtn">
                    <i class="fas fa-save"></i> Save Programme
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 BlkPages – Supporting Black-owned Businesses</p>
        </div>
    </footer>

    <script>
        // Load business data from registration
        function loadBusinessData() {
            // Try to load from localStorage first (from business registration)
            const businessRegistrationData = localStorage.getItem('businessRegistrationData');
            if (businessRegistrationData) {
                try {
                    return JSON.parse(businessRegistrationData);
                } catch (e) {
                    console.error('Error parsing business registration data:', e);
                }
            }
            
            // Fallback to business manager if available
            if (typeof window.businessManager !== 'undefined') {
                const businesses = window.businessManager.getBusinesses();
                if (businesses.length > 0) {
                    // Return the first business data (in real app, would match current business)
                    return businesses[0];
                }
            }
            
            // Default fallback data
            return {
                paymentModel: 'deposit-balance',
                depositPercentage: '30',
                businessName: 'Royal Hair Studio'
            };
        }
        
        // Get current business plan
        function getCurrentBusinessPlan() {
            const businessData = loadBusinessData();
            return businessData.selectedTier || 'free'; // Default to free, only show custom for professional
        }
        
        // Update payment model display
        function updatePaymentModelDisplay() {
            const businessData = loadBusinessData();
            const currentPaymentModel = document.getElementById('currentPaymentModel');
            const paymentModelDetails = document.getElementById('paymentModelDetails');
            
            const paymentModel = businessData.paymentModel || 'deposit-balance';
            const depositPercentage = parseInt(businessData.depositPercentage) || 30;
            const businessName = businessData.businessName || 'Royal Hair Studio';
            
            // Update current payment model display
            let modelTitle = '';
            let modelDescription = '';
            
            switch (paymentModel) {
                case 'full-online':
                    modelTitle = 'Full Payment Online';
                    modelDescription = 'Customers pay the full amount online when booking';
                    break;
                case 'deposit-balance':
                    modelTitle = `Deposit + Balance (${depositPercentage}%)`;
                    modelDescription = `Customers pay ${depositPercentage}% deposit online, balance at venue`;
                    break;
                case 'full-venue':
                    modelTitle = 'Full Payment at Venue';
                    modelDescription = 'Customers pay the full amount when they arrive';
                    break;
                default:
                    modelTitle = 'Deposit + Balance (30%)';
                    modelDescription = 'Customers pay 30% deposit online, balance at venue';
            }
            
            currentPaymentModel.innerHTML = modelTitle;
            
            // Update payment model details
            let detailsHTML = `
                <div class="payment-model-info">
                    <i class="fas fa-credit-card"></i>
                    <h4>${modelTitle}</h4>
                </div>
                <div class="payment-model-description">
                    ${modelDescription}
                </div>
                <div class="payment-model-breakdown">
                    <h5>How it works:</h5>
                    <ul>
            `;
            
            switch (paymentModel) {
                case 'full-online':
                    detailsHTML += `
                        <li><i class="fas fa-check"></i> Customer selects services and books appointment</li>
                        <li><i class="fas fa-check"></i> Full payment is processed online via Stripe</li>
                        <li><i class="fas fa-check"></i> No additional payment required at venue</li>
                        <li><i class="fas fa-check"></i> Payment is secure and encrypted</li>
                    `;
                    break;
                case 'deposit-balance':
                    detailsHTML += `
                        <li><i class="fas fa-check"></i> Customer selects services and books appointment</li>
                        <li><i class="fas fa-check"></i> ${depositPercentage}% deposit is processed online via Stripe</li>
                        <li><i class="fas fa-check"></i> Remaining balance is paid at the venue</li>
                        <li><i class="fas fa-check"></i> Deposit secures the booking</li>
                    `;
                    break;
                case 'full-venue':
                    detailsHTML += `
                        <li><i class="fas fa-check"></i> Customer selects services and books appointment</li>
                        <li><i class="fas fa-check"></i> No online payment required</li>
                        <li><i class="fas fa-check"></i> Full payment is made at the venue</li>
                        <li><i class="fas fa-check"></i> You collect payment directly</li>
                    `;
                    break;
            }
            
            detailsHTML += `
                    </ul>
                </div>
            `;
            
            paymentModelDetails.innerHTML = detailsHTML;
        }
        
        // Load and update analytics data
        function loadAnalyticsData() {
            const businessId = 'royalHairStudio';
            const analyticsData = JSON.parse(localStorage.getItem('businessAnalytics') || '{}');
            
            if (analyticsData[businessId]) {
                const data = analyticsData[businessId];
                const today = new Date().toISOString().split('T')[0];
                const todayViews = data.dailyViews[today] || 0;
                
                // Update the stat cards on the dashboard
                updateDashboardStat('Profile Views', data.totalViews || 0);
                updateDashboardStat('Rating', '4.6'); // Keep static for now
                updateDashboardStat('Reviews', '89'); // Keep static for now
                updateDashboardStat('Bookings This Month', data.enquiries || 0); // Use real enquiries data
                
                console.log('Dashboard analytics updated:', {
                    totalViews: data.totalViews,
                    todayViews: todayViews
                });
            }
        }
        
        function updateDashboardStat(label, value) {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                const labelElement = card.querySelector('p');
                if (labelElement && labelElement.textContent.trim() === label) {
                    const numberElement = card.querySelector('h3');
                    if (numberElement) {
                        numberElement.textContent = value;
                        console.log(`Dashboard updated ${label} to ${value}`);
                    }
                }
            });
        }
        
        // Listen for analytics updates
        window.addEventListener('analyticsUpdated', function(e) {
            console.log('Dashboard received analytics update:', e.detail);
            loadAnalyticsData();
        });
        
        // Listen for storage changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'businessAnalytics') {
                loadAnalyticsData();
            }
        });
        
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('businessLoggedIn');
            console.log('Checking login status:', isLoggedIn);
            
            // Load and display payment model
            updatePaymentModelDisplay();
            
            // Update cancellation policy based on current plan
            updateCancellationPolicy();
            
            // Load analytics data
            loadAnalyticsData();
            
            // Setup booking event listeners
            setupBusinessBookingEventListeners();
            
            // Load loyalty analytics
            loadLoyaltyAnalytics();
        if (isLoggedIn !== 'true') {
            console.log('User not logged in, but allowing access for testing');
            // Set demo login status for testing
            localStorage.setItem('businessLoggedIn', 'true');
            localStorage.setItem('businessEmail', 'demo@royalhairstudio.com');
            localStorage.setItem('businessLoginTime', new Date().toISOString());
        } else {
            console.log('User is logged in, showing dashboard');
        }
        
        // Set user email
        const userEmail = localStorage.getItem('businessEmail') || 'demo@royalhairstudio.com';
            const userEmailElement = document.getElementById('userEmail');
            if (userEmailElement) {
                userEmailElement.textContent = userEmail;
            }
            
            // Load saved settings
            const payAtVenueEnabled = localStorage.getItem('payAtVenueEnabled');
            if (payAtVenueEnabled === 'true') {
                document.getElementById('payAtVenueToggle').checked = true;
                document.getElementById('payAtVenueDisclaimer').style.display = 'flex';
            }
            
            // Check if loyalty add-on is active and show/hide tab
            const loyaltyAddonActive = localStorage.getItem('loyaltyAddonActive') === 'true';
            const loyaltyTab = document.getElementById('loyaltyTab');
            if (loyaltyTab) {
                // Always show tab for testing purposes
                loyaltyTab.style.display = 'block';
                console.log('Loyalty tab is visible for testing');
                
                // Log add-on status
                if (loyaltyAddonActive) {
                    console.log('Loyalty add-on is active');
                } else {
                    console.log('Loyalty add-on is not active (but tab is visible for testing)');
                }
            }
        });
        
        function logout() {
            localStorage.removeItem('businessLoggedIn');
            localStorage.removeItem('businessEmail');
            localStorage.removeItem('businessLoginTime');
            window.location.href = 'business-login.html';
        }
        
        function togglePayAtVenue() {
            const toggle = document.getElementById('payAtVenueToggle');
            const disclaimer = document.getElementById('payAtVenueDisclaimer');
            
            if (toggle.checked) {
                disclaimer.style.display = 'flex';
                localStorage.setItem('payAtVenueEnabled', 'true');
                localStorage.setItem('royalHairStudioPayAtVenue', 'true');
                console.log('Pay at Venue enabled');
            } else {
                disclaimer.style.display = 'none';
                localStorage.setItem('payAtVenueEnabled', 'false');
                localStorage.setItem('royalHairStudioPayAtVenue', 'false');
                console.log('Pay at Venue disabled');
            }
        }
        
        function updateCancellationPolicy() {
            const policySelect = document.getElementById('cancellationPolicy');
            const customPolicy = document.getElementById('customPolicy');
            const previewContent = document.getElementById('previewContent');
            
            const businessName = 'Royal Hair Studio'; // In real implementation, get from business data
            
            // Check if business has Professional package specifically
            const currentPlan = getCurrentBusinessPlan();
            const hasProfessionalPlan = currentPlan === 'professional';
            
            // Show/hide custom option based on Professional package
            if (hasProfessionalPlan) {
                document.getElementById('customOption').style.display = 'block';
            } else {
                document.getElementById('customOption').style.display = 'none';
                if (policySelect.value === 'custom') {
                    policySelect.value = '';
                    return;
                }
            }
            
            const policies = {
                'flexible': `${businessName} – Cancellation Policy:
You may cancel your booking up to 24 hours before your appointment for a full refund.
Cancellations made within 24 hours and no-shows will be charged 100% of the service price.
Refunds are returned to your original payment method within 5–10 business days.`,
                
                'moderate': `${businessName} – Cancellation Policy:
You may cancel your booking up to 48 hours before your appointment for a full refund.
Cancellations made within 48 hours will be charged 50% of the service price.
No-shows will be charged 100% of the service price.
Refunds are returned to your original payment method within 5–10 business days.`,
                
                'strict': `${businessName} – Cancellation Policy:
This booking is non-refundable once confirmed.
No-shows will be charged 100% of the service price.
Refunds are returned to your original payment method within 5–10 business days.`,
                
                'custom': 'Custom policy - edit the text above to define your terms'
            };
            
            if (policySelect.value === 'custom') {
                customPolicy.style.display = 'block';
                previewContent.textContent = policies[policySelect.value];
            } else if (policySelect.value === '') {
                customPolicy.style.display = 'none';
                previewContent.textContent = 'Select a cancellation policy to see preview...';
            } else {
                customPolicy.style.display = 'none';
                previewContent.textContent = policies[policySelect.value];
            }
            
            // Save to localStorage
            localStorage.setItem('cancellationPolicy', policySelect.value);
            if (policySelect.value === 'custom') {
                const customText = document.getElementById('customPolicyText').value;
                localStorage.setItem('customPolicyText', customText);
            }
        }
        
        function updateCustomPolicy() {
            const customText = document.getElementById('customPolicyText');
            const previewContent = document.getElementById('previewContent');
            
            previewContent.textContent = customText.value || 'Enter your custom policy above...';
            localStorage.setItem('customPolicyText', customText.value);
        }
        
        function manageSubscription() {
            alert('Redirecting to subscription management page...\n\nThis would normally take you to a payment portal where you can:\n- Update payment method\n- Change subscription plan\n- View billing history\n- Cancel subscription');
        }
        
        
        
        
        // Navigation functionality
        function showSection(sectionId) {
            console.log('showSection called with:', sectionId);
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all sidebar links
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('Section', sectionId, 'is now active');
                
                // Load section-specific data
                if (sectionId === 'dashboard') {
                    loadDashboardData();
                } else if (sectionId === 'waiting-list') {
                    loadWaitingList();
                } else if (sectionId === 'notification-log') {
                    initializeNotificationLog();
                }
            } else {
                console.error('Section not found:', sectionId);
            }
            
            // Add active class to clicked link
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Hide reviews badge when viewing reviews
            if (sectionId === 'reviews') {
                document.getElementById('reviewsBadge').style.display = 'none';
            }
        }
        
        // Enhanced Reviews functionality with Professional plan checks
        async function showReplyForm(reviewId) {
            // Check if business has Professional plan
            const canReply = await checkBusinessReplyCapability();
            if (!canReply) {
                showUpgradeModal();
                return;
            }
            
            const form = document.getElementById(`replyForm-${reviewId}`);
            if (form) {
            form.style.display = 'block';
            }
        }
        
        function cancelReply(reviewId) {
            const form = document.getElementById(`replyForm-${reviewId}`);
            if (form) {
            form.style.display = 'none';
            form.querySelector('textarea').value = '';
            }
        }
        
        async function submitReply(reviewId) {
            // Check if business has Professional plan
            const canReply = await checkBusinessReplyCapability();
            if (!canReply) {
                showUpgradeModal();
                return;
            }
            
            const form = document.getElementById(`replyForm-${reviewId}`);
            const textarea = form.querySelector('textarea');
            const replyText = textarea.value.trim();
            
            if (!replyText) {
                showNotification('Please enter a reply before submitting.', 'error');
                return;
            }
            
            // Validate reply length
            if (replyText.length < 10) {
                showNotification('Reply must be at least 10 characters long.', 'error');
                return;
            }
            
            if (replyText.length > 500) {
                showNotification('Reply must be 500 characters or less.', 'error');
                return;
            }
            
            try {
                // Show loading state
                const submitBtn = form.querySelector('.btn-reply');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;
                
                // Submit reply to backend
                const response = await submitBusinessReply(reviewId, replyText);
                
                if (response.success) {
            // Create reply element
            const reviewCard = form.closest('.review-card');
            const replyElement = document.createElement('div');
            replyElement.className = 'review-reply';
            replyElement.innerHTML = `
                <div class="review-reply-header">
                    <h5>Your Reply</h5>
                    <span class="review-reply-date">Posted on ${new Date().toLocaleDateString()}</span>
                </div>
                <div class="review-reply-text">${replyText}</div>
            `;
            
            // Replace form with reply
            form.parentNode.replaceChild(replyElement, form);
            
            // Update review card data
            reviewCard.setAttribute('data-reply', 'replied');
            reviewCard.classList.remove('new');
            
            // Update status badge
            updatePendingCount();
            
                    showNotification('Reply submitted successfully!', 'success');
                } else {
                    showNotification(response.message || 'Failed to submit reply. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error submitting reply:', error);
                showNotification('Failed to submit reply. Please try again.', 'error');
            } finally {
                // Reset button state
                const submitBtn = form.querySelector('.btn-reply');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Reply';
                    submitBtn.disabled = false;
                }
            }
        }
        
        // Check if business can reply (Professional plan only)
        async function checkBusinessReplyCapability() {
            try {
                // Get business plan from localStorage or API
                const businessPlan = localStorage.getItem('businessPlan') || 'Basic';
                return businessPlan === 'Professional';
            } catch (error) {
                console.error('Error checking business plan:', error);
                return false;
            }
        }
        
        // Show upgrade modal for non-Professional plans
        function showUpgradeModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Upgrade to Professional Plan</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Reply to customer reviews is a Professional plan feature.</p>
                        <p>Upgrade now to engage with your customers and build better relationships!</p>
                        <div class="upgrade-benefits">
                            <h4>Professional Plan Benefits:</h4>
                            <ul>
                                <li>✓ Reply to customer reviews</li>
                                <li>✓ Advanced analytics</li>
                                <li>✓ Priority support</li>
                                <li>✓ Custom branding</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-upgrade" onclick="upgradeToProfessional()">Upgrade Now</button>
                        <button class="btn-cancel" onclick="closeModal()">Maybe Later</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        function upgradeToProfessional() {
            // Redirect to upgrade page or handle upgrade
            window.location.href = '/upgrade?plan=professional';
        }
        
        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // Submit business reply to backend
        async function submitBusinessReply(reviewId, replyText) {
            try {
                const response = await fetch('/api/reviews/reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('businessToken')}`
                    },
                    body: JSON.stringify({
                        reviewId: reviewId,
                        replyText: replyText
                    })
                });
                
                return await response.json();
            } catch (error) {
                console.error('Error submitting reply:', error);
                return { success: false, message: 'Network error' };
            }
        }
        
        function filterReviews() {
            const ratingFilter = document.getElementById('ratingFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const replyFilter = document.getElementById('replyFilter').value;
            
            const reviews = document.querySelectorAll('.review-card');
            
            reviews.forEach(review => {
                let show = true;
                
                // Rating filter
                if (ratingFilter !== 'all' && review.getAttribute('data-rating') !== ratingFilter) {
                    show = false;
                }
                
                // Reply status filter
                if (replyFilter !== 'all' && review.getAttribute('data-reply') !== replyFilter) {
                    show = false;
                }
                
                // Date filter (simplified)
                if (dateFilter !== 'all') {
                    const reviewDate = new Date(review.getAttribute('data-date'));
                    const now = new Date();
                    const daysDiff = (now - reviewDate) / (1000 * 60 * 60 * 24);
                    
                    if (dateFilter === 'week' && daysDiff > 7) show = false;
                    if (dateFilter === 'month' && daysDiff > 30) show = false;
                    if (dateFilter === 'quarter' && daysDiff > 90) show = false;
                }
                
                review.style.display = show ? 'block' : 'none';
            });
        }
        
        function updatePendingCount() {
            const pendingReviews = document.querySelectorAll('.review-card[data-reply="pending"]');
            const pendingCount = pendingReviews.length;
            
            const badge = document.getElementById('reviewsBadge');
            if (pendingCount > 0) {
                badge.textContent = `${pendingCount} new`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Initialize reviews badge
        document.addEventListener('DOMContentLoaded', function() {
            updatePendingCount();
            loadBookingOptions();
        });
        
        function loadBookingOptions() {
            const payAtVenueEnabled = localStorage.getItem('royalHairStudioPayAtVenue');
            const toggle = document.getElementById('payAtVenueToggle');
            const disclaimer = document.getElementById('payAtVenueDisclaimer');
            
            if (payAtVenueEnabled === 'true') {
                toggle.checked = true;
                disclaimer.style.display = 'flex';
            } else {
                toggle.checked = false;
                disclaimer.style.display = 'none';
            }
        }
        
        // Loyalty Rewards Modal Functions
        function openLoyaltyModal() {
            console.log('Opening loyalty modal');
            const modal = document.getElementById('loyaltyModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Load existing loyalty program if available
                loadExistingLoyaltyProgram();
            } else {
                console.error('Loyalty modal not found');
                alert('Loyalty modal not found. Please refresh the page.');
            }
        }
        
        function closeLoyaltyModal() {
            console.log('Closing loyalty modal');
            const modal = document.getElementById('loyaltyModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }
        
        function loadExistingLoyaltyProgram() {
            const savedProgram = localStorage.getItem('loyaltyProgram');
            if (savedProgram) {
                try {
                    const program = JSON.parse(savedProgram);
                    document.getElementById('modalLoyaltyType').value = program.type || '';
                    document.getElementById('modalLoyaltyThreshold').value = program.threshold || '';
                    document.getElementById('modalLoyaltyTimeLimit').value = program.timeLimit || '';
                    document.getElementById('modalRewardType').value = program.rewardType || '';
                    document.getElementById('modalLoyaltyRewardValue').value = program.rewardValue || '';
                    document.getElementById('modalLoyaltyEnabled').checked = program.isActive || false;
                    
                    // Update form visibility
                    updateModalLoyaltyType();
                    updateModalRewardType();
                    updateModalLoyaltyPreview();
                } catch (e) {
                    console.error('Error loading loyalty program:', e);
                }
            }
        }
        
        function updateModalLoyaltyType() {
            const loyaltyType = document.getElementById('modalLoyaltyType').value;
            const thresholdSetting = document.getElementById('modalThresholdSetting');
            const timeLimitSetting = document.getElementById('modalTimeLimitSetting');
            const rewardTypeSetting = document.getElementById('modalRewardTypeSetting');
            const thresholdDescription = document.getElementById('modalThresholdDescription');
            
            // Show threshold setting for all types
            thresholdSetting.style.display = 'block';
            
            // Show time limit only for time-limited
            if (loyaltyType === 'timeLimited') {
                timeLimitSetting.style.display = 'block';
                thresholdDescription.textContent = 'Set the number of visits to complete';
            } else {
                timeLimitSetting.style.display = 'none';
                if (loyaltyType === 'visitBased') {
                    thresholdDescription.textContent = 'Set the number of visits required';
                } else if (loyaltyType === 'spendBased') {
                    thresholdDescription.textContent = 'Set the amount to spend (£)';
                }
            }
            
            // Show reward type setting
            rewardTypeSetting.style.display = 'block';
            
            updateModalLoyaltyPreview();
        }
        
        function updateLoyaltyType() {
            const loyaltyType = document.getElementById('loyaltyType').value;
            const thresholdSetting = document.getElementById('thresholdSetting');
            const timeLimitSetting = document.getElementById('timeLimitSetting');
            const rewardTypeSetting = document.getElementById('rewardTypeSetting');
            const thresholdDescription = document.getElementById('thresholdDescription');
            
            // Show threshold setting for all types
            thresholdSetting.style.display = 'block';
            
            // Show time limit only for time-limited
            if (loyaltyType === 'timeLimited') {
                timeLimitSetting.style.display = 'block';
                thresholdDescription.textContent = 'Set the number of visits to complete';
            } else {
                timeLimitSetting.style.display = 'none';
                if (loyaltyType === 'visitBased') {
                    thresholdDescription.textContent = 'Set the number of visits required';
                } else if (loyaltyType === 'spendBased') {
                    thresholdDescription.textContent = 'Set the amount to spend (£)';
                }
            }
            
            // Show reward type setting
            rewardTypeSetting.style.display = 'block';
            
            updateLoyaltyPreview();
        }
        
        function updateModalRewardType() {
            const rewardType = document.getElementById('modalRewardType').value;
            const rewardValueSetting = document.getElementById('modalRewardValueSetting');
            const rewardValueDescription = document.getElementById('modalRewardValueDescription');
            
            if (rewardType) {
                rewardValueSetting.style.display = 'block';
                
                if (rewardType === 'freeService') {
                    rewardValueDescription.textContent = 'No value needed for free service';
                    document.getElementById('modalLoyaltyRewardValue').style.display = 'none';
                } else if (rewardType === 'fixedDiscount') {
                    rewardValueDescription.textContent = 'Set the discount amount (£)';
                    document.getElementById('modalLoyaltyRewardValue').style.display = 'block';
                    document.getElementById('modalLoyaltyRewardValue').placeholder = 'Enter discount amount';
                } else if (rewardType === 'percentageDiscount') {
                    rewardValueDescription.textContent = 'Set the discount percentage (%)';
                    document.getElementById('modalLoyaltyRewardValue').style.display = 'block';
                    document.getElementById('modalLoyaltyRewardValue').placeholder = 'Enter percentage';
                }
            } else {
                rewardValueSetting.style.display = 'none';
            }
            
            updateModalLoyaltyPreview();
        }
        
        function updateRewardType() {
            const rewardType = document.getElementById('rewardType').value;
            const rewardValueSetting = document.getElementById('rewardValueSetting');
            const rewardValueDescription = document.getElementById('rewardValueDescription');
            
            if (rewardType) {
                rewardValueSetting.style.display = 'block';
                
                if (rewardType === 'freeService') {
                    rewardValueDescription.textContent = 'No value needed for free service';
                    document.getElementById('loyaltyRewardValue').style.display = 'none';
                } else if (rewardType === 'fixedDiscount') {
                    rewardValueDescription.textContent = 'Set the discount amount (£)';
                    document.getElementById('loyaltyRewardValue').style.display = 'block';
                    document.getElementById('loyaltyRewardValue').placeholder = 'Enter discount amount';
                } else if (rewardType === 'percentageDiscount') {
                    rewardValueDescription.textContent = 'Set the discount percentage (%)';
                    document.getElementById('loyaltyRewardValue').style.display = 'block';
                    document.getElementById('loyaltyRewardValue').placeholder = 'Enter percentage';
                }
            } else {
                rewardValueSetting.style.display = 'none';
            }
            
            updateLoyaltyPreview();
        }
        
        function updateModalLoyaltyPreview() {
            const loyaltyType = document.getElementById('modalLoyaltyType').value;
            const threshold = document.getElementById('modalLoyaltyThreshold').value;
            const timeLimit = document.getElementById('modalLoyaltyTimeLimit').value;
            const rewardType = document.getElementById('modalRewardType').value;
            const rewardValue = document.getElementById('modalLoyaltyRewardValue').value;
            const loyaltyEnabled = document.getElementById('modalLoyaltyEnabled').checked;
            
            if (!loyaltyType || !threshold || !rewardType) {
                document.getElementById('modalLoyaltyPreview').style.display = 'none';
                return;
            }
            
            // Show preview
            document.getElementById('modalLoyaltyPreview').style.display = 'block';
            
            // Generate preview content
            let previewText = '';
            let progressText = '';
            
            if (loyaltyType === 'visitBased') {
                previewText = `Book ${threshold} visits, get reward`;
                progressText = `0 of ${threshold} visits complete`;
            } else if (loyaltyType === 'spendBased') {
                previewText = `Spend £${threshold}, get reward`;
                progressText = `£0 of £${threshold} spent`;
            } else if (loyaltyType === 'timeLimited') {
                previewText = `Book ${threshold} visits within ${timeLimit} weeks, get reward`;
                progressText = `0 of ${threshold} visits complete (${timeLimit} weeks remaining)`;
            }
            
            let rewardText = '';
            if (rewardType === 'freeService') {
                rewardText = '1 Free Service';
            } else if (rewardType === 'fixedDiscount') {
                rewardText = `£${rewardValue} off next booking`;
            } else if (rewardType === 'percentageDiscount') {
                rewardText = `${rewardValue}% off next booking`;
            }
            
            const statusText = loyaltyEnabled ? 'Active' : 'Inactive';
            const statusColor = loyaltyEnabled ? '#28a745' : '#dc3545';
            
            const previewContent = `
                <div class="loyalty-progress">
                    <div style="color: #ffffff; font-weight: 600; margin-bottom: 0.5rem;">${previewText}</div>
                    <div style="color: #cccccc; font-size: 0.9rem; margin-bottom: 0.5rem;">${progressText}</div>
                    <div class="loyalty-progress-bar">
                        <div class="loyalty-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="loyalty-reward">
                    <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem;">🎁 Reward</div>
                    <div style="color: #ffffff;">${rewardText}</div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 60, 172, 0.1); border-radius: 6px; border: 1px solid rgba(255, 60, 172, 0.3);">
                    <div style="color: #FF3CAC; font-weight: 600; margin-bottom: 0.5rem;">📱 Customer Preview</div>
                    <div style="color: #cccccc; font-size: 0.9rem; line-height: 1.4;">
                        Status: <strong style="color: ${statusColor};">${statusText}</strong><br>
                        Your customers will see: <strong>${progressText}</strong><br>
                        Reward: <strong>${rewardText}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('modalLoyaltyPreviewContent').innerHTML = previewContent;
        }
        
        function updateLoyaltyPreview() {
            const loyaltyType = document.getElementById('loyaltyType').value;
            const threshold = document.getElementById('loyaltyThreshold').value;
            const timeLimit = document.getElementById('loyaltyTimeLimit').value;
            const rewardType = document.getElementById('rewardType').value;
            const rewardValue = document.getElementById('loyaltyRewardValue').value;
            
            if (!loyaltyType || !threshold || !rewardType) {
                document.getElementById('loyaltyPreview').style.display = 'none';
                return;
            }
            
            // Show preview
            document.getElementById('loyaltyPreview').style.display = 'block';
            
            // Generate preview content
            let previewText = '';
            let progressText = '';
            
            if (loyaltyType === 'visitBased') {
                previewText = `Book ${threshold} visits, get reward`;
                progressText = `0 of ${threshold} visits complete`;
            } else if (loyaltyType === 'spendBased') {
                previewText = `Spend £${threshold}, get reward`;
                progressText = `£0 of £${threshold} spent`;
            } else if (loyaltyType === 'timeLimited') {
                previewText = `Book ${threshold} visits within ${timeLimit} weeks, get reward`;
                progressText = `0 of ${threshold} visits complete (${timeLimit} weeks remaining)`;
            }
            
            let rewardText = '';
            if (rewardType === 'freeService') {
                rewardText = '1 Free Service';
            } else if (rewardType === 'fixedDiscount') {
                rewardText = `£${rewardValue} off next booking`;
            } else if (rewardType === 'percentageDiscount') {
                rewardText = `${rewardValue}% off next booking`;
            }
            
            const previewContent = `
                <div class="loyalty-progress">
                    <div style="color: #ffffff; font-weight: 600; margin-bottom: 0.5rem;">${previewText}</div>
                    <div style="color: #cccccc; font-size: 0.9rem; margin-bottom: 0.5rem;">${progressText}</div>
                    <div class="loyalty-progress-bar">
                        <div class="loyalty-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="loyalty-reward">
                    <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem;">🎁 Reward</div>
                    <div style="color: #ffffff;">${rewardText}</div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 60, 172, 0.1); border-radius: 6px; border: 1px solid rgba(255, 60, 172, 0.3);">
                    <div style="color: #FF3CAC; font-weight: 600; margin-bottom: 0.5rem;">📱 Customer Preview</div>
                    <div style="color: #cccccc; font-size: 0.9rem; line-height: 1.4;">
                        Your customers will see: <strong>${progressText}</strong><br>
                        Reward: <strong>${rewardText}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('loyaltyPreviewContent').innerHTML = previewContent;
            document.getElementById('saveLoyaltyBtn').style.display = 'block';
        }
        
        function toggleLoyaltyProgram() {
            const loyaltyEnabled = document.getElementById('loyaltyEnabled').checked;
            const loyaltySection = document.getElementById('loyaltySection');
            
            if (loyaltyEnabled) {
                loyaltySection.style.display = 'block';
            } else {
                loyaltySection.style.display = 'none';
                // Reset form when disabled
                document.getElementById('loyaltyType').value = '';
                document.getElementById('loyaltyThreshold').value = '';
                document.getElementById('loyaltyTimeLimit').value = '';
                document.getElementById('rewardType').value = '';
                document.getElementById('loyaltyRewardValue').value = '';
                document.getElementById('loyaltyPreview').style.display = 'none';
                document.getElementById('saveLoyaltyBtn').style.display = 'none';
            }
        }
        
        function saveModalLoyaltyProgram() {
            const loyaltyType = document.getElementById('modalLoyaltyType').value;
            const threshold = document.getElementById('modalLoyaltyThreshold').value;
            const timeLimit = document.getElementById('modalLoyaltyTimeLimit').value;
            const rewardType = document.getElementById('modalRewardType').value;
            const rewardValue = document.getElementById('modalLoyaltyRewardValue').value;
            const loyaltyEnabled = document.getElementById('modalLoyaltyEnabled').checked;
            
            // Validate inputs
            if (!loyaltyType || !threshold || !rewardType) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (loyaltyType === 'timeLimited' && !timeLimit) {
                alert('Please enter time limit for time-limited program');
                return;
            }
            
            if (rewardType !== 'freeService' && !rewardValue) {
                alert('Please enter reward value');
                return;
            }
            
            // Save to localStorage (in real implementation, save to database)
            const loyaltyProgram = {
                type: loyaltyType,
                threshold: parseInt(threshold),
                timeLimit: timeLimit ? parseInt(timeLimit) : null,
                rewardType: rewardType,
                rewardValue: rewardType === 'freeService' ? null : parseFloat(rewardValue),
                isActive: loyaltyEnabled,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('loyaltyProgram', JSON.stringify(loyaltyProgram));
            
            // Close modal
            closeLoyaltyModal();
            
            alert('Loyalty program saved successfully!\n\nYour customers will now see this loyalty program on your business profile and in their dashboard.');
        }
        
        function saveLoyaltyProgram() {
            const loyaltyType = document.getElementById('loyaltyType').value;
            const threshold = document.getElementById('loyaltyThreshold').value;
            const timeLimit = document.getElementById('loyaltyTimeLimit').value;
            const rewardType = document.getElementById('rewardType').value;
            const rewardValue = document.getElementById('loyaltyRewardValue').value;
            const loyaltyEnabled = document.getElementById('loyaltyEnabled').checked;
            
            // Validate inputs
            if (!loyaltyEnabled) {
                alert('Please enable the loyalty programme first');
                return;
            }
            
            if (!loyaltyType || !threshold || !rewardType) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (loyaltyType === 'timeLimited' && !timeLimit) {
                alert('Please enter time limit for time-limited program');
                return;
            }
            
            if (rewardType !== 'freeService' && !rewardValue) {
                alert('Please enter reward value');
                return;
            }
            
            // Save to localStorage (in real implementation, save to database)
            const loyaltyProgram = {
                type: loyaltyType,
                threshold: parseInt(threshold),
                timeLimit: timeLimit ? parseInt(timeLimit) : null,
                rewardType: rewardType,
                rewardValue: rewardValue ? parseFloat(rewardValue) : null,
                isActive: loyaltyEnabled,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('loyaltyProgram', JSON.stringify(loyaltyProgram));
            
            alert('Loyalty program saved successfully!\n\nYour customers will now see this loyalty program on your business profile and in their dashboard.');
        }
        
        // Tab Version Functions
        function updateTabLoyaltyType() {
            const loyaltyType = document.getElementById('tabLoyaltyType').value;
            const thresholdSetting = document.getElementById('tabThresholdSetting');
            const timeLimitSetting = document.getElementById('tabTimeLimitSetting');
            const rewardTypeSetting = document.getElementById('tabRewardTypeSetting');
            const expiryDaysSetting = document.getElementById('tabExpiryDaysSetting');
            const termsSetting = document.getElementById('tabTermsSetting');
            const thresholdDescription = document.getElementById('tabThresholdDescription');
            
            // Show threshold setting for all types
            thresholdSetting.style.display = 'block';
            
            // Show time limit only for time-limited
            if (loyaltyType === 'timeLimited') {
                timeLimitSetting.style.display = 'block';
                thresholdDescription.textContent = 'Set the number of visits to complete';
            } else {
                timeLimitSetting.style.display = 'none';
                if (loyaltyType === 'visitBased') {
                    thresholdDescription.textContent = 'Set the number of visits required';
                } else if (loyaltyType === 'spendBased') {
                    thresholdDescription.textContent = 'Set the amount to spend (£)';
                }
            }
            
            // Show reward type setting and additional fields
            rewardTypeSetting.style.display = 'block';
            expiryDaysSetting.style.display = 'block';
            termsSetting.style.display = 'block';
            
            updateTabLoyaltyPreview();
        }
        
        function updateTabRewardType() {
            const rewardType = document.getElementById('tabRewardType').value;
            const rewardValueSetting = document.getElementById('tabRewardValueSetting');
            const rewardValueDescription = document.getElementById('tabRewardValueDescription');
            
            if (rewardType) {
                rewardValueSetting.style.display = 'block';
                
                if (rewardType === 'freeService') {
                    rewardValueDescription.textContent = 'No value needed for free service';
                    document.getElementById('tabLoyaltyRewardValue').style.display = 'none';
                } else if (rewardType === 'fixedDiscount') {
                    rewardValueDescription.textContent = 'Set the discount amount (£)';
                    document.getElementById('tabLoyaltyRewardValue').style.display = 'block';
                    document.getElementById('tabLoyaltyRewardValue').placeholder = 'Enter discount amount';
                } else if (rewardType === 'percentageDiscount') {
                    rewardValueDescription.textContent = 'Set the discount percentage (%)';
                    document.getElementById('tabLoyaltyRewardValue').style.display = 'block';
                    document.getElementById('tabLoyaltyRewardValue').placeholder = 'Enter percentage';
                }
            } else {
                rewardValueSetting.style.display = 'none';
            }
            
            updateTabLoyaltyPreview();
        }
        
        function updateTabLoyaltyPreview() {
            const loyaltyType = document.getElementById('tabLoyaltyType').value;
            const threshold = document.getElementById('tabLoyaltyThreshold').value;
            const timeLimit = document.getElementById('tabLoyaltyTimeLimit').value;
            const rewardType = document.getElementById('tabRewardType').value;
            const rewardValue = document.getElementById('tabLoyaltyRewardValue').value;
            const loyaltyEnabled = document.getElementById('tabLoyaltyEnabled').checked;
            
            if (!loyaltyType || !threshold || !rewardType) {
                document.getElementById('tabLoyaltyPreview').style.display = 'none';
                return;
            }
            
            // Show preview
            document.getElementById('tabLoyaltyPreview').style.display = 'block';
            
            // Generate preview content
            let previewText = '';
            let progressText = '';
            
            if (loyaltyType === 'visitBased') {
                previewText = `Book ${threshold} visits, get reward`;
                progressText = `3 of ${threshold} visits complete`;
            } else if (loyaltyType === 'spendBased') {
                previewText = `Spend £${threshold}, get reward`;
                progressText = `£75 of £${threshold} spent`;
            } else if (loyaltyType === 'timeLimited') {
                previewText = `Book ${threshold} visits within ${timeLimit} weeks, get reward`;
                progressText = `2 of ${threshold} visits complete (4 weeks remaining)`;
            }
            
            let rewardText = '';
            if (rewardType === 'freeService') {
                rewardText = 'Free haircut';
            } else if (rewardType === 'fixedDiscount') {
                rewardText = `£${rewardValue} off next booking`;
            } else if (rewardType === 'percentageDiscount') {
                rewardText = `${rewardValue}% off next booking`;
            }
            
            const statusText = loyaltyEnabled ? 'Active' : 'Inactive';
            const statusColor = loyaltyEnabled ? '#28a745' : '#dc3545';
            
            const previewContent = `
                <div class="loyalty-progress">
                    <div style="color: #ffffff; font-weight: 600; margin-bottom: 0.5rem;">${previewText}</div>
                    <div style="color: #cccccc; font-size: 0.9rem; margin-bottom: 0.5rem;">${progressText}</div>
                    <div class="loyalty-progress-bar">
                        <div class="loyalty-progress-fill" style="width: ${loyaltyType === 'visitBased' ? '60%' : loyaltyType === 'spendBased' ? '75%' : '67%'};"></div>
                    </div>
                </div>
                <div class="loyalty-reward">
                    <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem;">🎁 Reward</div>
                    <div style="color: #ffffff;">${rewardText}</div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255, 60, 172, 0.1); border-radius: 6px; border: 1px solid rgba(255, 60, 172, 0.3);">
                    <div style="color: #FF3CAC; font-weight: 600; margin-bottom: 0.5rem;">📱 Customer Preview</div>
                    <div style="color: #cccccc; font-size: 0.9rem; line-height: 1.4;">
                        Status: <strong style="color: ${statusColor};">${statusText}</strong><br>
                        Your customers will see: <strong>${progressText}</strong><br>
                        Reward: <strong>${rewardText}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('tabLoyaltyPreviewContent').innerHTML = previewContent;
            document.getElementById('tabSaveLoyaltyBtn').style.display = 'block';
        }
        
        function saveTabLoyaltyProgram() {
            const loyaltyType = document.getElementById('tabLoyaltyType').value;
            const threshold = document.getElementById('tabLoyaltyThreshold').value;
            const timeLimit = document.getElementById('tabLoyaltyTimeLimit').value;
            const rewardType = document.getElementById('tabRewardType').value;
            const rewardValue = document.getElementById('tabLoyaltyRewardValue').value;
            const expiryDays = document.getElementById('tabLoyaltyExpiryDays').value;
            const terms = document.getElementById('tabLoyaltyTerms').value;
            const loyaltyEnabled = document.getElementById('tabLoyaltyEnabled').checked;
            
            // Validate inputs
            if (!loyaltyType || !threshold || !rewardType) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (loyaltyType === 'timeLimited' && !timeLimit) {
                alert('Please enter time limit for time-limited program');
                return;
            }
            
            if (rewardType !== 'freeService' && !rewardValue) {
                alert('Please enter reward value');
                return;
            }
            
            // Enhanced validation for new fields
            if (loyaltyEnabled && (!expiryDays || expiryDays < 1 || expiryDays > 365)) {
                alert('Please enter a valid expiry days (1-365).');
                return;
            }
            
            // Save to localStorage (in real implementation, save to database)
            const loyaltyProgram = {
                type: loyaltyType,
                threshold: parseInt(threshold),
                timeLimit: timeLimit ? parseInt(timeLimit) : null,
                rewardType: rewardType,
                rewardValue: rewardType === 'freeService' ? null : parseFloat(rewardValue),
                expiryDays: expiryDays ? parseInt(expiryDays) : 90, // Default 90 days
                terms: terms || 'Valid for the specified period from earning',
                isActive: loyaltyEnabled,
                businessId: getCurrentBusinessId(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('loyaltyProgram', JSON.stringify(loyaltyProgram));
            
            // Save to LoyaltyProgrammes database table
            saveLoyaltyProgrammeToDatabase(loyaltyProgram);
            
            alert('Loyalty program saved successfully!\n\nYour customers will now see this loyalty program on your business profile and in their dashboard.');
        }
        
        // Load loyalty analytics data
        function loadLoyaltyAnalytics() {
            try {
                // Load customer progress data
                loadCustomerProgressData();
                
                // Load issued rewards data
                loadIssuedRewardsData();
                
            } catch (error) {
                console.error('Error loading loyalty analytics:', error);
            }
        }

        // Load customer progress data (anonymized)
        function loadCustomerProgressData() {
            try {
                const loyaltyProgress = JSON.parse(localStorage.getItem('loyaltyProgress') || '[]');
                const currentBusinessId = 'business_001'; // In a real app, get from session
                
                // Filter progress for current business
                const businessProgress = loyaltyProgress.filter(progress => 
                    progress.business_id === currentBusinessId
                );
                
                const progressList = document.getElementById('customerProgressList');
                if (!progressList) return;
                
                if (businessProgress.length === 0) {
                    progressList.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; text-align: center; padding: 1rem;">No customer progress data yet</p>';
                    return;
                }
                
                // Generate anonymized customer progress items
                const progressItems = businessProgress.map(progress => {
                    const customerInitials = getCustomerInitials(progress.customer_id);
                    const progressPercentage = Math.round((progress.total_visits / 5) * 100); // Assuming 5 visits threshold
                    
                    return `
                        <div class="customer-progress-item">
                            <div class="customer-info">
                                <div class="customer-initials">${customerInitials}</div>
                                <div class="customer-details">
                                    <div class="customer-name">Customer ${customerInitials}</div>
                                    <div class="customer-progress">${progress.total_visits} visits completed</div>
                                </div>
                            </div>
                            <div class="progress-indicator">
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: ${progressPercentage}%"></div>
                                </div>
                                <span class="progress-percentage">${progressPercentage}%</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                progressList.innerHTML = progressItems;
                
            } catch (error) {
                console.error('Error loading customer progress data:', error);
            }
        }

        // Load issued rewards data
        function loadIssuedRewardsData() {
            try {
                const rewardVouchers = JSON.parse(localStorage.getItem('rewardVouchers') || '[]');
                const currentBusinessId = 'business_001'; // In a real app, get from session
                
                // Filter vouchers for current business
                const businessVouchers = rewardVouchers.filter(voucher => 
                    voucher.business_id === currentBusinessId
                );
                
                const rewardsList = document.getElementById('issuedRewardsList');
                if (!rewardsList) return;
                
                if (businessVouchers.length === 0) {
                    rewardsList.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; text-align: center; padding: 1rem;">No rewards issued yet</p>';
                    return;
                }
                
                // Generate issued rewards items
                const rewardItems = businessVouchers.map(voucher => {
                    const status = voucher.expired ? 'expired' : (voucher.used ? 'redeemed' : 'issued');
                    const statusText = voucher.expired ? 'Expired' : (voucher.used ? 'Redeemed' : 'Issued');
                    const issueDate = new Date(voucher.created_at).toLocaleDateString();
                    
                    return `
                        <div class="issued-reward-item">
                            <div class="reward-info">
                                <div class="reward-code">${voucher.id.substring(0, 8).toUpperCase()}</div>
                                <div class="reward-details">
                                    <div class="reward-type">${voucher.reward_type}</div>
                                    <div class="reward-date">Issued: ${issueDate}</div>
                                </div>
                            </div>
                            <div class="reward-status">
                                <div class="status-dot ${status}"></div>
                                <span class="status-text">${statusText}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                rewardsList.innerHTML = rewardItems;
                
            } catch (error) {
                console.error('Error loading issued rewards data:', error);
            }
        }

        // Get customer initials for anonymization
        function getCustomerInitials(customerId) {
            const customerNames = {
                'customer_1': 'JS',
                'customer_2': 'JD',
                'customer_3': 'SW'
            };
            return customerNames[customerId] || 'CU';
        }

        // Simulate saving to LoyaltyProgrammes database table
        function saveLoyaltyProgrammeToDatabase(loyaltyData) {
            try {
                // Simulate database save
                const loyaltyProgramme = {
                    id: generateUUID(),
                    business_id: loyaltyData.businessId,
                    type: loyaltyData.type === 'visitBased' ? 'Visits' : 
                          loyaltyData.type === 'spendBased' ? 'Spend' : 'Time',
                    threshold: loyaltyData.threshold,
                    reward_type: loyaltyData.rewardType === 'freeService' ? 'Free Service' :
                                loyaltyData.rewardType === 'fixedDiscount' ? 'Discount' : 'Credit',
                    reward_value: loyaltyData.rewardValue ? loyaltyData.rewardValue.toString() : '1',
                    expiry_days: loyaltyData.expiryDays,
                    terms: loyaltyData.terms,
                    active: loyaltyData.isActive,
                    created_at: loyaltyData.createdAt,
                    updated_at: loyaltyData.updatedAt
                };
                
                // Store in localStorage for demo (in real app, this would be a database call)
                const existingProgrammes = JSON.parse(localStorage.getItem('loyaltyProgrammes') || '[]');
                const updatedProgrammes = existingProgrammes.filter(p => p.business_id !== loyaltyData.businessId);
                updatedProgrammes.push(loyaltyProgramme);
                localStorage.setItem('loyaltyProgrammes', JSON.stringify(updatedProgrammes));
                
                console.log('Loyalty programme saved to database:', loyaltyProgramme);
            } catch (error) {
                console.error('Failed to save loyalty programme to database:', error);
            }
        }
        
        // Generate UUID for database records
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Get current business ID
        function getCurrentBusinessId() {
            // In a real app, this would come from authentication
            return localStorage.getItem('currentBusinessId') || 'business_001';
        }
        
        // Load and display business bookings from localStorage
        function loadBusinessBookings() {
            const businessId = 'royal-hair-studio';
            const businessBookings = JSON.parse(localStorage.getItem(`businessBookings_${businessId}`) || '[]');
            
            // Update the bookings display in the dashboard
            updateBookingsDisplay(businessBookings);
        }
        
        // Update bookings display in the dashboard
        function updateBookingsDisplay(bookings) {
            // Find the bookings section in the dashboard
            const bookingsSection = document.querySelector('.bookings-section');
            if (!bookingsSection) return;
            
            // Create bookings HTML
            let bookingsHTML = '';
            
            if (bookings.length === 0) {
                bookingsHTML = `
                    <div class="no-bookings">
                        <div class="no-bookings-icon">📅</div>
                        <h3>No bookings yet</h3>
                        <p>Bookings will appear here when customers make appointments.</p>
                    </div>
                `;
            } else {
                bookingsHTML = bookings.map(booking => `
                    <div class="booking-item">
                        <div class="booking-header">
                            <div class="customer-info">
                                <h4>${booking.customerName}</h4>
                                <p>${booking.customerEmail}</p>
                            </div>
                            <div class="booking-status status-${booking.status.toLowerCase()}">
                                ${booking.status}
                            </div>
                        </div>
                        <div class="booking-details">
                            <div class="detail-row">
                                <span class="label">Date:</span>
                                <span class="value">${booking.date}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Time:</span>
                                <span class="value">${booking.time}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Services:</span>
                                <span class="value">${booking.services.map(s => s.name).join(', ')}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Total:</span>
                                <span class="value">£${booking.totalAmount}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Booking ID:</span>
                                <span class="value">${booking.bookingId}</span>
                            </div>
                            ${generateRefundInfo(booking)}
                            ${generateNotificationStatus(booking)}
                        </div>
                    </div>
                `).join('');
            }
            
            // Update the bookings section
            const bookingsList = bookingsSection.querySelector('.bookings-list');
            if (bookingsList) {
                bookingsList.innerHTML = bookingsHTML;
            }
        }
        
        // Listen for booking status updates (real-time sync)
        window.addEventListener('storage', function(e) {
            if (e.key && e.key.startsWith('bookingCancelled_')) {
                const bookingId = e.key.replace('bookingCancelled_', '');
                updateBusinessBookingStatus(bookingId, 'Cancelled');
                loadBusinessBookings(); // Refresh display
            }
        });
        
        // Generate refund information for business dashboard
        function generateRefundInfo(booking) {
            if (booking.status === 'Refunded' && booking.refundAmount !== undefined) {
                const refundDate = booking.refundTimestamp ? 
                    new Date(booking.refundTimestamp).toLocaleDateString() : 
                    new Date().toLocaleDateString();
                
                return `
                    <div class="detail-row refund-info">
                        <span class="label">Refund Amount:</span>
                        <span class="value refund-amount">£${booking.refundAmount.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Refund Date:</span>
                        <span class="value">${refundDate}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Refund Status:</span>
                        <span class="value">${booking.refundStatus || 'Processed'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Net Amount:</span>
                        <span class="value">£${booking.netAmount ? booking.netAmount.toFixed(2) : (booking.totalAmount - booking.refundAmount).toFixed(2)}</span>
                    </div>
                `;
            } else if (booking.status === 'Cancelled' && booking.refundStatus === 'Non-refundable') {
                return `
                    <div class="detail-row">
                        <span class="label">Refund Status:</span>
                        <span class="value">Non-refundable under policy</span>
                    </div>
                `;
            }
            return '';
        }

        // Generate notification status for business dashboard
        function generateNotificationStatus(booking) {
            // Get notification status for this booking
            const notificationStatus = getBookingNotificationStatus(booking.id);
            
            return `
                <div class="notification-status">
                    <div class="notification-header">
                        <i class="fas fa-bell"></i>
                        <span>Communication Status</span>
                    </div>
                    <div class="notification-details">
                        <div class="notification-item">
                            <span class="notification-label">Confirmation Email:</span>
                            <span class="notification-status-badge ${notificationStatus.confirmation_email ? 'sent' : 'failed'}">
                                <i class="fas fa-${notificationStatus.confirmation_email ? 'check' : 'times'}"></i>
                                ${notificationStatus.confirmation_email ? 'Sent' : 'Failed'}
                            </span>
                        </div>
                        ${notificationStatus.confirmation_sms !== undefined ? `
                            <div class="notification-item">
                                <span class="notification-label">Confirmation SMS:</span>
                                <span class="notification-status-badge ${notificationStatus.confirmation_sms ? 'sent' : 'failed'}">
                                    <i class="fas fa-${notificationStatus.confirmation_sms ? 'check' : 'times'}"></i>
                                    ${notificationStatus.confirmation_sms ? 'Sent' : 'Failed'}
                                </span>
                            </div>
                        ` : ''}
                        <div class="notification-item">
                            <span class="notification-label">Reminder Email:</span>
                            <span class="notification-status-badge ${notificationStatus.reminder_email ? 'sent' : 'pending'}">
                                <i class="fas fa-${notificationStatus.reminder_email ? 'check' : 'clock'}"></i>
                                ${notificationStatus.reminder_email ? 'Sent' : 'Pending'}
                            </span>
                        </div>
                        ${notificationStatus.reminder_sms !== undefined ? `
                            <div class="notification-item">
                                <span class="notification-label">Reminder SMS:</span>
                                <span class="notification-status-badge ${notificationStatus.reminder_sms ? 'sent' : 'pending'}">
                                    <i class="fas fa-${notificationStatus.reminder_sms ? 'check' : 'clock'}"></i>
                                    ${notificationStatus.reminder_sms ? 'Sent' : 'Pending'}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="privacy-notice">
                        <i class="fas fa-shield-alt"></i>
                        <span>Only delivery status is shown. Message contents and customer details are protected.</span>
                    </div>
                </div>
            `;
        }

        // Get notification status for a booking
        function getBookingNotificationStatus(bookingId) {
            try {
                const notificationLogs = JSON.parse(localStorage.getItem('notification_logs') || '{}');
                const bookingLogs = {};
                
                // Find all logs for this booking
                Object.keys(notificationLogs).forEach(key => {
                    if (key.startsWith(`${bookingId}_`)) {
                        const log = notificationLogs[key];
                        const statusKey = `${log.notificationType}_${log.method}`;
                        bookingLogs[statusKey] = log.sent;
                    }
                });
                
                return {
                    confirmation_email: bookingLogs.confirmation_email || false,
                    confirmation_sms: bookingLogs.confirmation_sms || false,
                    reminder_email: bookingLogs.reminder_email || false,
                    reminder_sms: bookingLogs.reminder_sms || false
                };
            } catch (error) {
                console.error('Failed to get notification status:', error);
                return {
                    confirmation_email: false,
                    confirmation_sms: false,
                    reminder_email: false,
                    reminder_sms: false
                };
            }
        }
        
        // Update booking status in business dashboard
        function updateBusinessBookingStatus(bookingId, newStatus) {
            const businessId = 'royal-hair-studio';
            const businessBookings = JSON.parse(localStorage.getItem(`businessBookings_${businessId}`) || '[]');
            const bookingIndex = businessBookings.findIndex(b => b.bookingId === bookingId);
            
            if (bookingIndex !== -1) {
                businessBookings[bookingIndex].status = newStatus;
                businessBookings[bookingIndex].updatedAt = new Date().toISOString();
                localStorage.setItem(`businessBookings_${businessId}`, JSON.stringify(businessBookings));
            }
        }

        // Setup business booking event listeners
        function setupBusinessBookingEventListeners() {
            // Listen for booking.confirmed events
            window.addEventListener('booking.confirmed', function(event) {
                console.log('Business received booking confirmed event:', event.detail);
                // Refresh business bookings display
                loadBusinessBookings();
            });

            // Listen for booking.cancelled events
            window.addEventListener('booking.cancelled', function(event) {
                console.log('Business received booking cancelled event:', event.detail);
                // Refresh business bookings display
                loadBusinessBookings();
            });

            // Listen for business booking updates
            window.addEventListener('businessBookingUpdated', function(event) {
                console.log('Business booking updated event received:', event.detail);
                // Refresh business bookings display
                loadBusinessBookings();
            });

            // Listen for booking.cancel events
            window.addEventListener('booking.cancel', function(event) {
                console.log('Business received booking cancel event:', event.detail);
                // Refresh business bookings display
                loadBusinessBookings();
                // Show cancellation notification
                showBusinessNotification('Booking cancelled by customer', 'info');
            });

            // Listen for waitinglist.join events
            window.addEventListener('waitinglist.join', function(event) {
                console.log('Business received waitinglist.join event:', event.detail);
                // Refresh waiting list display
                loadWaitingList();
                // Show notification
                showBusinessNotification(`New customer joined waiting list: ${event.detail.customerFirstName}`, 'info');
            });

            // Listen for waitinglist.offer.accept events
            window.addEventListener('waitinglist.offer.accept', function(event) {
                console.log('Business received waitinglist.offer.accept event:', event.detail);
                // Refresh waiting list display
                loadWaitingList();
                // Show notification
                showBusinessNotification('Customer accepted offer - booking created!', 'success');
            });

            // Listen for notification status updates
            window.addEventListener('notification.status.update', function(event) {
                console.log('Business received notification status update:', event.detail);
                // Refresh business bookings display to show updated notification status
                loadBusinessBookings();
                // Show notification status update
                const { notificationType, method, sent } = event.detail;
                const statusText = sent ? 'sent successfully' : 'failed to send';
                showBusinessNotification(`${notificationType} ${method} ${statusText}`, sent ? 'success' : 'error');
            });
        }

        // Show business notification
        function showBusinessNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `business-notification business-notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Initialize bookings on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBusinessBookings();
        });
        // ========================================
        // WAITING LIST FUNCTIONS
        // ========================================

        /**
         * Load and display waiting list
         */
        function loadWaitingList() {
            const businessId = localStorage.getItem('businessId') || 'business_1';
            const waitingList = JSON.parse(localStorage.getItem(`businessWaitingList_${businessId}`) || '[]');
            
            updateWaitingListStats(waitingList);
            displayWaitingList(waitingList);
        }

        /**
         * Update waiting list statistics
         */
        function updateWaitingListStats(waitingList) {
            const totalWaiting = waitingList.filter(item => item.status === 'waiting').length;
            const offersSent = waitingList.filter(item => item.status === 'offered').length;
            const acceptedOffers = waitingList.filter(item => item.status === 'accepted').length;

            document.getElementById('totalWaiting').textContent = totalWaiting;
            document.getElementById('offersSent').textContent = offersSent;
            document.getElementById('acceptedOffers').textContent = acceptedOffers;

            // Update badge
            const badge = document.getElementById('waitingListBadge');
            if (totalWaiting > 0) {
                badge.textContent = totalWaiting;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        /**
         * Display waiting list items
         */
        function displayWaitingList(waitingList) {
            const container = document.getElementById('waitingListContent');
            
            if (waitingList.length === 0) {
                container.innerHTML = `
                    <div class="waiting-list-empty">
                        <i class="fas fa-clock"></i>
                        <h3>No customers waiting</h3>
                        <p>When customers join your waiting list, they'll appear here.</p>
                    </div>
                `;
                return;
            }

            const filteredList = filterWaitingList(waitingList);
            
            container.innerHTML = filteredList.map(item => `
                <div class="waiting-list-item ${item.status}">
                    <div class="customer-info">
                        <div class="customer-name">
                            ${item.customerName || 'Customer'}
                            <span class="position-badge">Position #${item.position || 'N/A'}</span>
                        </div>
                        <div class="customer-details">
                            <div>Joined: ${new Date(item.joinedAt).toLocaleDateString()}</div>
                            <div>Priority: ${item.priority || 0}</div>
                        </div>
                        <div class="service-info">
                            <strong>${item.serviceData.name}</strong> - £${item.serviceData.price}
                        </div>
                        <div class="privacy-notice">
                            <i class="fas fa-shield-alt"></i>
                            ${item.privacyNotice || 'Contact details are securely stored by BlkPages'}
                        </div>
                    </div>
                    <div class="waiting-list-actions-item">
                        ${item.status === 'waiting' ? `
                            <button class="btn-sm btn-success" onclick="sendOffer('${item.id}')">
                                <i class="fas fa-paper-plane"></i> Send Offer
                            </button>
                            <button class="btn-sm btn-danger" onclick="removeFromWaitingList('${item.id}')">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        ` : item.status === 'offered' ? `
                            <span class="status-badge">Offer Sent</span>
                        ` : `
                            <span class="status-badge">Accepted</span>
                        `}
                    </div>
                </div>
            `).join('');
        }

        /**
         * Filter waiting list based on selected filters
         */
        function filterWaitingList(waitingList) {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const serviceFilter = document.getElementById('serviceFilter')?.value || 'all';
            
            return waitingList.filter(item => {
                const statusMatch = statusFilter === 'all' || item.status === statusFilter;
                const serviceMatch = serviceFilter === 'all' || 
                    item.serviceData.name.toLowerCase().includes(serviceFilter.toLowerCase());
                
                return statusMatch && serviceMatch;
            });
        }

        /**
         * Send offer to next customer
         */
        function sendOfferToNextCustomer() {
            const businessId = localStorage.getItem('businessId') || 'business_1';
            const waitingList = JSON.parse(localStorage.getItem(`businessWaitingList_${businessId}`) || '[]');
            const waitingCustomers = waitingList.filter(item => item.status === 'waiting');
            
            if (waitingCustomers.length === 0) {
                showNotification('No customers waiting for offers', 'info');
                return;
            }

            // Get next customer (highest priority)
            const nextCustomer = waitingCustomers.sort((a, b) => (b.priority || 0) - (a.priority || 0))[0];
            
            // Create available slot (mock data)
            const availableSlot = {
                date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                time: '10:00 AM',
                duration: '1h 30m'
            };

            sendOffer(nextCustomer.id, availableSlot);
        }

        /**
         * Send offer to specific customer
         */
        function sendOffer(waitingListId, availableSlot) {
            const businessId = localStorage.getItem('businessId') || 'business_1';
            const waitingList = JSON.parse(localStorage.getItem(`businessWaitingList_${businessId}`) || '[]');
            const item = waitingList.find(item => item.id === waitingListId);
            
            if (!item) {
                showNotification('Customer not found in waiting list', 'error');
                return;
            }

            // Update status to offered
            item.status = 'offered';
            item.offerSentAt = new Date().toISOString();
            item.availableSlot = availableSlot;
            
            localStorage.setItem(`businessWaitingList_${businessId}`, JSON.stringify(waitingList));
            
            // Also update customer waiting list
            const customerWaitingList = JSON.parse(localStorage.getItem(`customerWaitingList_${item.customerId}`) || '[]');
            const customerItem = customerWaitingList.find(customerItem => customerItem.id === waitingListId);
            if (customerItem) {
                customerItem.status = 'offered';
                customerItem.offerSentAt = new Date().toISOString();
                customerItem.availableSlot = availableSlot;
                localStorage.setItem(`customerWaitingList_${item.customerId}`, JSON.stringify(customerWaitingList));
            }

            showNotification(`Offer sent to ${item.customerName || 'customer'}`, 'success');
            loadWaitingList();
        }

        /**
         * Remove customer from waiting list
         */
        function removeFromWaitingList(waitingListId) {
            if (!confirm('Are you sure you want to remove this customer from the waiting list?')) {
                return;
            }

            const businessId = localStorage.getItem('businessId') || 'business_1';
            const waitingList = JSON.parse(localStorage.getItem(`businessWaitingList_${businessId}`) || '[]');
            const item = waitingList.find(item => item.id === waitingListId);
            
            if (!item) {
                showNotification('Customer not found in waiting list', 'error');
                return;
            }

            // Remove from business waiting list
            const updatedList = waitingList.filter(item => item.id !== waitingListId);
            localStorage.setItem(`businessWaitingList_${businessId}`, JSON.stringify(updatedList));
            
            // Remove from customer waiting list
            const customerWaitingList = JSON.parse(localStorage.getItem(`customerWaitingList_${item.customerId}`) || '[]');
            const updatedCustomerList = customerWaitingList.filter(customerItem => customerItem.id !== waitingListId);
            localStorage.setItem(`customerWaitingList_${item.customerId}`, JSON.stringify(updatedCustomerList));

            showNotification('Customer removed from waiting list', 'success');
            loadWaitingList();
        }

        /**
         * Refresh waiting list
         */
        function refreshWaitingList() {
            loadWaitingList();
            showNotification('Waiting list refreshed', 'info');
        }

        /**
         * Filter waiting list
         */
        function filterWaitingList() {
            const businessId = localStorage.getItem('businessId') || 'business_1';                                                                              
            const waitingList = JSON.parse(localStorage.getItem(`businessWaitingList_${businessId}`) || '[]');                                                  
            displayWaitingList(waitingList);
        }

        // ==================== SMS CREDIT SYSTEM ====================
        
        /**
         * Initialize SMS credit system
         */
        function initializeSMSCredits() {
            const businessId = localStorage.getItem('businessId') || 'business_1';
            
            // Load SMS credit data
            loadSMSCreditData(businessId);
            
            // Update SMS analytics
            updateSMSAnalytics(businessId);
            
            // Check for low credit alerts
            checkSMSCreditAlerts(businessId);
        }

        /**
         * Load SMS credit data
         */
        function loadSMSCreditData(businessId) {
            try {
                const analytics = window.smsCreditSystem.getUsageAnalytics(businessId);
                
                if (analytics) {
                    // Update progress bar
                    const progressFill = document.getElementById('smsProgressFill');
                    const creditsRemaining = document.getElementById('smsCreditsRemaining');
                    const bookingSMS = document.getElementById('bookingSMS');
                    const promotionalSMS = document.getElementById('promotionalSMS');
                    const weeklyUsage = document.getElementById('weeklyUsage');
                    const daysRemaining = document.getElementById('daysRemaining');
                    
                    if (progressFill) {
                        const percentage = (analytics.current_credits / analytics.total_allowance) * 100;
                        progressFill.style.width = percentage + '%';
                        
                        // Add warning/critical classes
                        if (analytics.usage_percentage >= 80) {
                            progressFill.classList.add('warning');
                        }
                        if (analytics.usage_percentage >= 100) {
                            progressFill.classList.add('critical');
                        }
                    }
                    
                    if (creditsRemaining) {
                        creditsRemaining.textContent = analytics.current_credits;
                    }
                    
                    if (bookingSMS) {
                        bookingSMS.textContent = analytics.booking_sms;
                    }
                    
                    if (promotionalSMS) {
                        promotionalSMS.textContent = analytics.promotional_sms;
                    }
                    
                    if (weeklyUsage) {
                        weeklyUsage.textContent = analytics.weekly_usage_rate;
                    }
                    
                    if (daysRemaining) {
                        daysRemaining.textContent = analytics.estimated_days_remaining;
                    }
                }
            } catch (error) {
                console.error('Error loading SMS credit data:', error);
            }
        }

        /**
         * Update SMS analytics
         */
        function updateSMSAnalytics(businessId) {
            try {
                const analytics = window.smsCreditSystem.getUsageAnalytics(businessId);
                
                if (analytics) {
                    // Update analytics display
                    console.log('SMS Analytics:', analytics);
                }
            } catch (error) {
                console.error('Error updating SMS analytics:', error);
            }
        }

        /**
         * Check SMS credit alerts
         */
        function checkSMSCreditAlerts(businessId) {
            try {
                const analytics = window.smsCreditSystem.getUsageAnalytics(businessId);
                const alertsContainer = document.getElementById('smsCreditAlerts');
                
                if (!alertsContainer || !analytics) return;
                
                // Clear existing alerts
                alertsContainer.innerHTML = '';
                
                // Show warning alert at 80% usage
                if (analytics.usage_percentage >= 80 && analytics.usage_percentage < 100) {
                    const warningAlert = document.createElement('div');
                    warningAlert.className = 'credit-alert warning';
                    warningAlert.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>80% of your SMS credits have been used. Consider purchasing more credits to avoid interruption.</span>
                    `;
                    alertsContainer.appendChild(warningAlert);
                }
                
                // Show critical alert at 100% usage
                if (analytics.usage_percentage >= 100) {
                    const criticalAlert = document.createElement('div');
                    criticalAlert.className = 'credit-alert critical';
                    criticalAlert.innerHTML = `
                        <i class="fas fa-exclamation-circle"></i>
                        <span>You've used all your SMS credits. SMS notifications are paused until you add more credits.</span>
                    `;
                    alertsContainer.appendChild(criticalAlert);
                }
            } catch (error) {
                console.error('Error checking SMS credit alerts:', error);
            }
        }

        /**
         * Show SMS add-on modal
         */
        function showSMSAddOnModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Buy SMS Credits</h3>
                        <button class="modal-close" onclick="closeSMSAddOnModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="sms-addon-options">
                            <div class="addon-option">
                                <div class="addon-info">
                                    <h4>50 SMS Credits</h4>
                                    <p>Perfect for small businesses</p>
                                </div>
                                <div class="addon-price">£3.00</div>
                                <button class="btn-addon" onclick="purchaseSMSAddOn(1)">Add to Cart</button>
                            </div>
                            <div class="addon-option">
                                <div class="addon-info">
                                    <h4>100 SMS Credits</h4>
                                    <p>Great for growing businesses</p>
                                </div>
                                <div class="addon-price">£6.00</div>
                                <button class="btn-addon" onclick="purchaseSMSAddOn(2)">Add to Cart</button>
                            </div>
                            <div class="addon-option">
                                <div class="addon-info">
                                    <h4>150 SMS Credits</h4>
                                    <p>Perfect for busy businesses</p>
                                </div>
                                <div class="addon-price">£9.00</div>
                                <button class="btn-addon" onclick="purchaseSMSAddOn(3)">Add to Cart</button>
                            </div>
                        </div>
                        <div class="sms-info">
                            <p><i class="fas fa-info-circle"></i> SMS credits are used for booking confirmations, cancellations, and promotional messages.</p>
                            <p><i class="fas fa-shield-alt"></i> All customer phone numbers are encrypted and protected for privacy.</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        /**
         * Close SMS add-on modal
         */
        function closeSMSAddOnModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Purchase SMS add-on
         */
        function purchaseSMSAddOn(bundleCount) {
            const businessId = localStorage.getItem('businessId') || 'business_1';
            
            try {
                // Purchase add-on credits
                const result = window.smsCreditSystem.purchaseAddOn(businessId, bundleCount);
                
                if (result) {
                    // Update display
                    loadSMSCreditData(businessId);
                    checkSMSCreditAlerts(businessId);
                    
                    // Show success message
                    showNotification(`Successfully added ${bundleCount * 50} SMS credits!`, 'success');
                    
                    // Close modal
                    closeSMSAddOnModal();
                }
            } catch (error) {
                console.error('Error purchasing SMS add-on:', error);
                showNotification('Error purchasing SMS credits. Please try again.', 'error');
            }
        }

        /**
         * Initialize SMS system on page load
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize SMS credits after a short delay to ensure systems are loaded                                                                          
            setTimeout(initializeSMSCredits, 1000);
        });

        /**
         * Notification Log Functions
         */
        let notificationLogData = [];

        /**
         * Load notification log data
         */
        function loadNotificationLog() {
            // Mock notification data
            notificationLogData = [
                {
                    id: 'notif_1',
                    date_time: '2024-01-15 14:30:00',
                    recipient: 'j•••@example.com',
                    channel: 'email',
                    type: 'booking.create',
                    status: 'sent',
                    attempts: 1,
                    error: null
                },
                {
                    id: 'notif_2',
                    date_time: '2024-01-15 14:32:00',
                    recipient: '+44••••••7891',
                    channel: 'sms',
                    type: 'booking.create',
                    status: 'sent',
                    attempts: 1,
                    error: null
                },
                {
                    id: 'notif_3',
                    date_time: '2024-01-15 15:15:00',
                    recipient: 'm•••@example.com',
                    channel: 'email',
                    type: 'waitinglist.slot.opened',
                    status: 'sent',
                    attempts: 1,
                    error: null
                },
                {
                    id: 'notif_4',
                    date_time: '2024-01-15 16:00:00',
                    recipient: '+44••••••1234',
                    channel: 'sms',
                    type: 'waitinglist.slot.opened',
                    status: 'failed',
                    attempts: 3,
                    error: 'Invalid phone number'
                },
                {
                    id: 'notif_5',
                    date_time: '2024-01-15 16:30:00',
                    recipient: 'b•••@example.com',
                    channel: 'email',
                    type: 'stripe.payment_failed',
                    status: 'sent',
                    attempts: 1,
                    error: null
                },
                {
                    id: 'notif_6',
                    date_time: '2024-01-15 17:00:00',
                    recipient: 's•••@example.com',
                    channel: 'email',
                    type: 'sms.credits.threshold',
                    status: 'sent',
                    attempts: 1,
                    error: null
                }
            ];

            updateNotificationStats();
            renderNotificationLog();
        }

        /**
         * Update notification statistics
         */
        function updateNotificationStats() {
            const total = notificationLogData.length;
            const successful = notificationLogData.filter(n => n.status === 'sent').length;
            const failed = notificationLogData.filter(n => n.status === 'failed').length;
            const pending = notificationLogData.filter(n => n.status === 'queued').length;

            document.getElementById('totalNotifications').textContent = total;
            document.getElementById('successfulNotifications').textContent = successful;
            document.getElementById('failedNotifications').textContent = failed;
            document.getElementById('pendingNotifications').textContent = pending;
        }

        /**
         * Render notification log table
         */
        function renderNotificationLog() {
            const container = document.getElementById('notificationLogContent');
            if (!container) return;

            const filteredData = filterNotifications(notificationLogData);
            
            container.innerHTML = filteredData.map(notification => `
                <tr>
                    <td>${notification.date_time}</td>
                    <td class="recipient-masked">${notification.recipient}</td>
                    <td>
                        <span class="channel-badge channel-${notification.channel}">
                            <i class="fas fa-${notification.channel === 'email' ? 'envelope' : 'mobile-alt'}"></i>
                            ${notification.channel.toUpperCase()}
                        </span>
                    </td>
                    <td>${getNotificationTypeLabel(notification.type)}</td>
                    <td>
                        <span class="status-badge status-${notification.status}">
                            ${notification.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="attempts-info">${notification.attempts}</td>
                    <td>
                        <div class="notification-actions">
                            ${notification.status === 'failed' ? `
                                <button class="btn-resend" onclick="resendNotification('${notification.id}')">
                                    <i class="fas fa-redo"></i> Resend
                                </button>
                            ` : ''}
                            <button class="btn-details" onclick="showNotificationDetails('${notification.id}')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * Filter notifications based on selected filters
         */
        function filterNotifications(data = notificationLogData) {
            const typeFilter = document.getElementById('notificationTypeFilter')?.value || 'all';
            const statusFilter = document.getElementById('notificationStatusFilter')?.value || 'all';
            const channelFilter = document.getElementById('notificationChannelFilter')?.value || 'all';
            const dateFilter = document.getElementById('notificationDateFilter')?.value;

            return data.filter(notification => {
                if (typeFilter !== 'all' && notification.type !== typeFilter) return false;
                if (statusFilter !== 'all' && notification.status !== statusFilter) return false;
                if (channelFilter !== 'all' && notification.channel !== channelFilter) return false;
                if (dateFilter && !notification.date_time.includes(dateFilter)) return false;
                return true;
            });
        }

        /**
         * Get notification type label
         */
        function getNotificationTypeLabel(type) {
            const labels = {
                'booking.create': 'Booking Confirmation',
                'booking.cancel': 'Booking Cancellation',
                'waitinglist.slot.opened': 'Waiting List Offer',
                'stripe.payment_failed': 'Payment Failed',
                'sms.credits.threshold': 'SMS Low Credit'
            };
            return labels[type] || type;
        }

        /**
         * Resend notification
         */
        function resendNotification(notificationId) {
            const notification = notificationLogData.find(n => n.id === notificationId);
            if (!notification) return;

            // Update status to queued
            notification.status = 'queued';
            notification.attempts = 0;
            notification.error = null;

            // Simulate resend
            setTimeout(() => {
                notification.status = 'sent';
                notification.attempts = 1;
                notification.date_time = new Date().toLocaleString();
                renderNotificationLog();
                updateNotificationStats();
                showNotification('Notification resent successfully', 'success');
            }, 2000);

            renderNotificationLog();
            updateNotificationStats();
            showNotification('Resending notification...', 'info');
        }

        /**
         * Show notification details
         */
        function showNotificationDetails(notificationId) {
            const notification = notificationLogData.find(n => n.id === notificationId);
            if (!notification) return;

            const details = `
                <div class="notification-details">
                    <h3>Notification Details</h3>
                    <p><strong>ID:</strong> ${notification.id}</p>
                    <p><strong>Recipient:</strong> ${notification.recipient}</p>
                    <p><strong>Channel:</strong> ${notification.channel.toUpperCase()}</p>
                    <p><strong>Type:</strong> ${getNotificationTypeLabel(notification.type)}</p>
                    <p><strong>Status:</strong> ${notification.status.toUpperCase()}</p>
                    <p><strong>Attempts:</strong> ${notification.attempts}</p>
                    <p><strong>Date/Time:</strong> ${notification.date_time}</p>
                    ${notification.error ? `
                        <div class="error-details">
                            <strong>Error:</strong> ${notification.error}
                        </div>
                    ` : ''}
                </div>
            `;

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Notification Details</h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${details}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        /**
         * Export notification log to CSV
         */
        function exportNotificationLog() {
            const filteredData = filterNotifications(notificationLogData);
            
            const csvContent = [
                ['Date/Time', 'Recipient', 'Channel', 'Type', 'Status', 'Attempts'],
                ...filteredData.map(n => [
                    n.date_time,
                    n.recipient,
                    n.channel,
                    getNotificationTypeLabel(n.type),
                    n.status,
                    n.attempts
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notification-log-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('Notification log exported successfully', 'success');
        }

        /**
         * Refresh notification log
         */
        function refreshNotificationLog() {
            loadNotificationLog();
            showNotification('Notification log refreshed', 'success');
        }

        /**
         * Initialize notification log when section is shown
         */
        function initializeNotificationLog() {
            if (document.getElementById('notification-log').classList.contains('active')) {
                loadNotificationLog();
            }
        }

        // Add channel badge styles
        const channelBadgeStyles = `
            <style>
                .channel-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 0.25rem;
                    padding: 0.25rem 0.5rem;
                    border-radius: 12px;
                    font-size: 0.8rem;
                    font-weight: 600;
                }
                
                .channel-email {
                    background: rgba(33, 150, 243, 0.2);
                    color: #2196f3;
                    border: 1px solid #2196f3;
                }
                
                .channel-sms {
                    background: rgba(76, 175, 80, 0.2);
                    color: #4caf50;
                    border: 1px solid #4caf50;
                }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', channelBadgeStyles);
    </script>
</body>
</html>
