<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse - BlkPages</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/output.css">
    
    <!-- Business Manager -->
    <script src="business-manager.js"></script>
    
    <!-- Analytics Tracking System -->
    <script src="analytics-tracker.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif']
                    },
                    colors: {
                        'charcoal': '#121212',
                        'dark-grey': '#1A1A1A',
                        'light-grey': '#CCCCCC',
                        'gold': '#D4AF37',
                        'neon-pink': '#FF3CAC',
                        'neon-blue': '#2B86C5',
                        'neon-green': '#4ADE80',
                        'neon-purple': '#784BA0'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'pulse-subtle': 'pulseSubtle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(212, 175, 55, 0.2)' },
                            '100%': { boxShadow: '0 0 30px rgba(212, 175, 55, 0.4)' }
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%, #000000 100%);
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, 
                rgba(0,0,0,0.9) 0%, 
                rgba(26,26,26,0.8) 25%, 
                rgba(42,42,42,0.7) 50%, 
                rgba(26,26,26,0.8) 75%, 
                rgba(0,0,0,0.9) 100%);
        }
        
        .card-gradient {
            background: linear-gradient(145deg, 
                rgba(26,26,26,0.95) 0%, 
                rgba(42,42,42,0.9) 50%, 
                rgba(26,26,26,0.95) 100%);
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 50%, #D4AF37 100%);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3), 
                        0 0 40px rgba(212, 175, 55, 0.2), 
                        0 0 60px rgba(212, 175, 55, 0.1);
        }
        
        .text-glow {
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .border-glow {
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }
        
        /* Header backdrop blur effect */
        .header-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FFD700, #D4AF37);
        }
    </style>
</head>
<body class="bg-black text-white font-inter">
    <!-- Fixed Header -->
    <header class="fixed top-0 w-full z-50 bg-black header-blur border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-white hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)]">
                        BlkPages
                    </a>
                </div>
                
                <!-- Navigation Links -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="search-results-new.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Browse
                    </a>
                    <a href="offers.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Offers
                    </a>
                    <a href="business-register.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Add Business
                    </a>
                    <a href="customer-login.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Sign In
                    </a>
                    <a href="customer-dashboard.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)]">
                        <i class="fas fa-user-circle text-xl"></i>
                    </a>
                    <a href="#" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] relative">
                        <i class="fas fa-shopping-basket text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-gold text-black text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">3</span>
                    </a>
                </nav>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-white/60 hover:text-gold transition-all duration-300">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden hidden bg-black/95 header-blur border-t border-white/10">
                <div class="px-4 py-4 space-y-4">
                    <a href="search-results-new.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Browse</a>
                    <a href="offers.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Offers</a>
                    <a href="business-register.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Add Business</a>
                    <a href="customer-login.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Sign In</a>
                    <a href="customer-dashboard.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Profile</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="text-center pt-20 pb-12 md:pt-24 md:pb-16 bg-gradient-to-b from-black via-[#121212] to-[#1a1a1a]">
        <h1 class="text-3xl md:text-5xl font-bold text-white mb-3">Find Your Perfect Business</h1>
        <p class="text-gray-400 mb-8 text-sm md:text-base">Search for businesses near you.</p>
        
        <div class="max-w-4xl mx-auto bg-[#1a1a1a] border border-yellow-500/30 rounded-xl p-4 md:p-6 shadow-lg">
            <div class="flex flex-col md:flex-row gap-3 md:gap-4 items-center justify-center">
                <input type="text" id="businessSearch" placeholder="Search for premium businesses..." class="flex-1 px-4 py-2 rounded-md bg-black text-gray-200 border border-gray-700 focus:border-yellow-400 focus:ring-yellow-400 w-full md:w-auto">
                <input type="text" id="locationSearch" placeholder="Location" class="flex-1 px-4 py-2 rounded-md bg-black text-gray-200 border border-gray-700 focus:border-yellow-400 focus:ring-yellow-400 w-full md:w-auto">
                <button onclick="performSearch()" class="bg-yellow-400 text-black font-semibold px-6 py-2 rounded-md hover:bg-yellow-300 w-full md:w-auto">Search</button>
                        </div>
                        
            <div class="flex flex-wrap justify-center gap-3 mt-4">
                <button onclick="findNearMe()" class="bg-black text-gray-200 border border-gray-700 hover:border-yellow-400 rounded-full px-4 py-1 text-sm">Near Me</button>
                <select id="categoryFilter" onchange="applyFilters()" class="bg-black text-gray-200 border border-gray-700 rounded-md px-3 py-1">
                                <option value="">All Categories</option>
                                <option value="hair">Hair & Beauty</option>
                                <option value="barber">Barbering</option>
                                <option value="beauty">Spa & Wellness</option>
                                <option value="nails">Nail Art</option>
                            </select>
                <select id="locationFilter" onchange="applyFilters()" class="bg-black text-gray-200 border border-gray-700 rounded-md px-3 py-1">
                                <option value="">All Locations</option>
                                <option value="london">London</option>
                                <option value="manchester">Manchester</option>
                                <option value="birmingham">Birmingham</option>
                                <option value="liverpool">Liverpool</option>
                            </select>
                <select id="sortByFilter" onchange="applyFilters()" class="bg-black text-gray-200 border border-gray-700 rounded-md px-3 py-1">
                                <option value="relevance">Sort By Relevance</option>
                                <option value="rating">Highest Rated</option>
                                <option value="distance">Nearest First</option>
                                <option value="name">Name A-Z</option>
                            </select>
                        </div>
                            </div>
    </section>

    <!-- Featured Businesses Section -->
    <section id="featured" class="max-w-6xl mx-auto px-4 py-8">
        <h2 class="text-2xl font-bold text-white mb-4">🌟 Featured Businesses</h2>
        <div id="featured-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Featured business cards will be populated here -->
        </div>
    </section>

    <!-- Main Content -->
    <main class="py-16 gradient-bg">
        <div class="max-w-6xl mx-auto px-4">
            <!-- Results Header -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-white mb-4">Premium Business Directory</h2>
                <p class="text-light-grey text-lg" id="resultsCount">Loading premium businesses...</p>
                </div>
                
                <!-- Sort and Filter Controls -->
            <div class="flex justify-end gap-3 mb-6">
                <select id="sortSelect" onchange="sortResults()" class="bg-black text-gray-200 border border-gray-700 rounded-md px-3 py-1">
                    <option value="relevance">Sort By Relevance</option>
                            <option value="rating">Highest Rated</option>
                            <option value="distance">Nearest First</option>
                            <option value="name">Name A-Z</option>
                        </select>
                <button onclick="toggleFilters()" class="bg-black text-gray-200 border border-gray-700 rounded-md px-3 py-1 flex items-center gap-1">
                    <i class="fa fa-filter text-yellow-400"></i> Advanced Filters
                    </button>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="filtersPanel" class="hidden mb-12 card-gradient rounded-3xl p-8 border-glow animate-slide-up">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Rating Filter -->
                    <div>
                        <label class="block text-sm font-medium text-white mb-3">Minimum Rating</label>
                        <select id="ratingFilter" onchange="applyFilters()" class="w-full px-4 py-3 rounded-xl bg-dark-grey border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-gold/50 focus:border-gold transition-all duration-300">
                            <option value="">Any Rating</option>
                            <option value="4.5">4.5+ Stars</option>
                            <option value="4.0">4.0+ Stars</option>
                            <option value="3.5">3.5+ Stars</option>
                            <option value="3.0">3.0+ Stars</option>
                        </select>
                    </div>
                    
                    <!-- Distance Filter -->
                    <div>
                        <label class="block text-sm font-medium text-white mb-3">Distance</label>
                        <select id="distanceFilter" onchange="applyFilters()" class="w-full px-4 py-3 rounded-xl bg-dark-grey border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-gold/50 focus:border-gold transition-all duration-300">
                            <option value="5">Within 5 miles</option>
                            <option value="10">Within 10 miles</option>
                            <option value="25">Within 25 miles</option>
                            <option value="50">Within 50 miles</option>
                        </select>
                    </div>
                    
                    <!-- Price Range -->
                    <div>
                        <label class="block text-sm font-medium text-white mb-3">Price Range</label>
                        <select id="priceFilter" onchange="applyFilters()" class="w-full px-4 py-3 rounded-xl bg-dark-grey border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-gold/50 focus:border-gold transition-all duration-300">
                            <option value="">Any Price</option>
                            <option value="budget">£ - Budget</option>
                            <option value="mid">££ - Mid Range</option>
                            <option value="premium">£££ - Premium</option>
                        </select>
                    </div>
                    
                    <!-- Clear Filters -->
                    <div class="flex items-end">
                        <button onclick="clearFilters()" class="w-full px-6 py-3 rounded-xl bg-dark-grey border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 transition-all duration-300">
                            <i class="fas fa-times mr-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Business Results -->
            <div id="business-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                <!-- Business cards will be populated here -->
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-16">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gold"></div>
                <p class="text-light-grey mt-6 text-lg">Loading premium businesses...</p>
            </div>
            
            <!-- No Results State -->
            <div id="noResultsState" class="hidden text-center py-16">
                <div class="w-24 h-24 mx-auto mb-6 bg-gold/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-search text-4xl text-gold"></i>
                </div>
                <h3 class="text-3xl font-bold text-white mb-4">No businesses found</h3>
                <p class="text-light-grey mb-8 text-lg">Try adjusting your search criteria or filters</p>
                <button onclick="clearFilters()" class="px-8 py-4 rounded-2xl gold-gradient text-black font-bold text-lg hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105">
                    Clear All Filters
                </button>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="mt-16 flex justify-center">
                <!-- Pagination will be populated here -->
            </div>
        </div>
    </main>


    <!-- Footer -->
    <footer class="bg-charcoal border-t border-white/10 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Brand -->
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-8 h-8 bg-gold rounded-full flex items-center justify-center">
                            <i class="fas fa-gem text-black text-lg"></i>
                        </div>
                        <span class="text-xl font-bold text-white">BlkPages</span>
                    </div>
                    <p class="text-light-grey mb-4">Supporting Black-owned businesses and connecting communities.</p>
                </div>
                
                <!-- Quick Links -->
                <div>
                    <h3 class="text-white font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="about.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">About</a></li>
                        <li><a href="contact.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">Contact</a></li>
                        <li><a href="privacy.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">Privacy</a></li>
                        <li><a href="terms.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">Terms</a></li>
                        <li><a href="blog.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">Blog</a></li>
                    </ul>
                </div>
                
                <!-- Support -->
                <div>
                    <h3 class="text-white font-semibold mb-4">Support</h3>
                    <ul class="space-y-2">
                        <li><a href="faq.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">FAQ</a></li>
                        <li><a href="business-register.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">Add Business</a></li>
                        <li><a href="customer-login.html" class="text-light-grey hover:text-gold hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] transition-all duration-300">Sign In</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Copyright -->
            <div class="border-t border-white/10 mt-8 pt-8 text-center">
                <p class="text-light-grey">© 2025 BlkPages – Supporting Black-owned Businesses</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let allBusinesses = [];
        let filteredBusinesses = [];
        let currentPage = 1;
        const businessesPerPage = 9;
        let currentFilters = {
            search: '',
            location: '',
            category: '',
            rating: '',
            distance: '5',
            price: '',
            sortBy: 'relevance'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBusinesses();
            loadFeaturedBusinesses();
            setupEventListeners();
            addScrollEffect();
        });

        // Add scroll effect to header
        function addScrollEffect() {
            const header = document.querySelector('header');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 100) {
                    header.classList.add('bg-black/95');
                } else {
                    header.classList.remove('bg-black/95');
                }
            });
        }

        // Load businesses from business manager
        function loadBusinesses() {
            try {
                // Check if we have cached sorted businesses
                const cachedSorted = localStorage.getItem('sortedBusinesses');
                if (cachedSorted) {
                    try {
                        allBusinesses = JSON.parse(cachedSorted);
                        console.log('Loaded cached sorted businesses');
                    } catch (parseError) {
                        console.warn('Failed to parse cached businesses, falling back to fresh load');
                        allBusinesses = loadFreshBusinesses();
                    }
                } else {
                    // Load fresh businesses and sort them
                    allBusinesses = loadFreshBusinesses();
                    // Generate initial sort order
                    regenerateSearchOrder();
                }
                
                filteredBusinesses = [...allBusinesses];
                displayResults();
                hideLoading();
            } catch (error) {
                console.error('Error loading businesses:', error);
                allBusinesses = getDemoBusinesses();
                filteredBusinesses = [...allBusinesses];
                displayResults();
                hideLoading();
            }
        }

        // Load fresh businesses from data source
        function loadFreshBusinesses() {
            try {
                // Try to get businesses from business manager first
                if (typeof BusinessManager !== 'undefined') {
                    const businessManager = new BusinessManager();
                    return businessManager.getBusinesses();
                } else {
                    // Fallback to demo data
                    return getDemoBusinesses();
                }
            } catch (error) {
                console.error('Error loading fresh businesses:', error);
                return getDemoBusinesses();
            }
        }

        // Load featured businesses
        function loadFeaturedBusinesses() {
            try {
                // Get businesses from business manager or demo data
                let businesses = [];
                if (typeof BusinessManager !== 'undefined') {
                    const businessManager = new BusinessManager();
                    businesses = businessManager.getBusinesses();
                } else {
                    businesses = getDemoBusinesses();
                }
                
                // Filter for featured businesses (those with featuredActive = true)
                const featuredBusinesses = businesses.filter(business => 
                    business.featuredActive === true
                ).slice(0, 6); // Show up to 6 featured businesses
                
                displayFeaturedBusinesses(featuredBusinesses);
            } catch (error) {
                console.error('Error loading featured businesses:', error);
                // Fallback to demo featured businesses
                const demoFeatured = getDemoBusinesses().filter(business => 
                    business.featuredActive === true
                ).slice(0, 6);
                displayFeaturedBusinesses(demoFeatured);
            }
        }

        // Display featured businesses
        function displayFeaturedBusinesses(businesses) {
            const container = document.getElementById('featured-list');
            
            if (businesses.length === 0) {
                container.innerHTML = '<p class="text-gray-400 col-span-full text-center">No featured businesses available at the moment.</p>';
                return;
            }
            
            container.innerHTML = businesses.map(business => {
                const businessSlug = business.id || business.name.toLowerCase().replace(/\s+/g, '-');
                const categoryColors = {
                    hair: 'text-pink-400',
                    barber: 'text-blue-400',
                    beauty: 'text-green-400',
                    nails: 'text-purple-400'
                };
                const categoryColor = categoryColors[business.category] || 'text-yellow-300';
                
                return `
                    <div class="relative bg-[#1a1a1a] rounded-lg p-4 shadow-md hover:shadow-yellow-400/20 transition-all duration-300 hover:scale-105">
                        <div class="relative mb-3">
                            <img src="${business.image}" 
                                 alt="${business.name}" 
                                 class="w-full h-32 object-cover rounded-md"
                                 onerror="this.src='https://images.unsplash.com/photo-1560066984-138dadb4c035?w=400&h=200&fit=crop&crop=center'">
                            ${business.hasOffer ? `
                            <div class="absolute top-2 right-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-400 text-black">
                                    <i class="fas fa-tag mr-1"></i>Offer
                                </span>
                            </div>
                            ` : ''}
                        </div>
                        <h3 class="text-lg font-semibold ${categoryColor} mb-1">${business.name}</h3>
                        <p class="text-gray-400 text-sm mb-2">${business.description}</p>
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="flex text-yellow-400 text-sm mr-2">
                                    ${Array(5).fill(0).map((_, i) => 
                                        `<i class="fas fa-star ${i < Math.floor(business.rating) ? '' : 'text-gray-600'}"></i>`
                                    ).join('')}
                                </div>
                                <span class="text-gray-400 text-xs">${business.rating} (${business.reviews})</span>
                            </div>
                            <span class="text-gray-400 text-xs">${business.location}</span>
                        </div>
                        <button onclick="goToBusinessProfile('${businessSlug}')" 
                                class="w-full bg-yellow-400 text-black font-semibold px-4 py-1.5 rounded-md hover:bg-yellow-300 transition-colors duration-300">
                            Book Now
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Demo business data with premium styling
        function getDemoBusinesses() {
            return [
                {
                    id: 'demo_1',
                    name: "Royal Hair Studio",
                    category: "hair",
                    rating: 4.9,
                    reviews: 127,
                    location: "123 Main Street, London",
                    image: "https://images.unsplash.com/photo-1560066984-138dadb4c035?w=500&h=300&fit=crop&crop=center",
                    subscription: "professional",
                    tier: "professional",
                    nextTier: null, // no pending changes
                    price: "premium",
                    description: "Premium hair styling and cutting services with advanced booking system",
                    phone: "+44 20 1234 5678",
                    email: "info@royalhair.com",
                    address: "123 Main Street, London",
                    services: ["Hair Cut", "Coloring", "Styling", "Extensions"],
                    hours: "Mon-Sat: 9AM-7PM",
                    premium: true,
                    hasOffer: true,
                    offerText: "20% Off First Visit",
                    featuredActive: true,
                    featuredNext: true, // will continue next month
                    featuredCancelled: false,
                    featuredExpiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days from now
                    billingCycleEnd: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000) // 15 days from now
                },
                {
                    id: 'demo_2',
                    name: "Elite Barber Shop",
                    category: "barber",
                    rating: 4.7,
                    reviews: 89,
                    location: "456 High Street, London",
                    image: "https://images.unsplash.com/photo-1621605815971-fbc98d665033?w=500&h=300&fit=crop&crop=center",
                    subscription: "starter",
                    tier: "starter",
                    nextTier: "professional", // upgrading next month
                    price: "mid",
                    description: "Traditional barbering with modern techniques",
                    phone: "+44 20 2345 6789",
                    email: "contact@elitebarber.com",
                    address: "456 High Street, London",
                    services: ["Hair Cut", "Beard Trim", "Shave", "Styling"],
                    hours: "Mon-Sat: 8AM-6PM",
                    premium: false,
                    featuredActive: false,
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 20 * 24 * 60 * 60 * 1000) // 20 days from now
                },
                {
                    id: 'demo_3',
                    name: "Glamour Beauty",
                    category: "beauty",
                    rating: 4.8,
                    reviews: 156,
                    location: "789 Oxford Street, London",
                    image: "https://images.unsplash.com/photo-1516975080664-ed2fc6a32937?w=500&h=300&fit=crop&crop=center",
                    subscription: "professional",
                    tier: "professional",
                    nextTier: null, // no pending changes
                    price: "premium",
                    description: "Full-service beauty salon with premium treatments",
                    phone: "+44 20 3456 7890",
                    email: "info@glamourbeauty.com",
                    address: "789 Oxford Street, London",
                    services: ["Facial", "Massage", "Manicure", "Pedicure"],
                    hours: "Mon-Sun: 10AM-8PM",
                    premium: true,
                    hasOffer: true,
                    offerText: "Free Consultation",
                    featuredActive: true,
                    featuredNext: false, // will not continue next month
                    featuredCancelled: true, // cancelled mid-month
                    featuredExpiry: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000), // 3 days from now
                    billingCycleEnd: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000) // 10 days from now
                },
                {
                    id: 'demo_4',
                    name: "Style Studio",
                    category: "hair",
                    rating: 4.6,
                    reviews: 73,
                    location: "321 King's Road, London",
                    image: "https://images.unsplash.com/photo-1562322140-8baeececf3df?w=500&h=300&fit=crop&crop=center",
                    subscription: "free",
                    tier: "free",
                    nextTier: "starter", // upgrading next month
                    price: "mid",
                    description: "Contemporary hair styling and coloring",
                    phone: "+44 20 4567 8901",
                    email: "hello@stylestudio.com",
                    address: "321 King's Road, London",
                    services: ["Hair Cut", "Coloring", "Highlights", "Treatment"],
                    hours: "Tue-Sat: 9AM-6PM",
                    premium: false,
                    featuredActive: false,
                    featuredNext: true, // will add featured next month
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 25 * 24 * 60 * 60 * 1000) // 25 days from now
                },
                {
                    id: 'demo_5',
                    name: "Classic Cuts",
                    category: "barber",
                    rating: 4.5,
                    reviews: 45,
                    location: "654 Baker Street, London",
                    image: "https://images.unsplash.com/photo-1585747860715-2ba37e788b70?w=500&h=300&fit=crop&crop=center",
                    subscription: "starter",
                    tier: "starter",
                    nextTier: null, // no pending changes
                    price: "budget",
                    description: "Traditional barber shop with classic cuts",
                    phone: "+44 20 5678 9012",
                    email: "info@classiccuts.com",
                    address: "654 Baker Street, London",
                    services: ["Hair Cut", "Beard Trim", "Mustache"],
                    hours: "Mon-Fri: 8AM-5PM",
                    premium: false,
                    featuredActive: false,
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000) // 1 day ago (expired)
                },
                {
                    id: 'demo_6',
                    name: "Beauty Haven",
                    category: "beauty",
                    rating: 4.9,
                    reviews: 203,
                    location: "987 Regent Street, London",
                    image: "https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?w=500&h=300&fit=crop&crop=center",
                    subscription: "professional",
                    tier: "professional",
                    nextTier: null, // no pending changes
                    price: "premium",
                    description: "Luxury beauty treatments and spa services",
                    phone: "+44 20 6789 0123",
                    email: "contact@beautyhaven.com",
                    address: "987 Regent Street, London",
                    services: ["Spa Treatment", "Facial", "Massage", "Body Treatment"],
                    hours: "Mon-Sun: 9AM-9PM",
                    premium: true,
                    hasOffer: true,
                    offerText: "Buy 2 Get 1 Free",
                    featuredActive: false,
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000) // 2 days ago (expired)
                },
                {
                    id: 'demo_7',
                    name: "Perfect Nails",
                    category: "nails",
                    rating: 4.4,
                    reviews: 67,
                    location: "147 Bond Street, London",
                    image: "https://images.unsplash.com/photo-1604654894610-df63bc536371?w=500&h=300&fit=crop&crop=center",
                    subscription: "free",
                    tier: "free",
                    nextTier: null, // no pending changes
                    price: "mid",
                    description: "Professional nail art and manicure services",
                    phone: "+44 20 7890 1234",
                    email: "info@perfectnails.com",
                    address: "147 Bond Street, London",
                    services: ["Manicure", "Pedicure", "Nail Art", "Gel Polish"],
                    hours: "Mon-Sat: 10AM-7PM",
                    premium: false,
                    featuredActive: false,
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 18 * 24 * 60 * 60 * 1000) // 18 days from now
                },
                {
                    id: 'demo_8',
                    name: "Quick Cuts",
                    category: "barber",
                    rating: 4.2,
                    reviews: 23,
                    location: "555 Quick Street, London",
                    image: "https://images.unsplash.com/photo-1621605815971-fbc98d665033?w=500&h=300&fit=crop&crop=center",
                    subscription: "starter",
                    tier: "starter",
                    nextTier: null, // no pending changes
                    price: "budget",
                    description: "Fast and affordable haircuts",
                    phone: "+44 20 8765 4321",
                    email: "contact@quickcuts.com",
                    address: "555 Quick Street, London",
                    services: ["Hair Cut", "Quick Trim"],
                    hours: "Mon-Sat: 7AM-4PM",
                    premium: false,
                    featuredActive: true,
                    featuredNext: true, // will continue next month
                    featuredCancelled: false,
                    featuredExpiry: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000), // 1 day from now
                    billingCycleEnd: new Date(Date.now() + 8 * 24 * 60 * 60 * 1000) // 8 days from now
                },
                {
                    id: 'demo_9',
                    name: "Luxury Spa",
                    category: "beauty",
                    rating: 4.7,
                    reviews: 134,
                    location: "888 Mayfair, London",
                    image: "https://images.unsplash.com/photo-1540555700478-4be289fbecef?w=500&h=300&fit=crop&crop=center",
                    subscription: "professional",
                    tier: "professional",
                    nextTier: null, // no pending changes
                    price: "premium",
                    description: "Exclusive spa treatments in luxury setting",
                    phone: "+44 20 9999 8888",
                    email: "info@luxuryspa.com",
                    address: "888 Mayfair, London",
                    services: ["Luxury Facial", "Hot Stone Massage", "Body Wrap", "Aromatherapy"],
                    hours: "Mon-Sun: 8AM-10PM",
                    premium: true,
                    featuredActive: false,
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30 days from now
                }
            ];
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input listeners
            document.getElementById('businessSearch').addEventListener('input', debounce(performSearch, 300));
            document.getElementById('locationSearch').addEventListener('input', debounce(performSearch, 300));
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Perform search
        function performSearch() {
            currentFilters.search = document.getElementById('businessSearch').value.toLowerCase();
            currentFilters.location = document.getElementById('locationSearch').value.toLowerCase();
            
            applyFilters();
        }

        // Filter by category
        function filterByCategory(category) {
            currentFilters.category = category;
            applyFilters();
        }

        // Find near me function
        function findNearMe() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    localStorage.setItem('userLat', position.coords.latitude);
                    localStorage.setItem('userLng', position.coords.longitude);
                    localStorage.setItem('userLocation', 'Current Location');
                    
                    // Redirect to search results page with "near me" parameter
                    window.location.href = 'search-results-new.html?nearme=true';
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }


        // Apply all filters
        function applyFilters() {
            // Get filter values from dropdowns
            const categoryFilter = document.getElementById('categoryFilter');
            const locationFilter = document.getElementById('locationFilter');
            const sortByFilter = document.getElementById('sortByFilter');
            
            if (categoryFilter) currentFilters.category = categoryFilter.value;
            if (locationFilter) currentFilters.location = locationFilter.value;
            if (sortByFilter) currentFilters.sortBy = sortByFilter.value;
            
            filteredBusinesses = allBusinesses.filter(business => {
                // Search filter
                const matchesSearch = !currentFilters.search || 
                    business.name.toLowerCase().includes(currentFilters.search) ||
                    business.description.toLowerCase().includes(currentFilters.search) ||
                    business.services.some(service => service.toLowerCase().includes(currentFilters.search));

                // Location filter
                const matchesLocation = !currentFilters.location ||
                    business.location.toLowerCase().includes(currentFilters.location) ||
                    business.address.toLowerCase().includes(currentFilters.location);

                // Category filter
                const matchesCategory = !currentFilters.category || business.category === currentFilters.category;

                // Rating filter
                const matchesRating = !currentFilters.rating || business.rating >= parseFloat(currentFilters.rating);

                // Price filter
                const matchesPrice = !currentFilters.price || business.price === currentFilters.price;

                return matchesSearch && matchesLocation && matchesCategory && matchesRating && matchesPrice;
            });

            // Sort results
            sortResults();
            
            // Reset to first page
            currentPage = 1;
            
            // Display results
            displayResults();
        }

        // Sort results
        function sortResults() {
            // Check for both sortSelect and sortByFilter elements
            const sortSelect = document.getElementById('sortSelect');
            const sortByFilter = document.getElementById('sortByFilter');
            const sortBy = sortByFilter ? sortByFilter.value : (sortSelect ? sortSelect.value : 'relevance');
            
            filteredBusinesses.sort((a, b) => {
                // First, sort by tier priority (featured > professional > starter > free)
                const aTier = a.featuredActive ? 'featured' : a.tier;
                const bTier = b.featuredActive ? 'featured' : b.tier;
                const tierDiff = tierPriority[aTier] - tierPriority[bTier];
                
                if (tierDiff !== 0) {
                    return tierDiff;
                }
                
                // Within the same tier, apply user's sorting preference
                switch (sortBy) {
                    case 'rating':
                        return b.rating - a.rating;
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'distance':
                        // For demo purposes, randomize distance
                        return Math.random() - 0.5;
                    default: // relevance - maintain current order (already sorted by tier)
                        return 0;
                }
            });
            
            displayResults();
        }

        // Display results
        function displayResults() {
            const resultsContainer = document.getElementById('business-list');
            const resultsCount = document.getElementById('resultsCount');
            const loadingState = document.getElementById('loadingState');
            const noResultsState = document.getElementById('noResultsState');
            
            // Update results count
            resultsCount.textContent = `${filteredBusinesses.length} premium businesses found`;
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            if (filteredBusinesses.length === 0) {
                // Show no results state
                resultsContainer.innerHTML = '';
                noResultsState.classList.remove('hidden');
                return;
            }
            
            // Hide no results state
            noResultsState.classList.add('hidden');
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * businessesPerPage;
            const endIndex = startIndex + businessesPerPage;
            const businessesToShow = filteredBusinesses.slice(startIndex, endIndex);
            
            // Generate business cards
            resultsContainer.innerHTML = businessesToShow.map(business => createBusinessCard(business)).join('');
            
            // Update pagination
            updatePagination();
        }

        // Helper function to determine business tier
        function getBusinessTier(business) {
            if (business.subscription === 'free' || !business.subscription) {
                return 'basic';
            } else if (business.subscription === 'starter') {
                return 'starter';
            } else if (business.subscription === 'professional' || business.subscription === 'premium') {
                return 'professional';
            }
            return 'basic'; // Default fallback
        }

        // Create business card HTML with tier-based styling
        function createBusinessCard(business) {
            const tier = getBusinessTier(business);
            const categoryColors = {
                hair: 'neon-pink',
                barber: 'neon-blue',
                beauty: 'neon-green',
                nails: 'neon-purple'
            };
            
            const categoryIcons = {
                hair: 'fa-solid fa-scissors',
                barber: 'fa-solid fa-scissors',
                beauty: 'fa-solid fa-spa',
                nails: 'fa-solid fa-hand-paper'
            };
            
            const priceSymbols = {
                budget: '£',
                mid: '££',
                premium: '£££'
            };
            
            const categoryColor = categoryColors[business.category] || 'neon-purple';
            const categoryIcon = categoryIcons[business.category] || 'fas fa-star';
            const priceSymbol = priceSymbols[business.price] || '£';
            
            if (tier === 'basic') {
                // Basic card - NO links, NO images, informational only
                return `
                <div class="card-gradient rounded-3xl p-6 border-glow transition-all duration-300 hover:border-gold/50 hover:shadow-2xl hover:shadow-gold/20" role="article" aria-label="Basic business listing for ${business.name}" style="cursor: default;">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-white">${business.name}</h3>
                        <span class="inline-flex items-center px-2 py-1 text-xs font-medium text-yellow-400 bg-black rounded-full">
                            <i class="${categoryIcon} mr-1"></i>${business.category.charAt(0).toUpperCase() + business.category.slice(1)}
                        </span>
                    </div>
                    <div class="space-y-3">
                        ${business.location ? `
                        <p class="text-light-grey text-sm flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-gold w-4"></i>
                            ${business.location}
                        </p>` : ''}
                        ${business.phone ? `
                        <p class="text-light-grey text-sm flex items-center">
                            <i class="fas fa-phone mr-3 text-gold w-4"></i>
                            ${business.phone}
                        </p>` : ''}
                        ${business.email ? `
                        <p class="text-light-grey text-sm flex items-center">
                            <i class="fas fa-envelope mr-3 text-gold w-4"></i>
                            ${business.email}
                        </p>` : ''}
                    </div>
                    <div class="text-center mt-6">
                        <p class="text-light-grey text-sm">Contact the business directly for enquiries</p>
                    </div>
                </div>
                `;
            } else {
                // Starter/Professional card - preserve original premium styling
                const businessSlug = business.id || business.name.toLowerCase().replace(/\s+/g, '-');
                const profileUrl = `/business/${businessSlug}`;
                
                return `
                <div class="card-gradient rounded-3xl p-6 border-glow hover:border-gold/50 transition-all duration-500 hover:shadow-2xl hover:shadow-gold/20 group transform hover:scale-105 animate-fade-in">
                    <!-- Business Image -->
                    <div class="relative mb-6 overflow-hidden rounded-2xl">
                        <img src="${business.image}" 
                             alt="${business.name}" 
                             class="w-full h-56 object-cover rounded-2xl group-hover:scale-110 transition-transform duration-500"
                             onerror="this.src='https://images.unsplash.com/photo-1560066984-138dadb4c035?w=500&h=300&fit=crop&crop=center'">
                        
                        <!-- Tier Badge -->
                        <div class="absolute top-4 left-4">
                            <span class="px-4 py-2 rounded-full text-sm font-bold gold-gradient text-black border border-gold/50 shadow-lg">
                                <i class="fas fa-crown mr-1"></i>${tier === 'professional' ? 'Professional' : 'Starter'}
                            </span>
                        </div>
                        
                        <!-- Offer Badge -->
                        ${business.hasOffer ? `
                        <div class="absolute top-2 right-2">
                            <span class="bg-yellow-400 text-black text-xs font-semibold px-2 py-1 rounded-md shadow-md">
                                Offer
                            </span>
                        </div>
                        ` : `
                        <!-- Category Badge -->
                        <div class="absolute top-2 right-2">
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium text-yellow-400 bg-black rounded-full">
                                <i class="${categoryIcon} mr-1"></i>${business.category.charAt(0).toUpperCase() + business.category.slice(1)}
                            </span>
                        </div>
                        `}
                        
                        <!-- Price Badge -->
                        <div class="absolute bottom-4 right-4">
                            <span class="px-4 py-2 rounded-full text-sm font-bold bg-black/80 text-gold border border-gold/50 backdrop-blur-sm shadow-lg">
                                ${priceSymbol}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Business Info -->
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-white mb-3 group-hover:text-gold transition-colors duration-300">
                            <a href="${profileUrl}" class="hover:text-gold transition-colors duration-300">${business.name}</a>
                        </h3>
                        
                        <!-- Rating -->
                        <div class="flex items-center mb-3">
                            <div class="flex text-gold mr-3">
                                ${Array(5).fill(0).map((_, i) => 
                                    `<i class="fas fa-star ${i < Math.floor(business.rating) ? '' : 'text-white/30'}"></i>`
                                ).join('')}
                            </div>
                            <span class="text-white/70 text-sm">${business.rating} (${business.reviews} reviews)</span>
                        </div>
                        
                        <!-- Location -->
                        <p class="text-white/70 text-sm mb-4 flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-${categoryColor}"></i>
                            ${business.location}
                        </p>
                        
                        <!-- Description -->
                        <p class="text-white/80 text-sm mb-4 line-clamp-2">
                            ${business.description}
                        </p>
                        
                        <!-- Services -->
                        <div class="mb-4">
                            <p class="text-white text-sm font-medium mb-2">Services:</p>
                            <div class="flex flex-wrap gap-2">
                                ${business.services.slice(0, 3).map(service => 
                                    `<span class="px-3 py-1 rounded-full text-xs bg-white/10 text-white/80 border border-white/20">${service}</span>`
                                ).join('')}
                                ${business.services.length > 3 ? `<span class="px-3 py-1 rounded-full text-xs bg-white/10 text-white/80 border border-white/20">+${business.services.length - 3} more</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <button onclick="goToBusinessProfile('${businessSlug}')" 
                                class="flex-1 py-3 px-4 rounded-2xl gold-gradient text-black font-bold text-sm hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-calendar-plus mr-2"></i>Book Now
                        </button>
                        <button onclick="callBusiness('${business.phone}')" 
                                class="px-4 py-3 rounded-2xl border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 hover:scale-105 transition-all duration-300">
                            <i class="fas fa-phone text-sm"></i>
                        </button>
                        <button onclick="emailBusiness('${business.email}')" 
                                class="px-4 py-3 rounded-2xl border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 hover:scale-105 transition-all duration-300">
                            <i class="fas fa-envelope text-sm"></i>
                        </button>
                        <button onclick="shareBusiness('${business.id}', '${business.name}', '${business.address || business.location}', '${business.phone}', '${business.email}')" 
                                class="px-4 py-3 rounded-2xl border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 hover:scale-105 transition-all duration-300">
                            <i class="fas fa-share text-sm"></i>
                        </button>
                    </div>
                </div>
                `;
            }
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredBusinesses.length / businessesPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<div class="flex items-center space-x-3">';
            
            // Previous button
            paginationHTML += `
                <button onclick="goToPage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}
                        class="px-4 py-3 rounded-xl border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 hover:shadow-lg hover:shadow-gold/20">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button onclick="goToPage(${i})" 
                            class="px-4 py-3 rounded-xl border transition-all duration-300 hover:shadow-lg hover:shadow-gold/20 ${
                                i === currentPage 
                                    ? 'gold-gradient text-black border-gold shadow-lg shadow-gold/30' 
                                    : 'border-white/20 text-white hover:bg-white/10 hover:border-gold/50'
                            }">
                        ${i}
                    </button>
                `;
            }
            
            // Next button
            paginationHTML += `
                <button onclick="goToPage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}
                        class="px-4 py-3 rounded-xl border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 hover:shadow-lg hover:shadow-gold/20">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationHTML += '</div>';
            paginationContainer.innerHTML = paginationHTML;
        }

        // Go to page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredBusinesses.length / businessesPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayResults();
                
                // Scroll to top of results
                document.getElementById('business-list').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        // Toggle filters panel
        function toggleFilters() {
            const filtersPanel = document.getElementById('filtersPanel');
            filtersPanel.classList.toggle('hidden');
        }

        // Clear all filters
        function clearFilters() {
            // Reset form inputs
            const businessSearch = document.getElementById('businessSearch');
            const locationSearch = document.getElementById('locationSearch');
            
            if (businessSearch) businessSearch.value = '';
            if (locationSearch) locationSearch.value = '';
            
            // Reset advanced filters if they exist
            const ratingFilter = document.getElementById('ratingFilter');
            const distanceFilter = document.getElementById('distanceFilter');
            const priceFilter = document.getElementById('priceFilter');
            
            if (ratingFilter) ratingFilter.value = '';
            if (distanceFilter) distanceFilter.value = '5';
            if (priceFilter) priceFilter.value = '';
            
            // Reset dropdown filters
            const sortSelect = document.getElementById('sortSelect');
            const categoryFilter = document.getElementById('categoryFilter');
            const locationFilter = document.getElementById('locationFilter');
            const sortByFilter = document.getElementById('sortByFilter');
            
            if (sortSelect) sortSelect.value = 'relevance';
            if (categoryFilter) categoryFilter.value = '';
            if (locationFilter) locationFilter.value = '';
            if (sortByFilter) sortByFilter.value = 'relevance';
            
            // Reset filters
            currentFilters = {
                search: '',
                location: '',
                category: '',
                rating: '',
                distance: '5',
                price: '',
                sortBy: 'relevance'
            };
            
            // Reset results
            filteredBusinesses = [...allBusinesses];
            currentPage = 1;
            displayResults();
        }

        // Hide loading state
        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // View business details
        function viewBusiness(businessId) {
            const business = allBusinesses.find(b => b.id === businessId);
            if (business) {
                // Redirect to business profile page
                window.location.href = `business-profile.html?business=${businessId}`;
            }
        }

        function goToBusinessProfile(businessSlug) {
            // Redirect to business profile page where customers can add services
            window.location.href = `business-profile-page.html?business=${businessSlug}`;
        }

        // Call business
        function callBusiness(phoneNumber) {
            window.open(`tel:${phoneNumber}`, '_self');
        }

        // Email business
        function emailBusiness(emailAddress) {
            window.open(`mailto:${emailAddress}`, '_self');
        }

        // Share business
        function shareBusiness(businessId, businessName, address, phone, email) {
            const shareText = `Check out ${businessName} on BlkPages! ${address ? `Located at ${address}.` : ''} ${phone ? `Call: ${phone}` : ''} ${email ? `Email: ${email}` : ''} Find more details and book services at: ${window.location.origin}/business/${businessId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `${businessName} - BlkPages`,
                    text: shareText,
                    url: `${window.location.origin}/business/${businessId}`
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }

        // Fallback share function for browsers that don't support Web Share API
        function fallbackShare(shareText) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showShareSuccess();
                }).catch(() => {
                    showShareModal(shareText);
                });
            } else {
                showShareModal(shareText);
            }
        }

        // Show share success message
        function showShareSuccess() {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            toast.innerHTML = '<i class="fas fa-check mr-2"></i>Business details copied to clipboard!';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Show share modal for manual copying
        function showShareModal(shareText) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <h3 class="text-lg font-bold mb-4">Share Business</h3>
                    <p class="text-gray-600 mb-4">Copy the text below to share this business:</p>
                    <textarea class="w-full p-3 border rounded-lg mb-4" rows="4" readonly>${shareText}</textarea>
                    <div class="flex space-x-3">
                        <button onclick="copyToClipboard('${shareText.replace(/'/g, "\\'")}')" 
                                class="flex-1 bg-gold text-black py-2 px-4 rounded-lg font-semibold hover:bg-gold-dark transition-colors">
                            Copy Text
                        </button>
                        <button onclick="closeShareModal()" 
                                class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showShareSuccess();
                closeShareModal();
            });
        }

        // Close share modal
        function closeShareModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        }

        // Daily refresh functionality for business tiers
        async function refreshBusinessTiers() {
            try {
                console.log('Starting daily business tier refresh...');
                
                // Get all businesses from the demo data (in real app, this would be from database)
                const businesses = getDemoBusinesses();
                let updatedCount = 0;

                for (const biz of businesses) {
                    let needsUpdate = false;
                    const originalBiz = { ...biz };

                    // Handle Featured expiry
                    if (biz.featuredActive && biz.featuredExpiry && new Date() > new Date(biz.featuredExpiry)) {
                        biz.featuredActive = false;
                        biz.featuredExpiry = null;
                        needsUpdate = true;
                        console.log(`Featured status expired for ${biz.name}`);
                    }

                    // Check if payment status or tier changed today
                    const latestPlan = await getCurrentPlanFromPayments(biz.id);

                    // Sync tier if changed
                    if (latestPlan.tier !== biz.tier) {
                        biz.tier = latestPlan.tier;
                        biz.subscription = latestPlan.tier; // Keep subscription in sync
                        needsUpdate = true;
                        console.log(`Tier updated for ${biz.name}: ${originalBiz.tier} -> ${biz.tier}`);
                    }

                    // Update Featured Add-on
                    if (latestPlan.featuredActive !== biz.featuredActive) {
                        biz.featuredActive = latestPlan.featuredActive;
                        biz.featuredExpiry = latestPlan.featuredExpiry;
                        needsUpdate = true;
                        console.log(`Featured status updated for ${biz.name}: ${biz.featuredActive}`);
                    }

                    // In a real app, you would update the database here
                    // await db.update('businesses', biz.id, biz);
                    
                    if (needsUpdate) {
                        updatedCount++;
                        // Update the business in our demo data
                        updateBusinessInDemoData(biz);
                    }
                }

                console.log(`Daily refresh completed. Updated ${updatedCount} businesses.`);

                // After syncing, trigger resort
                regenerateSearchOrder();
                
                return { success: true, updatedCount };
            } catch (error) {
                console.error('Error during daily refresh:', error);
                return { success: false, error: error.message };
            }
        }

        // Mock function to get current plan from payments (in real app, this would query payment system)
        async function getCurrentPlanFromPayments(businessId) {
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 10));
            
            // Mock payment data - in real app, this would come from your payment processor
            const mockPaymentData = {
                'demo_1': { 
                    tier: 'professional', 
                    nextTier: null,
                    featuredActive: true, 
                    featuredNext: true,
                    featuredCancelled: false,
                    featuredExpiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                    billingCycleEnd: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000)
                },
                'demo_2': { 
                    tier: 'starter', 
                    nextTier: 'professional',
                    featuredActive: false, 
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 20 * 24 * 60 * 60 * 1000)
                },
                'demo_3': { 
                    tier: 'professional', 
                    nextTier: null,
                    featuredActive: true, 
                    featuredNext: false,
                    featuredCancelled: true,
                    featuredExpiry: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000),
                    billingCycleEnd: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000)
                },
                'demo_4': { 
                    tier: 'free', 
                    nextTier: 'starter',
                    featuredActive: false, 
                    featuredNext: true,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 25 * 24 * 60 * 60 * 1000)
                },
                'demo_5': { 
                    tier: 'starter', 
                    nextTier: null,
                    featuredActive: false, 
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000)
                },
                'demo_6': { 
                    tier: 'professional', 
                    nextTier: null,
                    featuredActive: false, 
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 12 * 24 * 60 * 60 * 1000)
                },
                'demo_7': { 
                    tier: 'free', 
                    nextTier: null,
                    featuredActive: false, 
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 18 * 24 * 60 * 60 * 1000)
                },
                'demo_8': { 
                    tier: 'starter', 
                    nextTier: null,
                    featuredActive: true, 
                    featuredNext: true,
                    featuredCancelled: false,
                    featuredExpiry: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000),
                    billingCycleEnd: new Date(Date.now() + 8 * 24 * 60 * 60 * 1000)
                },
                'demo_9': { 
                    tier: 'professional', 
                    nextTier: null,
                    featuredActive: false, 
                    featuredNext: false,
                    featuredCancelled: false,
                    featuredExpiry: null,
                    billingCycleEnd: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
                }
            };

            return mockPaymentData[businessId] || { tier: 'free', featuredActive: false, featuredExpiry: null };
        }

        // Update business in demo data (in real app, this would be handled by database updates)
        function updateBusinessInDemoData(updatedBusiness) {
            // Find and update the business in the demo data
            const businessIndex = allBusinesses.findIndex(biz => biz.id === updatedBusiness.id);
            if (businessIndex !== -1) {
                allBusinesses[businessIndex] = { ...allBusinesses[businessIndex], ...updatedBusiness };
            }
        }

        // Tier priority system
        const tierPriority = { featured: 1, professional: 2, starter: 3, free: 4 };

        // Regenerate search order with tier-based priority and seeded shuffling
        function regenerateSearchOrder() {
            try {
                console.log('Regenerating search order with tier priority...');
                
                const todaySeed = new Date().toISOString().split('T')[0]; // changes daily
                const seed = todaySeed.split('').reduce((a, c) => a + c.charCodeAt(0), 0);

                function seededShuffle(arr, seed) {
                    const copy = [...arr];
                    let random = seed;
                    for (let i = copy.length - 1; i > 0; i--) {
                        random = (random * 9301 + 49297) % 233280;
                        const j = Math.floor((random / 233280) * (i + 1));
                        [copy[i], copy[j]] = [copy[j], copy[i]];
                    }
                    return copy;
                }

                // Get all businesses (in real app, this would be from database)
                const businesses = getDemoBusinesses();
                
                // Group businesses by tier and shuffle within each tier
                const grouped = Object.keys(tierPriority).map(tier =>
                    seededShuffle(
                        businesses.filter(b =>
                            b.featuredActive ? tier === 'featured' : b.tier === tier
                        ),
                        seed
                    )
                );

                // Flatten into final sorted order
                const sorted = grouped.flat();
                
                // Update the global businesses array with new order
                allBusinesses = sorted;
                
                // Cache the sorted businesses (in real app, this would be database cache)
                localStorage.setItem('sortedBusinesses', JSON.stringify(sorted));
                
                // Reload featured businesses
                loadFeaturedBusinesses();
                
                // Reapply current filters and sorting
                applyFilters();
                
                console.log(`Search order regenerated successfully. ${sorted.length} businesses sorted by tier priority.`);
            } catch (error) {
                console.error('Error regenerating search order:', error);
            }
        }

        // Apply monthly plan updates when billing cycles end
        async function applyMonthlyPlanUpdates() {
            try {
                console.log('Starting monthly plan updates...');
                
                const today = new Date();
                const businesses = getDemoBusinesses();
                let updatedCount = 0;

                for (const biz of businesses) {
                    if (today >= new Date(biz.billingCycleEnd)) {
                        console.log(`Billing cycle ended for ${biz.name}, applying updates...`);
                        
                        let hasChanges = false;
                        const originalTier = biz.tier;
                        const originalFeatured = biz.featuredActive;

                        // Apply pending tier change if any
                        if (biz.nextTier) {
                            biz.tier = biz.nextTier;
                            biz.subscription = biz.nextTier; // Keep subscription in sync
                            biz.nextTier = null;
                            hasChanges = true;
                            console.log(`Applied tier change: ${originalTier} → ${biz.tier}`);
                        }

                        // Apply featured add-on change
                        if (typeof biz.featuredNext === 'boolean') {
                            biz.featuredActive = biz.featuredNext;
                            biz.featuredNext = null;
                            hasChanges = true;
                            console.log(`Applied featured change: ${originalFeatured} → ${biz.featuredActive}`);
                        }

                        // Renew billing period
                        biz.billingCycleEnd = getNextMonthEndDate(today);
                        hasChanges = true;

                        if (hasChanges) {
                            // In real app, this would update the database
                            // await db.update('businesses', biz.id, biz);
                            
                            // Update in our demo data
                            updateBusinessInDemoData(biz);
                            updatedCount++;
                            
                            console.log(`Updated ${biz.name} - New billing cycle: ${biz.billingCycleEnd.toDateString()}`);
                        }
                    }
                }

                console.log(`Monthly plan updates completed. Updated ${updatedCount} businesses.`);

                // Regenerate search order after updates
                regenerateSearchOrder();
                
                return { success: true, updatedCount };
            } catch (error) {
                console.error('Error during monthly plan updates:', error);
                return { success: false, error: error.message };
            }
        }

        // Helper function to get next month end date
        function getNextMonthEndDate(currentDate) {
            const nextMonth = new Date(currentDate);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            nextMonth.setDate(0); // Last day of next month
            nextMonth.setHours(23, 59, 59, 999); // End of day
            return nextMonth;
        }

        // Schedule daily refresh (runs once per day)
        function scheduleDailyRefresh() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(2, 0, 0, 0); // Run at 2 AM daily
            
            const timeUntilRefresh = tomorrow.getTime() - now.getTime();
            
            console.log(`Daily refresh scheduled for ${tomorrow.toLocaleString()}`);
            
            setTimeout(() => {
                refreshBusinessTiers();
                // Also check for monthly plan updates
                applyMonthlyPlanUpdates();
                // Schedule the next refresh
                scheduleDailyRefresh();
            }, timeUntilRefresh);
        }

        // Dashboard change handler - stores future changes as "next" values
        async function onDashboardChange(businessId, newData) {
            try {
                console.log(`Dashboard change received for business ${businessId}:`, newData);
                
                // In real app, this would get from database
                const biz = getDemoBusinesses().find(b => b.id === businessId);
                if (!biz) {
                    console.error(`Business ${businessId} not found`);
                    return { success: false, error: 'Business not found' };
                }

                // Store current choices as "next" values (changes take effect next billing cycle)
                const originalNextTier = biz.nextTier;
                const originalFeaturedNext = biz.featuredNext;
                const originalFeaturedCancelled = biz.featuredCancelled;
                
                biz.nextTier = newData.tier;
                biz.featuredNext = newData.featuredAddOnSelected;
                biz.featuredCancelled = newData.featuredCancelled || false;

                // In real app, this would update the database
                // await db.update('businesses', biz.id, biz);
                
                // Update in our demo data
                updateBusinessInDemoData(biz);

                console.log(`Business ${biz.name} future changes scheduled:`, {
                    nextTier: `${originalNextTier} → ${biz.nextTier}`,
                    featuredNext: `${originalFeaturedNext} → ${biz.featuredNext}`,
                    featuredCancelled: `${originalFeaturedCancelled} → ${biz.featuredCancelled}`
                });

                // Show success notification for scheduled changes
                showScheduledChangeNotification(biz.name, newData);
                
                return { success: true, business: biz };
            } catch (error) {
                console.error('Error in dashboard change:', error);
                return { success: false, error: error.message };
            }
        }

        // Dashboard update handler - triggered after payment or immediate update
        async function onDashboardUpdate(businessId, newPlanData) {
            try {
                console.log(`Dashboard update received for business ${businessId}:`, newPlanData);
                
                // In real app, this would get from database
                const biz = getDemoBusinesses().find(b => b.id === businessId);
                if (!biz) {
                    console.error(`Business ${businessId} not found`);
                    return { success: false, error: 'Business not found' };
                }

                // Update tier and add-on immediately
                const originalTier = biz.tier;
                const originalFeatured = biz.featuredActive;
                
                biz.tier = newPlanData.tier;
                biz.subscription = newPlanData.tier; // Keep subscription in sync
                biz.nextTier = newPlanData.nextTier || null;
                biz.featuredActive = newPlanData.featuredActive;
                biz.featuredNext = newPlanData.featuredNext || false;
                biz.featuredCancelled = newPlanData.featuredCancelled || false;
                biz.featuredExpiry = newPlanData.featuredExpiry;
                biz.billingCycleEnd = newPlanData.billingCycleEnd;

                // In real app, this would update the database
                // await db.update('businesses', businessId, biz);
                
                // Update in our demo data
                updateBusinessInDemoData(biz);

                console.log(`Business ${biz.name} updated immediately:`, {
                    tier: `${originalTier} → ${biz.tier}`,
                    featured: `${originalFeatured} → ${biz.featuredActive}`,
                    expiry: biz.featuredExpiry
                });

                // Immediately refresh sort cache
                regenerateSearchOrder();
                
                // Show success notification
                showUpdateNotification(biz.name, newPlanData);
                
                return { success: true, business: biz };
            } catch (error) {
                console.error('Error in dashboard update:', error);
                return { success: false, error: error.message };
            }
        }

        // Show update notification
        function showUpdateNotification(businessName, newPlanData) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            
            let message = `Business plan updated for ${businessName}`;
            if (newPlanData.featuredActive) {
                message += ` - Now featured!`;
            }
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Show scheduled change notification
        function showScheduledChangeNotification(businessName, newData) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            
            let message = `Changes scheduled for ${businessName}`;
            if (newData.featuredAddOnSelected) {
                message += ` - Featured add-on will be added next billing cycle`;
            } else if (newData.featuredCancelled) {
                message += ` - Featured add-on will be removed next billing cycle`;
            } else {
                message += ` - Plan changes will take effect next billing cycle`;
            }
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Simulate dashboard update (for demo purposes)
        function simulateDashboardUpdate(businessId, newPlanData) {
            console.log('Simulating dashboard update...');
            onDashboardUpdate(businessId, newPlanData);
        }

        // Simulate dashboard change (for demo purposes)
        function simulateDashboardChange(businessId, newData) {
            console.log('Simulating dashboard change...');
            onDashboardChange(businessId, newData);
        }

        // Simulate monthly plan updates (for demo purposes)
        function simulateMonthlyUpdates() {
            console.log('Simulating monthly plan updates...');
            applyMonthlyPlanUpdates();
        }

        // Generate billing status display for a business
        function generateBillingStatus(business) {
            const currentTier = business.tier || 'free';
            const nextTier = business.nextTier;
            const featuredActive = business.featuredActive;
            const featuredNext = business.featuredNext;
            const featuredCancelled = business.featuredCancelled;
            const billingCycleEnd = business.billingCycleEnd;

            // Format billing cycle end date
            const nextBillingDate = billingCycleEnd ? new Date(billingCycleEnd).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            }) : 'Unknown';

            // Determine featured status
            let featuredStatus = '';
            if (featuredActive && !featuredCancelled) {
                featuredStatus = 'Active (auto-renews monthly)';
            } else if (featuredNext && !featuredCancelled) {
                featuredStatus = `Will activate ${nextBillingDate}`;
            } else if (featuredCancelled) {
                featuredStatus = `Will deactivate ${nextBillingDate}`;
            } else {
                featuredStatus = 'Inactive';
            }

            // Determine next plan status
            let nextPlanStatus = '';
            if (nextTier && nextTier !== currentTier) {
                nextPlanStatus = `${nextTier.charAt(0).toUpperCase() + nextTier.slice(1)} (takes effect ${nextBillingDate})`;
            } else {
                nextPlanStatus = 'No changes scheduled';
            }

            return `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-lg font-semibold text-white mb-3">Billing Status</h3>
                    <div class="space-y-2">
                        <p class="text-white">Current Plan: <span class="font-medium text-yellow-400">${currentTier.charAt(0).toUpperCase() + currentTier.slice(1)}</span></p>
                        <p class="text-white">Next Plan: <span class="font-medium text-blue-400">${nextPlanStatus}</span></p>
                        <p class="text-white">Featured Add-On: <span class="font-medium ${featuredActive && !featuredCancelled ? 'text-green-400' : featuredNext ? 'text-blue-400' : featuredCancelled ? 'text-red-400' : 'text-gray-400'}">${featuredStatus}</span></p>
                        <p class="text-gray-400 text-xs">Changes will apply from your next billing cycle.</p>
                    </div>
                </div>
            `;
        }

        // Show billing status modal for a business
        function showBillingStatus(businessId) {
            const business = getDemoBusinesses().find(b => b.id === businessId);
            if (!business) {
                console.error(`Business ${businessId} not found`);
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-6 max-w-md mx-4 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">${business.name}</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    ${generateBillingStatus(business)}
                    <div class="mt-4 flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize daily refresh on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we need to run refresh (for demo purposes, run immediately)
            // In production, you might want to check last refresh time
            const lastRefresh = localStorage.getItem('lastBusinessRefresh');
            const today = new Date().toDateString();
            
            if (!lastRefresh || lastRefresh !== today) {
                console.log('Running daily refresh check...');
                refreshBusinessTiers().then(result => {
                    if (result.success) {
                        localStorage.setItem('lastBusinessRefresh', today);
                    }
                });
            }
            
            // Schedule future refreshes
            scheduleDailyRefresh();
            
            // Add demo buttons for testing dashboard updates (remove in production)
            addDemoUpdateButtons();
        });

        // Add demo buttons for testing (remove in production)
        function addDemoUpdateButtons() {
            // Only add demo buttons if we're in development mode
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const demoPanel = document.createElement('div');
                demoPanel.className = 'fixed bottom-4 left-4 bg-gray-800 text-white p-4 rounded-lg shadow-lg z-50';
                demoPanel.innerHTML = `
                    <h3 class="text-sm font-bold mb-2">Demo: Dashboard Changes</h3>
                    <div class="space-y-2">
                        <div class="text-xs text-gray-400 mb-2">Immediate Updates:</div>
                        <button onclick="simulateDashboardUpdate('demo_4', {tier: 'professional', nextTier: null, featuredActive: true, featuredNext: true, featuredCancelled: false, featuredExpiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), billingCycleEnd: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000)})" 
                                class="block w-full text-xs bg-blue-500 hover:bg-blue-600 px-2 py-1 rounded">
                            Upgrade Style Studio (Immediate)
                        </button>
                        <button onclick="simulateDashboardUpdate('demo_1', {tier: 'professional', nextTier: null, featuredActive: false, featuredNext: false, featuredCancelled: true, featuredExpiry: null, billingCycleEnd: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000)})" 
                                class="block w-full text-xs bg-red-500 hover:bg-red-600 px-2 py-1 rounded">
                            Cancel Royal Hair Featured (Immediate)
                        </button>
                        
                        <div class="text-xs text-gray-400 mb-2 mt-3">Scheduled Changes:</div>
                        <button onclick="simulateDashboardChange('demo_5', {tier: 'professional', featuredAddOnSelected: true, featuredCancelled: false})" 
                                class="block w-full text-xs bg-green-500 hover:bg-green-600 px-2 py-1 rounded">
                            Schedule Classic Cuts → Professional + Featured
                        </button>
                        <button onclick="simulateDashboardChange('demo_2', {tier: 'free', featuredAddOnSelected: false, featuredCancelled: true})" 
                                class="block w-full text-xs bg-orange-500 hover:bg-orange-600 px-2 py-1 rounded">
                            Schedule Elite Barber → Free (Cancel Featured)
                        </button>
                        
                        <div class="text-xs text-gray-400 mb-2 mt-3">Monthly Updates:</div>
                        <button onclick="simulateMonthlyUpdates()" 
                                class="block w-full text-xs bg-purple-500 hover:bg-purple-600 px-2 py-1 rounded">
                            Apply Monthly Plan Updates
                        </button>
                        
                        <div class="text-xs text-gray-400 mb-2 mt-3">Billing Status:</div>
                        <button onclick="showBillingStatus('demo_1')" 
                                class="block w-full text-xs bg-indigo-500 hover:bg-indigo-600 px-2 py-1 rounded">
                            View Royal Hair Status
                        </button>
                        <button onclick="showBillingStatus('demo_2')" 
                                class="block w-full text-xs bg-indigo-500 hover:bg-indigo-600 px-2 py-1 rounded">
                            View Elite Barber Status
                        </button>
                        <button onclick="showBillingStatus('demo_5')" 
                                class="block w-full text-xs bg-indigo-500 hover:bg-indigo-600 px-2 py-1 rounded">
                            View Classic Cuts Status
                        </button>
                    </div>
                `;
                document.body.appendChild(demoPanel);
            }
        }

    </script>
</body>
</html>