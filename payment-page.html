<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - BlkPages</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Booking Encryption Utility -->
    <script src="js/booking-encryption.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif']
                    },
                    colors: {
                        'charcoal': '#121212',
                        'dark-grey': '#1A1A1A',
                        'light-grey': '#CCCCCC',
                        'gold': '#D4AF37',
                        'gold-dark': '#B8860B',
                        'neon-pink': '#FF3CAC',
                        'neon-blue': '#2B86C5',
                        'neon-green': '#4ADE80',
                        'neon-purple': '#784BA0'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'pulse-subtle': 'pulseSubtle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(212, 175, 55, 0.2)' },
                            '100%': { boxShadow: '0 0 30px rgba(212, 175, 55, 0.4)' }
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%, #000000 100%);
        }
        
        .card-gradient {
            background: linear-gradient(145deg, 
                rgba(26,26,26,0.95) 0%, 
                rgba(42,42,42,0.9) 50%, 
                rgba(26,26,26,0.95) 100%);
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 50%, #D4AF37 100%);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3), 
                        0 0 40px rgba(212, 175, 55, 0.2), 
                        0 0 60px rgba(212, 175, 55, 0.1);
        }
        
        .text-glow {
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .border-glow {
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }
        
        /* Header backdrop blur effect */
        .header-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Payment form styles */
        .payment-input {
            transition: all 0.3s ease;
        }
        
        .payment-input:focus {
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1), 0 0 20px rgba(212, 175, 55, 0.25);
        }
        
        .card-icon {
            transition: all 0.3s ease;
        }
        
        .card-icon.active {
            color: #D4AF37;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.25);
        }
        
        /* Loading spinner */
        .spinner {
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-top: 2px solid #D4AF37;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Success animation */
        .success-checkmark {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #D4AF37;
            stroke-miterlimit: 10;
            margin: 0 auto;
            box-shadow: inset 0px 0px 0px #D4AF37;
            animation: fill 0.4s ease-in-out 0.4s forwards, scale 0.3s ease-in-out 0.9s both;
        }
        
        .success-checkmark circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #D4AF37;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        
        .success-checkmark path {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        
        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        
        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px #D4AF37;
            }
        }
    </style>
</head>
<body class="bg-black text-white font-inter">
    <!-- Fixed Header -->
    <header class="fixed top-0 w-full z-50 bg-black header-blur border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-white hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)]">
                        BlkPages
                    </a>
                </div>
                
                <!-- Navigation Links -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="search-results-new.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Browse
                    </a>
                    <a href="offers.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Offers
                    </a>
                    <a href="business-register.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Add Business
                    </a>
                    <a href="customer-login.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Sign In
                    </a>
                    <a href="customer-dashboard.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)]">
                        <i class="fas fa-user-circle text-xl"></i>
                    </a>
                    <a href="#" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] relative">
                        <i class="fas fa-shopping-basket text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-gold text-black text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">3</span>
                    </a>
                </nav>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-white/60 hover:text-gold transition-all duration-300">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden hidden bg-black/95 header-blur border-t border-white/10">
                <div class="px-4 py-4 space-y-4">
                    <a href="search-results-new.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Browse</a>
                    <a href="offers.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Offers</a>
                    <a href="business-register.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Add Business</a>
                    <a href="customer-login.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Sign In</a>
                    <a href="customer-dashboard.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Profile</a>
                    <a href="#" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Basket (3)</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <div class="fixed top-16 w-full z-40 bg-black/80 header-blur border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center text-sm font-bold">1</div>
                    <span class="text-white/60">Review</span>
                </div>
                <div class="w-12 h-0.5 bg-gold"></div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-gold text-black flex items-center justify-center text-sm font-bold">2</div>
                    <span class="text-gold font-medium">Payment</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-32 pb-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Complete Your Payment</h1>
                <p class="text-light-grey">Secure payment processing powered by Stripe</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Payment Form -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Payment Method Selection -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-credit-card mr-3 text-gold"></i>
                            Payment Method
                        </h2>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="card-icon bg-dark-grey/50 rounded-xl p-4 border border-white/10 cursor-pointer text-center hover:border-gold/50 transition-all duration-300 active" data-method="visa">
                                <i class="fab fa-cc-visa text-2xl text-white"></i>
                            </div>
                            <div class="card-icon bg-dark-grey/50 rounded-xl p-4 border border-white/10 cursor-pointer text-center hover:border-gold/50 transition-all duration-300" data-method="mastercard">
                                <i class="fab fa-cc-mastercard text-2xl text-white"></i>
                            </div>
                            <div class="card-icon bg-dark-grey/50 rounded-xl p-4 border border-white/10 cursor-pointer text-center hover:border-gold/50 transition-all duration-300" data-method="amex">
                                <i class="fab fa-cc-amex text-2xl text-white"></i>
                            </div>
                            <div class="card-icon bg-dark-grey/50 rounded-xl p-4 border border-white/10 cursor-pointer text-center hover:border-gold/50 transition-all duration-300" data-method="paypal">
                                <i class="fab fa-cc-paypal text-2xl text-white"></i>
                            </div>
                        </div>
                        
                        <!-- Card Details Form -->
                        <div id="cardForm" class="space-y-4">
                            <div>
                                <label class="block text-white font-medium mb-2">Card Number</label>
                                <div class="relative">
                                    <input type="text" id="cardNumber" 
                                           class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                           placeholder="1234 5678 9012 3456" maxlength="19" required>
                                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                        <i class="fab fa-cc-visa text-gold text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-white font-medium mb-2">Expiry Date</label>
                                    <input type="text" id="expiryDate" 
                                           class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                           placeholder="MM/YY" maxlength="5" required>
                                </div>
                                <div>
                                    <label class="block text-white font-medium mb-2">CVV</label>
                                    <input type="text" id="cvv" 
                                           class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                           placeholder="123" maxlength="4" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-white font-medium mb-2">Cardholder Name</label>
                                <input type="text" id="cardholderName" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                       placeholder="John Doe" required>
                            </div>
                        </div>
                        
                        <!-- PayPal Form (Hidden by default) -->
                        <div id="paypalForm" class="space-y-4 hidden">
                            <div class="text-center py-8">
                                <i class="fab fa-cc-paypal text-6xl text-gold mb-4"></i>
                                <p class="text-light-grey">You will be redirected to PayPal to complete your payment</p>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Address -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-gold"></i>
                            Billing Address
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-white font-medium mb-2">Address Line 1</label>
                                <input type="text" id="addressLine1" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                       placeholder="123 Main Street" required>
                            </div>
                            
                            <div>
                                <label class="block text-white font-medium mb-2">Address Line 2 (Optional)</label>
                                <input type="text" id="addressLine2" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                       placeholder="Apartment, suite, etc.">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-white font-medium mb-2">City</label>
                                    <input type="text" id="city" 
                                           class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                           placeholder="London" required>
                                </div>
                                <div>
                                    <label class="block text-white font-medium mb-2">Postcode</label>
                                    <input type="text" id="postcode" 
                                           class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20"
                                           placeholder="SW1A 1AA" required>
                                </div>
                                <div>
                                    <label class="block text-white font-medium mb-2">Country</label>
                                    <select id="country" 
                                            class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white payment-input focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20">
                                        <option value="GB">United Kingdom</option>
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="AU">Australia</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Notice -->
                    <div class="card-gradient rounded-3xl p-6 border-glow bg-gold/5">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <i class="fas fa-shield-alt text-gold text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-2">Secure Payment</h3>
                                <p class="text-light-grey text-sm">
                                    Your payment information is encrypted and secure. We use industry-standard SSL encryption 
                                    to protect your data and never store your card details on our servers.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Privacy Notice -->
                    <div class="card-gradient rounded-3xl p-6 border-glow bg-gold/5">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <i class="fas fa-lock text-gold text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white mb-2">Privacy Protection</h3>
                                <p class="text-light-grey text-xs italic leading-relaxed">
                                    For your privacy, BlkPages does not share your personal details directly with businesses.  
                                    All bookings are securely managed through the business's BlkPages dashboard.  
                                    Sensitive data such as your name, phone number, and address are encrypted before being sent.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="space-y-6">
                    <!-- Summary Card -->
                    <div class="card-gradient rounded-3xl p-6 border-glow sticky top-24">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-receipt mr-3 text-gold"></i>
                            Order Summary
                        </h2>
                        
                        <div id="orderSummary" class="space-y-4">
                            <!-- Order summary will be populated by JavaScript -->
                        </div>
                        
                        <!-- Special Offer -->
                        <div id="offerSection" class="mt-6 p-4 rounded-xl bg-gold/10 border border-gold/30 hidden">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gold font-medium">First Visit Discount</p>
                                    <p class="text-light-grey text-sm">20% off your first booking</p>
                                </div>
                                <span class="text-gold font-bold" id="discountAmount">-£0</span>
                            </div>
                        </div>
                        
                        <!-- Total -->
                        <div class="mt-6 pt-4 border-t border-white/20">
                            <div class="flex items-center justify-between">
                                <span class="text-xl font-bold text-white">Total</span>
                                <span class="text-2xl font-bold text-gold" id="totalAmount">£0</span>
                            </div>
                        </div>
                        
                        <!-- Pay Button -->
                        <button onclick="processPayment()" 
                                class="w-full mt-6 py-4 rounded-xl gold-gradient text-black font-bold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                id="payBtn">
                            <i class="fas fa-lock mr-2"></i>Pay Securely
                        </button>
                        
                        <!-- Security Badges -->
                        <div class="mt-4 flex items-center justify-center space-x-4 text-xs text-light-grey">
                            <i class="fas fa-shield-alt"></i>
                            <span>SSL Secured</span>
                            <i class="fas fa-lock"></i>
                            <span>256-bit Encryption</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-dark-grey rounded-3xl p-8 max-w-md w-full border border-gold/30 text-center">
                <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="success-checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="success-checkmark-check" fill="none" d="m14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <h3 class="text-2xl font-bold text-white mt-6 mb-4">Payment Successful!</h3>
                <p class="text-light-grey mb-6">Your booking has been confirmed. You will receive a confirmation email shortly.</p>
                <div class="space-y-3">
                    <button onclick="viewBooking()" 
                            class="w-full py-3 rounded-xl gold-gradient text-black font-bold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300">
                        View Booking Details
                    </button>
                    <button onclick="goHome()" 
                            class="w-full py-3 rounded-xl border border-white/20 text-white hover:bg-white/10 hover:border-gold/50 transition-all duration-300">
                        Back to Home
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let bookingData = null;
        let selectedPaymentMethod = 'visa';
        let basketItems = JSON.parse(localStorage.getItem('basketItems') || '[]');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBookingData();
            setupPaymentMethodSelection();
            setupFormValidation();
            setupInputFormatting();
        });

        // Load booking data from localStorage
        function loadBookingData() {
            const stored = localStorage.getItem('bookingData');
            if (stored) {
                bookingData = JSON.parse(stored);
                displayOrderSummary();
            } else {
                // Redirect back to booking if no data
                window.location.href = 'booking-review.html';
            }
        }

        // Display order summary
        function displayOrderSummary() {
            if (!bookingData) return;
            
            const summaryContainer = document.getElementById('orderSummary');
            const totalElement = document.getElementById('totalAmount');
            const discountElement = document.getElementById('discountAmount');
            const offerSection = document.getElementById('offerSection');
            
            let summaryHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white font-medium">${bookingData.service.name}</p>
                        <p class="text-light-grey text-sm">${bookingData.service.duration} minutes</p>
                    </div>
                    <span class="text-gold font-bold">£${bookingData.service.price}</span>
                </div>
            `;
            
            const date = new Date(bookingData.date);
            const formattedDate = date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            summaryHTML += `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white font-medium">Date & Time</p>
                        <p class="text-light-grey text-sm">${formattedDate} at ${bookingData.time}</p>
                    </div>
                </div>
            `;
            
            summaryContainer.innerHTML = summaryHTML;
            
            // Handle payment mode and special offer
            let total = bookingData.service.price;
            let depositInfo = '';
            
            // Check if this is a deposit payment
            if (bookingData.service.payMode === 'deposit') {
                const depositPercent = bookingData.service.depositPercent || 20;
                const depositAmount = bookingData.service.depositAmount || (total * depositPercent / 100);
                const remaining = total - depositAmount;
                
                total = depositAmount;
                depositInfo = `
                    <div class="mt-2 text-center">
                        <p class="text-gray-400 text-sm">Deposit: ${depositPercent}% due now (£${depositAmount.toFixed(2)}). 
                        Balance £${remaining.toFixed(2)} payable at venue.</p>
                    </div>
                `;
            } else if (bookingData.service.payMode === 'venue') {
                total = 0;
                depositInfo = `
                    <div class="mt-2 text-center">
                        <p class="text-gray-400 text-sm">Total Due Now: £0</p>
                        <p class="text-gray-500 text-xs">Balance £${bookingData.service.price} payable at venue</p>
                    </div>
                `;
            }
            
            // Handle special offer
            if (bookingData.business.hasOffer && bookingData.service.payMode !== 'deposit' && bookingData.service.payMode !== 'venue') {
                const discount = Math.round(bookingData.service.price * (bookingData.business.offerDiscount / 100));
                total = bookingData.service.price - discount;
                
                discountElement.textContent = `-£${discount}`;
                offerSection.classList.remove('hidden');
            }
            
            totalElement.textContent = `£${total.toFixed(2)}`;
            
            // Add deposit info if applicable
            if (depositInfo) {
                // Remove existing deposit info if present
                const existingDepositInfo = document.querySelector('.deposit-info');
                if (existingDepositInfo) {
                    existingDepositInfo.remove();
                }
                
                const depositDiv = document.createElement('div');
                depositDiv.className = 'deposit-info';
                depositDiv.innerHTML = depositInfo;
                totalElement.parentElement.appendChild(depositDiv);
            }
        }

        // Setup payment method selection
        function setupPaymentMethodSelection() {
            const paymentMethods = document.querySelectorAll('.card-icon');
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    // Remove active class from all methods
                    paymentMethods.forEach(m => m.classList.remove('active'));
                    
                    // Add active class to selected method
                    this.classList.add('active');
                    
                    selectedPaymentMethod = this.dataset.method;
                    
                    // Show/hide appropriate form
                    const cardForm = document.getElementById('cardForm');
                    const paypalForm = document.getElementById('paypalForm');
                    
                    if (selectedPaymentMethod === 'paypal') {
                        cardForm.classList.add('hidden');
                        paypalForm.classList.remove('hidden');
                    } else {
                        cardForm.classList.remove('hidden');
                        paypalForm.classList.add('hidden');
                    }
                });
            });
        }

        // Setup form validation
        function setupFormValidation() {
            const inputs = ['cardNumber', 'expiryDate', 'cvv', 'cardholderName', 'addressLine1', 'city', 'postcode'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', validateForm);
                }
            });
        }

        // Setup input formatting
        function setupInputFormatting() {
            // Card number formatting
            const cardNumber = document.getElementById('cardNumber');
            cardNumber.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            });
            
            // Expiry date formatting
            const expiryDate = document.getElementById('expiryDate');
            expiryDate.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
            
            // CVV formatting
            const cvv = document.getElementById('cvv');
            cvv.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }

        // Validate form
        function validateForm() {
            const requiredFields = ['cardNumber', 'expiryDate', 'cvv', 'cardholderName', 'addressLine1', 'city', 'postcode'];
            const isComplete = requiredFields.every(fieldId => {
                const field = document.getElementById(fieldId);
                return field && field.value.trim() !== '';
            });
            
            const payBtn = document.getElementById('payBtn');
            payBtn.disabled = !isComplete;
        }

        // Update basket item payment status
        function updateBasketItemPayment(basketItem, paymentMethod) {
            const itemIndex = basketItems.findIndex(item => 
                item.serviceId === basketItem.serviceId && 
                item.businessId === basketItem.businessId &&
                item.date === basketItem.date &&
                item.time === basketItem.time
            );
            
            if (itemIndex !== -1) {
                basketItems[itemIndex].payMode = paymentMethod;
                localStorage.setItem('basketItems', JSON.stringify(basketItems));
            }
        }

        // Process payment
        function processPayment() {
            const payBtn = document.getElementById('payBtn');
            const originalText = payBtn.innerHTML;
            
            // Show loading state
            payBtn.disabled = true;
            payBtn.innerHTML = '<div class="spinner mr-2"></div>Processing...';
            
            // Simulate payment processing
            setTimeout(() => {
                // Show success modal
                document.getElementById('successModal').classList.remove('hidden');
                
                // Reset button
                payBtn.disabled = false;
                payBtn.innerHTML = originalText;
                
                // Update basket item payment status
                if (bookingData && bookingData.basketItem) {
                    updateBasketItemPayment(bookingData.basketItem, selectedPaymentMethod);
                }
                
                // Store booking confirmation
                const confirmationData = {
                    ...bookingData,
                    paymentMethod: selectedPaymentMethod,
                    confirmationNumber: 'BK' + Date.now(),
                    status: 'confirmed',
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('bookingConfirmation', JSON.stringify(confirmationData));
                
            }, 3000);
        }

        // View booking details
        function viewBooking() {
            window.location.href = 'booking-confirmation.html';
        }

        // Go home
        function goHome() {
            window.location.href = 'index.html';
        }

        // Go back to booking review
        function goBack() {
            window.location.href = 'booking-review.html';
        }
    </script>
</body>
</html>
