<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BlkPages Admin — Disputes</title>
<link rel="stylesheet" href="./admin.css"/>
<script defer src="./admin.js"></script>
<script>
async function loadDisputes(){
  const data=await api("/disputes");
  const tb=document.querySelector("tbody");tb.innerHTML="";
  if(!data.length){tb.innerHTML="<tr><td colspan='6'>No active disputes 🎉</td></tr>";return;}
  for(const d of data){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.id}</td>
      <td>${d.customer_email||"—"}</td>
      <td>${d.business_name||"—"}</td>
      <td>£${d.total_amount}</td>
      <td>${d.status}</td>
      <td>
        <button class='btn gold' onclick="resolveDispute('${d.id}')">Resolve</button>
        <button class='btn danger' onclick="refund('${d.id}')">Refund</button>
      </td>`;
    tb.appendChild(tr);
  }
}
async function resolveDispute(id){
  if(!confirm("Mark this dispute as resolved?"))return;
  await api(`/disputes/${id}/resolve`,{method:"POST"});
  await loadDisputes();
}
async function refund(id){
  if(!confirm("Issue refund for this booking? Points will be reversed."))return;
  await api(`/disputes/${id}/refund`,{method:"POST"});
  await loadDisputes();
}
document.addEventListener("DOMContentLoaded",()=>{setActive("nav-disputes");loadDisputes();});
</script>
</head><body>
<div class="wrap">
<aside class="side">
  <div class="brand">🛡️ <span>BlkPages Admin</span></div>
  <nav class="nav">
    <a href="./overview.html">📊 Overview</a>
    <a href="./reviews.html">🧾 Reviews</a>
    <a href="./businesses.html">🏢 Businesses</a>
    <a href="./referrals.html">🎁 Referrals</a>
    <a id="nav-disputes" class="active" href="./disputes.html">⚖️ Disputes</a>
    <a href="./adjustments.html">💎 Adjust Points</a>
    <a id="nav-alerts" href="../admin-alerts.html">🔔 Alerts</a>
  </nav>
</aside>
<div>
    <header><h2>Disputes</h2><div style="display:flex;gap:8px;align-items:center;margin-left:auto"><button id="sendReportsNow" style="background:#FFD700;border:none;color:#111;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer">Send Reports Now</button><div id="sendReportsMsg" style="font-size:12px;color:#FFD700;display:none"></div><div id="demoBadge" style="display:none; padding:6px 10px; border:1px solid rgba(255,215,0,.35); color:#111; background:#FFD700; border-radius:999px; font-weight:700; font-size:12px;">Demo Mode</div></div></header>
<main>
  <table><thead>
    <tr><th>ID</th><th>Customer</th><th>Business</th><th>Amount</th><th>Status</th><th>Actions</th></tr>
  </thead><tbody></tbody></table>
</main>
</div></div>
<script>
  (function(){
    var isDemo = !window.firebaseConfig || !window.firebaseConfig.apiKey || window.firebaseConfig.apiKey === 'your-api-key-here';
    var badge = document.getElementById('demoBadge'); if (badge) badge.style.display = isDemo ? 'inline-block':'none';
    if (!isDemo) return;
    var tb=document.querySelector('tbody'); if (!tb) return; tb.innerHTML='';
    var rows=[
      {id:'#DSP-2003', customer:'jane@ex.com', biz:'Glow Spa', amount:'45.00', status:'open'},
      {id:'#DSP-2002', customer:'mike@ex.com', biz:'Royal Hair', amount:'29.00', status:'open'}
    ];
    rows.forEach(function(d){
      var tr=document.createElement('tr');
      tr.innerHTML = '<td>'+d.id+'</td><td>'+d.customer+'</td><td>'+d.biz+'</td><td>£'+d.amount+'</td><td>'+d.status+'</td>'+
                     '<td><button class="btn gold" disabled>Resolve</button> <button class="btn danger" disabled>Refund</button></td>';
      tb.appendChild(tr);
    });
  })();
</script>
<script>
document.addEventListener('DOMContentLoaded', async function(){
  try{
    if (!window.firebaseConfig || !window.firebaseConfig.apiKey || window.firebaseConfig.apiKey === 'your-api-key-here') return;
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js');
    const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-functions.js');
    const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
    const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');
    const app = initializeApp(window.firebaseConfig);
    const functions = getFunctions(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    var btn = document.getElementById('sendReportsNow');
    var msg = document.getElementById('sendReportsMsg');
    onAuthStateChanged(auth, async (user)=>{
      if (!btn) return;
      if (!user) { btn.disabled = true; btn.textContent = 'Admins Only'; return; }
      try { const s = await getDoc(doc(db,'admins', user.uid)); if (!s.exists()) { btn.disabled = true; btn.textContent = 'Admins Only'; } }
      catch(_) { btn.disabled = true; btn.textContent = 'Admins Only'; }
    });
    if (btn) btn.addEventListener('click', async function(){
      try{ btn.disabled=true; btn.textContent='Sending…'; if (msg){ msg.style.display='none'; msg.textContent=''; }
        const fn = httpsCallable(functions, 'sendReportsNow');
        const res = await fn(); if (msg){ msg.textContent = (res && res.data && res.data.message) || 'Reports sent successfully!'; msg.style.display='inline-block'; }
      }catch(e){ if (msg){ msg.textContent='⚠️ Error sending reports.'; msg.style.display='inline-block'; } }
      finally{ btn.disabled=false; btn.textContent='Send Reports Now'; }
    });
  }catch(_){ }
});
</script>
</body></html>
