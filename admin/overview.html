<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BlkPages Admin ‚Äî Overview</title>
<link rel="stylesheet" href="./admin.css"/>
<script defer src="./admin.js"></script>
<script type="module" src="./live-dashboard.js"></script>
<script type="module" src="./overview-live.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>window.DEMO_CHARTS = true;</script>
<style>
.alerts-panel{position:fixed;bottom:24px;right:24px;top:auto;width:340px;background:#111;color:#fff;border:1px solid #FFD700;border-radius:10px;padding:15px;box-shadow:0 0 15px rgba(255,215,0,0.3);z-index:9999;max-height:60vh;overflow-y:auto}
.alerts-panel h3{margin:0 0 10px;color:#ffd700}
.alerts-panel ul{list-style:none;padding:0;margin:0}
.alerts-panel #filterControls{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:10px;font-size:13px}
.alert-item{background:rgba(255,255,255,0.05);border-left:3px solid #FFD700;margin-bottom:10px;padding:10px;font-size:14px;border-radius:6px;animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@media (max-width: 900px){
  .alerts-panel{left:16px;right:16px;bottom:16px;width:auto;max-height:50vh}
}
</style>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  setActive("nav-overview");
  const stat = await api("/overview");
  document.getElementById("revCount").textContent = stat.pending_reviews;
  document.getElementById("bizCount").textContent = stat.pending_businesses;
  document.getElementById("disputeCount").textContent = stat.disputes;
});
</script>
</head><body>
<div class="wrap">
  <aside class="side">
    <div class="brand">üõ°Ô∏è <span>BlkPages Admin</span></div>
    <nav class="nav">
      <a id="nav-overview" href="./overview.html" class="active">üìä Overview</a>
      <a id="nav-users" href="./users.html">üë§ Users</a>
      <a id="nav-reviews" href="./reviews.html">üßæ Reviews</a>
      <a id="nav-businesses" href="./businesses.html">üè¢ Businesses</a>
      <a id="nav-finances" href="./finances.html">üí∑ Finances</a>
      <a id="nav-referrals" href="./referrals.html">üéÅ Referrals</a>
      <a id="nav-disputes" href="./disputes.html">‚öñÔ∏è Disputes</a>
      <a id="nav-adjustments" href="./adjustments.html">üíé Adjust Points</a>
        <a id="nav-alerts" href="../admin-alerts.html">üîî Alerts</a>
    </nav>
  </aside>
  <div>
    <header><h2>Overview</h2><div style="display:flex;gap:8px;align-items:center;margin-left:auto"><button id="sendReportsNow" style="background:#FFD700;border:none;color:#111;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer">Send Reports Now</button><div id="sendReportsMsg" style="font-size:12px;color:#FFD700;display:none"></div><div id="demoBadge" style="display:none; padding:6px 10px; border:1px solid rgba(255,215,0,.35); color:#111; background:#FFD700; border-radius:999px; font-weight:700; font-size:12px;">Demo Mode</div></div></header>
    <main>
      <!-- Summary Metric Cards -->
      <div class="cards" id="summaryCards" style="margin-top:10px">
        <div class="card"><h3>Total Users</h3><div class="stat" id="usersTotal">‚Äî</div></div>
        <div class="card"><h3>Total Businesses</h3><div class="stat" id="bizTotal">‚Äî</div></div>
        <div class="card"><h3>Total Revenue</h3><div class="stat" id="revenueTotal">‚Äî</div></div>
        <div class="card"><h3>Refunds</h3><div class="stat" id="refundsTotal">‚Äî</div></div>
        <div class="card"><h3>Pending Reviews</h3><div class="stat" id="pendingReviewsTotal">‚Äî</div></div>
        <div class="card"><h3>Open Disputes</h3><div class="stat" id="openDisputesTotal">‚Äî</div></div>
        <div class="card"><h3>Unread Alerts</h3><div class="stat" id="unreadAlertsTotal">‚Äî</div></div>
      </div>

      <div class="cards">
        <div class="card"><h3>Pending Reviews</h3><div class="stat" id="revCount">‚Äî</div></div>
        <div class="card"><h3>Pending Businesses</h3><div class="stat" id="bizCount">‚Äî</div></div>
        <div class="card"><h3>Disputes</h3><div class="stat" id="disputeCount">‚Äî</div></div>
      </div>

      <!-- Monthly Revenue (Current Month) -->
      <div class="card" style="padding:16px;margin:10px 0;border:1px solid rgba(255,215,0,.2);background:#0f0f0f">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0 0 10px">
          <h3 style="margin:0;color:#FFD700">Monthly Revenue (Current Month)</h3>
          <span class="note" id="ovMonthWindowNote" style="color:#aaa;font-size:12px"></span>
        </div>
        <div style="display:grid;grid-template-columns:1fr;gap:16px">
          <div>
            <h4 style="margin:0 0 6px;color:#cfcfcf;font-size:13px">Revenue to BlkPages (Packages)</h4>
            <canvas id="ovBlkChart" height="110"></canvas>
          </div>
          <div>
            <h4 style="margin:12px 0 6px;color:#cfcfcf;font-size:13px">Revenue to Businesses (Services)</h4>
            <canvas id="ovBizChart" height="110"></canvas>
          </div>
        </div>
      </div>

      <!-- Live Alerts Panel -->
      <div id="adminAlerts" class="alerts-panel">
        <h3>üîî Live Alerts</h3>
        <div id="filterControls">
          <label><input type="checkbox" id="filterPayments" checked> Payments</label>
          <label><input type="checkbox" id="filterCancellations" checked> Cancellations</label>
          <label><input type="checkbox" id="filterReviews" checked> Reviews</label>
          <label><input type="checkbox" id="filterLoyalty" checked> Loyalty</label>
          <label><input type="checkbox" id="filterBusinesses" checked> Businesses</label>
          <label><input type="checkbox" id="filterCustomers" checked> Customers</label>
          <label><input type="checkbox" id="filterSupport" checked> Support</label>
          <label><input type="checkbox" id="filterFraud" checked> Fraud</label>
        </div>
        <ul id="alertList"></ul>
        <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px">
          <a href="../admin-alerts.html" style="color:#FFD700;font-size:13px;">View All ‚ûú</a>
          <select id="sendDemoType" style="background:#111;color:#fff;border:1px solid #FFD700;border-radius:6px;padding:6px 8px">
            <option value="payments">Payments</option>
            <option value="cancellations">Cancellations</option>
            <option value="reviews">Reviews</option>
            <option value="loyalty">Loyalty</option>
            <option value="businesses">Businesses</option>
            <option value="customers">Customers</option>
            <option value="support">Support</option>
            <option value="fraud">Fraud</option>
          </select>
          <button id="sendDemoAlertBtn" style="background:#FFD700;border:none;color:#111;padding:6px 10px;border-radius:6px;font-weight:700;cursor:pointer;">Send Demo Alert</button>
        </div>
      </div>
    </main>
  </div>
</div>
<script>
  // Demo mode banner and filler data
  (function(){
    var isDemo = !window.firebaseConfig || !window.firebaseConfig.apiKey || window.firebaseConfig.apiKey === 'your-api-key-here';
    var badge = document.getElementById('demoBadge');
    if (badge) badge.style.display = isDemo ? 'inline-block' : 'none';
    if (!isDemo) return;
    var rev=document.getElementById('revCount'); if (rev) rev.textContent='7';
    var biz=document.getElementById('bizCount'); if (biz) biz.textContent='3';
    var dis=document.getElementById('disputeCount'); if (dis) dis.textContent='2';
    // Summary cards demo
    var uT=document.getElementById('usersTotal'); if (uT) uT.textContent='2,481';
    var bT=document.getElementById('bizTotal'); if (bT) bT.textContent='684';
    var rT=document.getElementById('revenueTotal'); if (rT) rT.textContent='¬£386,410';
    var rfT=document.getElementById('refundsTotal'); if (rfT) rfT.textContent='¬£1,240';
    var prT=document.getElementById('pendingReviewsTotal'); if (prT) prT.textContent='7';
    var odT=document.getElementById('openDisputesTotal'); if (odT) odT.textContent='2';
    var uaT=document.getElementById('unreadAlertsTotal'); if (uaT) uaT.textContent='5';
    var wrap=document.getElementById('recentBookings');
    if (wrap){
      wrap.innerHTML='';
      var demoRows=[
        {c:'Jane Smith', a:'35.00', s:'paid', t:new Date()},
        {c:'Michael Brown', a:'52.00', s:'paid', t:new Date(Date.now()-3600*1000)},
        {c:'Emily Johnson', a:'28.00', s:'cancelled', t:new Date(Date.now()-2*3600*1000)}
      ];
      demoRows.forEach(function(r){
        var row=document.createElement('div'); row.className='booking-row';
        row.innerHTML='<div><strong>'+r.c+'</strong></div><div>¬£'+r.a+'</div><div>'+r.s+'</div><div>'+r.t.toLocaleString()+'</div>';
        wrap.appendChild(row);
      });
    }
  })();
  document.addEventListener('DOMContentLoaded', function(){
    // Send Reports Now (callable function)
    (async function(){
      try {
        if (!window.firebaseConfig || !window.firebaseConfig.apiKey || window.firebaseConfig.apiKey === 'your-api-key-here') {
          var btnFallback = document.getElementById('sendReportsNow');
          if (btnFallback) { btnFallback.disabled = true; btnFallback.textContent = 'Admins Only'; }
          return;
        }
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js');
        const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-functions.js');
        const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js');
        const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js');
        const app = initializeApp(window.firebaseConfig);
        const functions = getFunctions(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        var btn = document.getElementById('sendReportsNow');
        var msg = document.getElementById('sendReportsMsg');
        // Role-check: only show enabled button for admins
        onAuthStateChanged(auth, async (user)=>{
          if (!btn) return;
          if (!user) { btn.disabled = true; btn.textContent = 'Admins Only'; return; }
          try {
            const adminSnap = await getDoc(doc(db, 'admins', user.uid));
            if (!adminSnap.exists()) { btn.disabled = true; btn.textContent = 'Admins Only'; }
          } catch(_) { btn.disabled = true; btn.textContent = 'Admins Only'; }
        });
        if (btn) btn.addEventListener('click', async function(){
          try {
            btn.disabled = true; btn.textContent = 'Sending‚Ä¶'; if (msg) { msg.style.display='none'; msg.textContent=''; }
            const fn = httpsCallable(functions, 'sendReportsNow');
            const res = await fn();
            if (msg) { msg.textContent = (res && res.data && res.data.message) || 'Reports sent successfully!'; msg.style.display='inline-block'; }
          } catch (e) {
            if (msg) { msg.textContent = '‚ö†Ô∏è Error sending reports.'; msg.style.display='inline-block'; }
          } finally {
            btn.disabled = false; btn.textContent = 'Send Reports Now';
          }
        });
      } catch(_){}
    })();
    // Fallback: define demo alert helper if module didn't load
    if (!window.sendDemoAdminAlert) {
      window.sendDemoAdminAlert = function(message, typeKey){
        try{
          var map={payments:'filterPayments',cancellations:'filterCancellations',reviews:'filterReviews',loyalty:'filterLoyalty',businesses:'filterBusinesses',customers:'filterCustomers',support:'filterSupport',fraud:'filterFraud'};
          var cbId=map[typeKey]||''; if(cbId){ var cb=document.getElementById(cbId); if(cb && cb.checked===false){ return; } }
        }catch(_e){}
        var panel = document.getElementById('adminAlerts');
        if (!panel) {
          panel = document.createElement('div');
          panel.id = 'adminAlerts';
          panel.className = 'alerts-panel';
          panel.style.position = 'fixed';
          panel.style.bottom = '24px';
          panel.style.right = '24px';
          panel.style.width = '340px';
          panel.style.background = '#111';
          panel.style.color = '#fff';
          panel.style.border = '1px solid #FFD700';
          panel.style.borderRadius = '10px';
          panel.style.padding = '15px';
          panel.style.boxShadow = '0 0 15px rgba(255,215,0,0.3)';
          panel.style.zIndex = '9999';
          panel.innerHTML = '<h3 style="margin:0 0 10px;color:#ffd700">üîî Live Alerts</h3><ul id="alertList" style="list-style:none;padding:0;margin:0"></ul>';
          document.body.appendChild(panel);
        }
        var ul = document.getElementById('alertList');
        var li = document.createElement('li');
        li.className = 'alert-item';
        li.style.background = 'rgba(255,255,255,0.05)';
        li.style.borderLeft = '3px solid #FFD700';
        li.style.marginBottom = '10px';
        li.style.padding = '10px';
        li.style.fontSize = '14px';
        li.style.borderRadius = '6px';
        li.innerHTML = '<div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start"><div style="flex:1;min-width:0">'+(message||'Demo alert')+'</div><div style="display:flex;gap:6px;white-space:nowrap"><button class="mark-read-btn" title="Mark as read" style="background:#2a2a2a;border:1px solid #3a3a3a;color:#ddd;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px">Read</button></div></div>';
        ul.prepend(li);
        var removeLi=function(){ try{ li.remove(); }catch(e){} };
        var m=li.querySelector('.mark-read-btn');
        if(m) m.onclick=removeLi;
        setTimeout(removeLi, 60000);
      }
    }
    const btn = document.getElementById('sendDemoAlertBtn');
    const typeSel = document.getElementById('sendDemoType');
    if (btn) {
      btn.addEventListener('click', function(){
        var type = (typeSel && typeSel.value) || 'payments';
        var templates={
          payments:'üí≥ Demo payment of ¬£12.00 from Test User',
          cancellations:'‚ùå Demo booking cancelled by Royal Hair',
          reviews:'‚≠ê Demo 5‚òÖ review from Aisha',
          loyalty:'üéÅ 100 BlkPoints released for CUST_293',
          businesses:'üè™ New business registered: Royal Hair Studio',
          customers:'üë§ New customer joined: Sarah T.',
          support:'‚ö†Ô∏è New support ticket from Royal Hair ‚Äî ‚ÄúPayment not reflecting‚Äù',
          fraud:'üö® Fraud flag: Possible duplicate referral activity detected'
        };
        window.sendDemoAdminAlert(templates[type]||'Demo alert', type);
      });
    }
  });
</script>
<script type="module" src="./overview-monthly-charts.js"></script>
</body></html>
