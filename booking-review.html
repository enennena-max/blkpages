<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Booking - BlkPages</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'poppins': ['Poppins', 'sans-serif']
                    },
                    colors: {
                        'charcoal': '#121212',
                        'dark-grey': '#1A1A1A',
                        'light-grey': '#CCCCCC',
                        'gold': '#D4AF37',
                        'gold-dark': '#B8860B',
                        'neon-pink': '#FF3CAC',
                        'neon-blue': '#2B86C5',
                        'neon-green': '#4ADE80',
                        'neon-purple': '#784BA0'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'pulse-subtle': 'pulseSubtle 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 20px rgba(212, 175, 55, 0.2)' },
                            '100%': { boxShadow: '0 0 30px rgba(212, 175, 55, 0.4)' }
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%, #000000 100%);
        }
        
        .card-gradient {
            background: linear-gradient(145deg, 
                rgba(26,26,26,0.95) 0%, 
                rgba(42,42,42,0.9) 50%, 
                rgba(26,26,26,0.95) 100%);
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 50%, #D4AF37 100%);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3), 
                        0 0 40px rgba(212, 175, 55, 0.2), 
                        0 0 60px rgba(212, 175, 55, 0.1);
        }
        
        .text-glow {
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        
        .border-glow {
            border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }
        
        /* Header backdrop blur effect */
        .header-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FFD700, #D4AF37);
        }

        /* Service selection styles */
        .service-option {
            transition: all 0.3s ease;
        }
        
        .service-option:hover {
            border-color: rgba(212, 175, 55, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.25);
        }
        
        .service-option.selected {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.25);
        }
        
        .time-slot {
            transition: all 0.3s ease;
        }
        
        .time-slot:hover {
            border-color: rgba(212, 175, 55, 0.5);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.25);
        }
        
        .time-slot.selected {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.25);
        }
        
        .time-slot.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Validation Error Styles */
        .field-error {
            border-color: #D4AF37 !important;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1) !important;
            animation: shake 0.5s ease-in-out;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .validation-banner {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .validation-banner.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Modal animations */
        .modal-overlay {
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
        }
        
        .modal-content {
            transition: all 0.3s ease;
            transform: scale(0.9) translateY(20px);
        }
        
        .modal-content.show {
            transform: scale(1) translateY(0);
        }
    </style>
</head>
<body class="bg-black text-white font-inter">
    <!-- Fixed Header -->
    <header class="fixed top-0 w-full z-50 bg-black header-blur border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-white hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)]">
                        BlkPages
                    </a>
                </div>
                
                <!-- Navigation Links -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="search-results-new.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Browse
                    </a>
                    <a href="offers.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Offers
                    </a>
                    <a href="business-register.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Add Business
                    </a>
                    <a href="customer-login.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] font-medium">
                        Sign In
                    </a>
                    <a href="customer-dashboard.html" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)]">
                        <i class="fas fa-user-circle text-xl"></i>
                    </a>
                    <a href="#" class="text-white/60 hover:text-gold transition-all duration-300 hover:drop-shadow-[0_0_6px_rgba(212,175,55,0.5)] relative">
                        <i class="fas fa-shopping-basket text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-gold text-black text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">3</span>
                    </a>
                </nav>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-white/60 hover:text-gold transition-all duration-300">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="md:hidden hidden bg-black/95 header-blur border-t border-white/10">
                <div class="px-4 py-4 space-y-4">
                    <a href="search-results-new.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Browse</a>
                    <a href="offers.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Offers</a>
                    <a href="business-register.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Add Business</a>
                    <a href="customer-login.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Sign In</a>
                    <a href="customer-dashboard.html" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Profile</a>
                    <a href="#" class="block text-white/60 hover:text-gold transition-all duration-300 font-medium">Basket (3)</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <div class="fixed top-16 w-full z-40 bg-black/80 header-blur border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-gold text-black flex items-center justify-center text-sm font-bold">1</div>
                    <span class="text-gold font-medium">Review</span>
                </div>
                <div class="w-12 h-0.5 bg-white/20"></div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center text-sm font-bold">2</div>
                    <span class="text-white/60">Payment</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-32 pb-8">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">Complete Your Booking</h1>
                <p class="text-light-grey">Review your selection and choose your preferred time slot</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Booking Form -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Business Info -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-building mr-3 text-gold"></i>
                            Business Details
                        </h2>
                        <div id="businessInfo" class="space-y-3">
                            <!-- Business info will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Service Selection -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-cut mr-3 text-gold"></i>
                            Select Service
                        </h2>
                        <div class="space-y-4">
                            <div class="service-option bg-dark-grey/50 rounded-2xl p-4 border border-white/10 cursor-pointer hover:border-gold/50 transition-all duration-300" 
                                 data-service="hair-cut" data-price="35" data-duration="60">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Hair Cut & Style</h3>
                                        <p class="text-light-grey text-sm">Professional cuts and styling for all hair types</p>
                                        <p class="text-gold text-xs font-medium mt-1">Click to add</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-gold font-bold">£35</div>
                                        <div class="text-light-grey text-sm">60 mins</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="service-option bg-dark-grey/50 rounded-2xl p-4 border border-white/10 cursor-pointer hover:border-gold/50 transition-all duration-300" 
                                 data-service="hair-color" data-price="80" data-duration="120">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Hair Coloring</h3>
                                        <p class="text-light-grey text-sm">Full color, highlights, and color correction</p>
                                        <p class="text-gold text-xs font-medium mt-1">Click to add</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-gold font-bold">£80</div>
                                        <div class="text-light-grey text-sm">120 mins</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="service-option bg-dark-grey/50 rounded-2xl p-4 border border-white/10 cursor-pointer hover:border-gold/50 transition-all duration-300" 
                                 data-service="hair-treatment" data-price="45" data-duration="90">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Hair Treatment</h3>
                                        <p class="text-light-grey text-sm">Deep conditioning and repair treatments</p>
                                        <p class="text-gold text-xs font-medium mt-1">Click to add</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-gold font-bold">£45</div>
                                        <div class="text-light-grey text-sm">90 mins</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="service-option bg-dark-grey/50 rounded-2xl p-4 border border-white/10 cursor-pointer hover:border-gold/50 transition-all duration-300" 
                                 data-service="special-occasion" data-price="120" data-duration="180">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Special Occasion</h3>
                                        <p class="text-light-grey text-sm">Wedding and event styling</p>
                                        <p class="text-gold text-xs font-medium mt-1">Click to add</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-gold font-bold">£120</div>
                                        <div class="text-light-grey text-sm">180 mins</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Business Contact Note -->
                        <div id="businessContactNote" class="mt-4 p-4 bg-gold/5 rounded-xl border border-gold/20">
                            <!-- Contact note will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Date & Time Selection -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-calendar-alt mr-3 text-gold"></i>
                            Select Date & Time
                        </h2>
                        
                        <!-- Date Selection -->
                        <div class="mb-6">
                            <label class="block text-white font-medium mb-3">Choose Date</label>
                            <input type="date" id="bookingDate" 
                                   class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                   min="">
                        </div>
                        
                        <!-- Time Slots -->
                        <div>
                            <label class="block text-white font-medium mb-3">Available Times</label>
                            <div id="timeSlots" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <!-- Time slots will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Customer Details -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-user mr-3 text-gold"></i>
                            Your Details
                        </h2>
                        
                        <!-- Validation Banner -->
                        <div id="validationBanner" class="validation-banner">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <span class="font-medium">A few details need your attention :)</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-white font-medium mb-2">First Name</label>
                                <input type="text" id="firstName" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="Enter your first name" required>
                                <div id="firstNameError" class="error-message">Please enter your full name.</div>
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-2">Last Name</label>
                                <input type="text" id="lastName" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="Enter your last name" required>
                                <div id="lastNameError" class="error-message">Please enter your full name.</div>
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-2">Email</label>
                                <input type="email" id="email" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="Enter your email" required>
                                <p class="text-light-grey text-xs mt-1">We'll send your booking confirmation here.</p>
                                <div id="emailError" class="error-message">Please enter a valid email address.</div>
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-2">Contact Number</label>
                                <input type="tel" id="phone" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="+44 7123 456789" required>
                                <p class="text-light-grey text-xs mt-1 italic">Your contact number is shared securely with Royal Hair Studio. It will not be displayed publicly.</p>
                                <div id="phoneError" class="error-message">Please enter a valid contact number (7–15 digits).</div>
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-2">Address Line 1</label>
                                <input type="text" id="addressLine1" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="Enter your address" required>
                                <div id="addressLine1Error" class="error-message">Please enter a valid address (minimum 10 characters).</div>
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-2">City</label>
                                <input type="text" id="city" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="Enter your city" required>
                                <div id="cityError" class="error-message">Please enter your city.</div>
                            </div>
                            <div>
                                <label class="block text-white font-medium mb-2">Postcode</label>
                                <input type="text" id="postcode" 
                                       class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                       placeholder="Enter your postcode" required>
                                <div id="postcodeError" class="error-message">Please enter a valid postcode.</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-white font-medium mb-2">Optional Note to Business</label>
                            <textarea id="specialRequests" rows="3"
                                      class="w-full px-4 py-3 rounded-xl bg-dark-grey/50 border border-white/20 text-white focus:outline-none focus:border-gold focus:ring-2 focus:ring-gold/20 transition-all duration-300"
                                      placeholder="Any special requests or notes for the business..."></textarea>
                            <p class="text-light-grey text-xs mt-4 italic">
                                BlkPages does not monitor or read customer messages. Your information is securely passed to the business handling your booking.
                            </p>
                        </div>
                    </div>

                    <!-- Terms & Conditions -->
                    <div class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-file-contract mr-3 text-gold"></i>
                            Terms & Conditions
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- BlkPages Terms -->
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" id="blkpagesTerms" required
                                       class="mt-1 w-4 h-4 text-gold bg-dark-grey/50 border-white/20 rounded focus:ring-gold focus:ring-2">
                                <div class="flex-1">
                                    <label for="blkpagesTerms" class="text-light-grey text-sm">
                                        I agree to BlkPages 
                                        <a href="/legal/blkpages-terms" target="_blank" class="text-gold hover:text-gold/80 underline">Terms & Conditions</a>
                                        <span class="text-red-400">*</span>
                                    </label>
                                    <div id="blkpagesTermsError" class="error-message">Please fill in this field.</div>
                                </div>
                            </div>

                            <!-- Business Terms -->
                            <div class="flex items-start space-x-3" id="businessTermsContainer">
                                <!-- Business terms will be populated by JavaScript if business.termsUrl is provided -->
                            </div>

                            <!-- Marketing Opt-in -->
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" id="marketingOptIn"
                                       class="mt-1 w-4 h-4 text-gold bg-dark-grey/50 border-white/20 rounded focus:ring-gold focus:ring-2">
                                <label for="marketingOptIn" class="text-light-grey text-sm">
                                    I would like to receive marketing communications and special offers
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Cancellation Policy -->
                    <div id="cancellationPolicySection" class="card-gradient rounded-3xl p-6 border-glow">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                            <i class="fas fa-calendar-times mr-3 text-gold"></i>
                            Cancellation Policy
                        </h2>
                        
                        <div class="bg-gold/10 rounded-xl p-4 border border-gold/20">
                            <p class="text-light-grey text-sm mb-3">
                                This policy is set by <span class="text-gold font-semibold" id="businessNameForPolicy">Royal Hair Studio</span>. 
                                BlkPages processes payments via Stripe on behalf of the venue but is not responsible for enforcing refunds.
                            </p>
                            
                            <p class="text-light-grey text-sm mb-3 italic">
                                For refunds or payment queries, please contact the business directly.
                            </p>
                            
                            <button onclick="openCancellationPolicyModal()" 
                                    class="text-gold hover:text-gold/80 underline text-sm font-medium">
                                View cancellation policy
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Booking Summary -->
                <div class="space-y-6">
                    <!-- Summary Card -->
                    <div class="card-gradient rounded-3xl p-6 border-glow sticky top-24">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-receipt mr-3 text-gold"></i>
                            Booking Summary
                        </h2>
                        
                        <div id="bookingSummary" class="space-y-4">
                            <!-- Summary will be populated by JavaScript -->
                        </div>
                        
                        <!-- Special Offer -->
                        <div id="offerSection" class="mt-6 p-4 rounded-xl bg-gold/10 border border-gold/30 hidden">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gold font-medium">First Visit Discount</p>
                                    <p class="text-light-grey text-sm">20% off your first booking</p>
                                </div>
                                <span class="text-gold font-bold" id="discountAmount">-£0</span>
                            </div>
                        </div>
                        
                        <!-- Total -->
                        <div class="mt-6 pt-4 border-t border-white/20">
                            <div class="flex items-center justify-between">
                                <span class="text-xl font-bold text-white">Total</span>
                                <span class="text-2xl font-bold text-gold" id="totalAmount">£0</span>
                            </div>
                        </div>
                        
                        <!-- Continue Button -->
                        <button onclick="proceedToPayment()" 
                                class="w-full mt-6 py-4 rounded-xl gold-gradient text-black font-bold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                id="continueBtn" disabled>
                            <i class="fas fa-credit-card mr-2"></i>Continue to Payment
                        </button>
                        
                        <!-- Guest User Sign In Prompt -->
                        <div id="guestSignInPrompt" class="mt-3 text-center">
                            <p class="text-xs text-gray-400">
                                <a href="#" onclick="handleGuestSignIn()" class="text-gold hover:text-gold/80 transition-colors duration-300 underline">
                                    Click to sign in/sign up
                                </a> for faster checkout and booking management
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Waiting List Modal -->
    <div id="waitingListModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full border-2 border-gold shadow-[0_0_20px_rgba(212,175,55,0.25)] modal-content relative">
                <!-- Modal Header -->
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gold/10 flex items-center justify-center">
                        <i class="fas fa-clock text-gold text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">This service is currently on a waiting list.</h2>
                    <p class="text-gray-600">Please select an alternative date/time, or sign in/sign up to join the waiting list.</p>
                </div>
                
                <!-- Modal Buttons -->
                <div class="space-y-3 mb-6">
                    <button onclick="selectDifferentTime()" 
                            class="w-full py-3 px-6 rounded-xl border-2 border-gold text-gray-900 font-semibold hover:bg-gold/10 transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-calendar-alt mr-2"></i>Select Different Date/Time
                    </button>
                    
                    <button onclick="joinWaitingList()" 
                            class="w-full py-3 px-6 rounded-xl gold-gradient text-black font-semibold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-user-plus mr-2"></i>Sign In/Sign Up to Join Waiting List
                    </button>
                </div>
                
                <!-- Guest User Sign In Prompt -->
                <div id="waitingListGuestPrompt" class="text-center">
                    <p class="text-xs text-gray-500">
                        <a href="#" onclick="handleGuestSignIn()" class="text-gold hover:text-gold/80 transition-colors duration-300 underline">
                            Click to sign in/sign up
                        </a> to manage your waiting list bookings
                    </p>
                </div>
                
                <!-- Close Button -->
                <button onclick="closeWaitingListModal()" 
                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Waiting List Confirmation Modal -->
    <div id="waitingListConfirmationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full border-2 border-gold shadow-[0_0_20px_rgba(212,175,55,0.25)] modal-content relative">
                <!-- Modal Header -->
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">You have joined the waiting list!</h2>
                    <p class="text-gray-600" id="waitingListServiceName">You have joined the waiting list for <span class="font-semibold text-gold">Hair Cut & Style</span>.</p>
                </div>
                
                <!-- Modal Buttons -->
                <div class="space-y-3 mb-6">
                    <button onclick="viewWaitingListStatus()" 
                            class="w-full py-3 px-6 rounded-xl gold-gradient text-black font-semibold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-list mr-2"></i>View Waiting List Status
                    </button>
                    
                    <button onclick="closeWaitingListConfirmationModal()" 
                            class="w-full py-3 px-6 rounded-xl border-2 border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-all duration-300">
                        <i class="fas fa-home mr-2"></i>Back to Home
                    </button>
                </div>
                
                <!-- Close Button -->
                <button onclick="closeWaitingListConfirmationModal()" 
                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Cancellation Policy Modal -->
    <div id="cancellationPolicyModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden modal-overlay">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-8 max-w-2xl w-full border-2 border-gold shadow-[0_0_20px_rgba(212,175,55,0.25)] modal-content relative">
                <!-- Modal Header -->
                <div class="text-center mb-6">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gold/10 flex items-center justify-center">
                        <i class="fas fa-calendar-times text-gold text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2" id="cancellationPolicyTitle">Cancellation Policy</h2>
                    <p class="text-gray-600">Please review the cancellation policy for your booking</p>
                </div>
                
                <!-- Modal Content -->
                <div class="mb-6">
                    <div id="cancellationPolicyContent" class="text-gray-700 leading-relaxed">
                        <!-- Cancellation policy content will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Modal Buttons -->
                <div class="flex justify-center">
                    <button onclick="closeCancellationPolicyModal()" 
                            class="px-8 py-3 rounded-xl gold-gradient text-black font-semibold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300 transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>I Understand
                    </button>
                </div>
                
                <!-- Close Button -->
                <button onclick="closeCancellationPolicyModal()" 
                        class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedService = null;
        let selectedDate = null;
        let selectedTime = null;
        let businessInfo = null;
        let basketItems = JSON.parse(localStorage.getItem('basketItems') || '[]');
        let isUserSignedIn = false; // Will be determined by checking localStorage or session

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkUserAuthentication();
            handleAuthReturn();
            loadBusinessInfo();
            setupServiceSelection();
            setupDateSelection();
            setupFormValidation();
            setupModalEventListeners();
            updateBasketCount();
            fillTestCustomerDetails();
            setupGuestPrompts();
            setupBusinessTermsAndPolicy();
            setupValidationEventListeners();
            setupPageLeaveHandlers();
            setupBusinessContactNote();
        });

        // Setup modal event listeners
        function setupModalEventListeners() {
            // ESC key to close modals
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const waitingListModal = document.getElementById('waitingListModal');
                    const confirmationModal = document.getElementById('waitingListConfirmationModal');
                    
                    if (!waitingListModal.classList.contains('hidden')) {
                        closeWaitingListModal();
                    } else if (!confirmationModal.classList.contains('hidden')) {
                        closeWaitingListConfirmationModal();
                    }
                }
            });

            // Background click to close modals
            document.getElementById('waitingListModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeWaitingListModal();
                }
            });

            document.getElementById('waitingListConfirmationModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeWaitingListConfirmationModal();
                }
            });
        }

        // Load business info from localStorage
        function loadBusinessInfo() {
            const stored = localStorage.getItem('selectedBusiness');
            if (stored) {
                businessInfo = JSON.parse(stored);
                displayBusinessInfo();
            } else {
                // Fallback data
                businessInfo = {
                    name: 'Royal Hair Studio',
                    location: '123 Hair Street, London, SW1A 1AA',
                    phone: '+44 20 7123 4567',
                    email: 'info@royalhairstudio.com',
                    allowCall: true,
                    allowEmail: true,
                    hasOffer: true,
                    offerDiscount: 20
                };
                displayBusinessInfo();
            }
        }

        // Display business info
        function displayBusinessInfo() {
            const container = document.getElementById('businessInfo');
            container.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-white">${businessInfo.name}</h3>
                        <p class="text-light-grey text-sm">${businessInfo.location}</p>
                    </div>
                    <div class="text-right">
                        <div class="flex text-gold">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                        </div>
                        <p class="text-light-grey text-sm">${businessInfo.rating || 4.9} (${businessInfo.reviews || 127} reviews)</p>
                    </div>
                </div>
            `;
        }

        // Setup service selection
        function setupServiceSelection() {
            const serviceOptions = document.querySelectorAll('.service-option');
            serviceOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove previous selection
                    serviceOptions.forEach(opt => {
                        opt.classList.remove('selected');
                        const clickText = opt.querySelector('.text-gold.text-xs');
                        if (clickText) {
                            clickText.textContent = 'Click to add';
                        }
                    });
                    
                    // Add selection to clicked option
                    this.classList.add('selected');
                    
                    // Update text to show selected
                    const clickText = this.querySelector('.text-gold.text-xs');
                    if (clickText) {
                        clickText.textContent = 'Selected ✓';
                    }
                    
                    // Store selected service
                    selectedService = {
                        id: this.dataset.service,
                        name: this.querySelector('h3').textContent,
                        price: parseInt(this.dataset.price),
                        duration: parseInt(this.dataset.duration)
                    };
                    
                    // Regenerate time slots now that service is selected
                    generateTimeSlots();
                    
                    updateBookingSummary();
                    checkFormCompletion();
                });
            });
        }

        // Setup date selection
        function setupDateSelection() {
            const dateInput = document.getElementById('bookingDate');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            // Set default date to today for testing
            dateInput.value = today;
            selectedDate = today;
            
            dateInput.addEventListener('change', function() {
                selectedDate = this.value;
                generateTimeSlots();
                checkFormCompletion();
            });
            
            // Generate initial time slots
            generateTimeSlots();
        }

        // Generate time slots based on mock availability data
        function generateTimeSlots() {
            if (!selectedDate) return;
            
            const timeSlotsContainer = document.getElementById('timeSlots');
            
            // Don't show availability until a service is selected
            if (!selectedService) {
                timeSlotsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-cut text-4xl text-gray-500 mb-4"></i>
                        <p class="text-gray-500 text-lg font-medium">Select a service first</p>
                        <p class="text-gray-400 text-sm">Choose a service above to see available time slots</p>
                    </div>
                `;
                return;
            }
            
            const businessId = businessInfo ? businessInfo.slug : 'royal-hair-studio';
            const serviceId = selectedService.id;
            
            // Get availability data for this business, service, and date
            const businessData = mockAvailabilityData[businessId];
            const serviceData = businessData ? businessData[serviceId] : null;
            let dayData = serviceData ? serviceData[selectedDate] : null;
            
            // Add randomization for dynamic availability
            if (!dayData) {
                const random = Math.random();
                let waitlist = false;
                let closed = false;
                
                if (random < 0.2) waitlist = true;
                else if (random < 0.3) closed = true;
                
                if (closed) {
                    dayData = { status: 'closed' };
                } else if (waitlist) {
                    dayData = { status: 'fully-booked', waitingList: true };
                } else {
                    // Generate random available slots
                    const allSlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'];
                    const availableSlots = allSlots.filter(() => Math.random() > 0.3); // 70% chance each slot is available
                    dayData = { status: 'available', slots: availableSlots };
                }
            }
            
            let slotsHTML = '';
            
            if (!dayData) {
                // Default slots if no data
                const defaultSlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'];
                slotsHTML = defaultSlots.map(time => `
                    <div class="time-slot bg-dark-grey/50 rounded-xl p-3 border border-white/10 cursor-pointer text-center hover:border-gold/50 transition-all duration-300" 
                         data-time="${time}">
                        <span class="text-white font-medium">${time}</span>
                    </div>
                `).join('');
            } else if (dayData.status === 'closed') {
                // Business is closed
                slotsHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-calendar-times text-4xl text-gray-500 mb-4"></i>
                        <p class="text-gray-500 text-lg font-medium">Closed</p>
                        <p class="text-gray-400 text-sm">This business is closed on this date</p>
                    </div>
                `;
            } else if (dayData.status === 'fully-booked') {
                // Fully booked with waiting list
                slotsHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-clock text-4xl text-gold mb-4"></i>
                        <p class="text-gold text-lg font-medium">Fully Booked</p>
                        <p class="text-gray-400 text-sm">Join the waiting list for this date</p>
                        <button onclick="openWaitingListModal()" 
                                class="mt-4 px-6 py-2 rounded-xl gold-gradient text-black font-semibold hover:shadow-lg hover:shadow-gold/30 transition-all duration-300">
                            Join Waiting List
                        </button>
                    </div>
                `;
            } else if (dayData.status === 'available') {
                // Available slots
                const allSlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'];
                slotsHTML = allSlots.map(time => {
                    const isAvailable = dayData.slots.includes(time);
                    const slotClass = isAvailable 
                        ? 'time-slot bg-dark-grey/50 rounded-xl p-3 border border-white/10 cursor-pointer text-center hover:border-gold/50 transition-all duration-300'
                        : 'time-slot bg-dark-grey/30 rounded-xl p-3 border border-gray-600/30 text-center opacity-50 cursor-not-allowed';
                    
                    return `
                        <div class="${slotClass}" data-time="${time}" data-available="${isAvailable}">
                            <span class="text-white font-medium">${time}</span>
                            ${!isAvailable ? '<span class="block text-xs text-gold mt-1">Click to join waiting list</span>' : ''}
                        </div>
                    `;
                }).join('');
            }
            
            timeSlotsContainer.innerHTML = slotsHTML;
            
            // Add click handlers to all time slots
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    const time = this.dataset.time;
                    const isAvailable = this.dataset.available === 'true';
                    
                    if (!isAvailable) {
                        // Show waiting list modal for full slots
                        openWaitingListModal();
                        return;
                    }
                    
                    // Remove previous selection
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    
                    // Add selection to clicked slot
                    this.classList.add('selected');
                    
                    selectedTime = time;
                    updateBookingSummary();
                    checkFormCompletion();
                });
            });
        }

        // Update booking summary
        function updateBookingSummary() {
            const summaryContainer = document.getElementById('bookingSummary');
            const totalElement = document.getElementById('totalAmount');
            const discountElement = document.getElementById('discountAmount');
            const offerSection = document.getElementById('offerSection');
            
            let summaryHTML = '';
            let total = 0;
            
            if (selectedService) {
                summaryHTML += `
                    <div class="flex items-center justify-between group">
                        <div class="flex-1">
                            <p class="text-white font-medium">${selectedService.name}</p>
                            <p class="text-light-grey text-sm">${selectedService.duration} minutes</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-gold font-bold">£${selectedService.price}</span>
                            <button onclick="removeSelectedService()" 
                                    class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-red-500/10 transition-all duration-200">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
                total = selectedService.price;
            }
            
            if (selectedDate && selectedTime) {
                const date = new Date(selectedDate);
                const formattedDate = date.toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                summaryHTML += `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white font-medium">Date & Time</p>
                            <p class="text-light-grey text-sm">${formattedDate} at ${selectedTime}</p>
                        </div>
                    </div>
                `;
            }
            
            summaryContainer.innerHTML = summaryHTML;
            
            // Update total amount based on payment mode
            if (selectedService) {
                const business = {
                    payments: businessInfo.payments || getBusinessPaymentSettings()
                };
                
                if (business.payments.allowDeposit) {
                    const depositPercent = business.payments.depositPercent || 20;
                    const depositAmount = selectedService.price * (depositPercent / 100);
                    const remaining = selectedService.price - depositAmount;
                    totalElement.textContent = `£${depositAmount.toFixed(2)}`;
                    
                    // Add deposit information below total
                    const depositInfo = document.createElement('div');
                    depositInfo.className = 'mt-2 text-center';
                    depositInfo.innerHTML = `
                        <p class="text-gray-400 text-sm">
                            Deposit: ${depositPercent}% due now (£${depositAmount.toFixed(2)}). 
                            Balance £${remaining.toFixed(2)} payable at venue.
                        </p>
                    `;
                    
                    // Remove existing deposit info if present
                    const existingDepositInfo = document.querySelector('.deposit-info');
                    if (existingDepositInfo) {
                        existingDepositInfo.remove();
                    }
                    
                    depositInfo.className += ' deposit-info';
                    totalElement.parentElement.appendChild(depositInfo);
                } else {
                    totalElement.textContent = `£${total.toFixed(2)}`;
                    
                    // Remove deposit info if present
                    const existingDepositInfo = document.querySelector('.deposit-info');
                    if (existingDepositInfo) {
                        existingDepositInfo.remove();
                    }
                }
            } else {
                totalElement.textContent = '£0';
                
                // Remove deposit info if present
                const existingDepositInfo = document.querySelector('.deposit-info');
                if (existingDepositInfo) {
                    existingDepositInfo.remove();
                }
            }
            
            // Handle special offer
            if (businessInfo.hasOffer && selectedService) {
                const discount = Math.round(total * (businessInfo.offerDiscount / 100));
                total -= discount;
                
                discountElement.textContent = `-£${discount}`;
                offerSection.classList.remove('hidden');
            } else {
                offerSection.classList.add('hidden');
            }
            
            totalElement.textContent = `£${total}`;
        }

        // Setup form validation
        function setupFormValidation() {
            const inputs = ['firstName', 'lastName', 'email', 'phone', 'addressLine1', 'city', 'postcode'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', checkFormCompletion);
                }
            });
            
            // Add validation for checkboxes
            const blkpagesTerms = document.getElementById('blkpagesTerms');
            if (blkpagesTerms) {
                blkpagesTerms.addEventListener('change', checkFormCompletion);
            }
            
            const businessTerms = document.getElementById('businessTerms');
            if (businessTerms) {
                businessTerms.addEventListener('change', checkFormCompletion);
            }
        }

        // Check if form is complete
        function checkFormCompletion() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const addressLine1 = document.getElementById('addressLine1').value.trim();
            const city = document.getElementById('city').value.trim();
            const postcode = document.getElementById('postcode').value.trim();
            
            // Check required checkboxes
            const blkpagesTerms = document.getElementById('blkpagesTerms').checked;
            const businessTerms = document.getElementById('businessTerms');
            const businessTermsChecked = businessTerms ? businessTerms.checked : true; // If no business terms, consider it checked
            
            const isComplete = selectedService && selectedDate && selectedTime && 
                              firstName && lastName && email && phone && 
                              addressLine1 && city && postcode &&
                              blkpagesTerms && businessTermsChecked;
            
            const continueBtn = document.getElementById('continueBtn');
            continueBtn.disabled = !isComplete;
        }

        // Create basket item
        function createBasketItem() {
            if (!selectedService || !selectedDate || !selectedTime || !businessInfo) {
                return null;
            }

            // Get business payment settings
            const business = {
                payments: businessInfo.payments || getBusinessPaymentSettings()
            };

            let basketItem;

            if (business.payments.allowDeposit) {
                const depositPercent = business.payments.depositPercent || 20;
                const depositAmount = selectedService.price * (depositPercent / 100);
                const remaining = selectedService.price - depositAmount;
                basketItem = {
                    serviceId: selectedService.id,
                    businessId: businessInfo.id,
                    name: selectedService.name,
                    price: selectedService.price,
                    date: selectedDate,
                    time: selectedTime,
                    payMode: "deposit",
                    depositPercent,
                    depositAmount,
                    remainingAmount: remaining,
                };
            } else if (business.payments.allowFull) {
                basketItem = {
                    serviceId: selectedService.id,
                    businessId: businessInfo.id,
                    name: selectedService.name,
                    price: selectedService.price,
                    date: selectedDate,
                    time: selectedTime,
                    payMode: "full"
                };
            } else if (business.payments.allowPayAtVenue) {
                basketItem = {
                    serviceId: selectedService.id,
                    businessId: businessInfo.id,
                    name: selectedService.name,
                    price: selectedService.price,
                    date: selectedDate,
                    time: selectedTime,
                    payMode: "venue"
                };
            }

            return basketItem;
        }

        // Get business payment settings (fallback if not in businessInfo)
        function getBusinessPaymentSettings() {
            const businessId = businessInfo ? businessInfo.id : 'royal-hair-studio';
            const storedSettings = localStorage.getItem(`business_${businessId}_payment_settings`);
            
            if (storedSettings) {
                return JSON.parse(storedSettings);
            }
            
            // Default settings (matching dashboard defaults)
            return {
                allowFull: false,
                allowDeposit: false,
                depositPercent: 20,
                allowPayAtVenue: true
            };
        }

        // Add item to basket
        function addToBasket(basketItem) {
            basketItems.push(basketItem);
            localStorage.setItem('basketItems', JSON.stringify(basketItems));
            updateBasketCount();
        }

        // Update basket count in header
        function updateBasketCount() {
            const basketCount = basketItems.length;
            const basketCountElements = document.querySelectorAll('.basket-count');
            basketCountElements.forEach(element => {
                element.textContent = basketCount;
            });
        }

        // Proceed to payment
        function proceedToPayment() {
            // Clear previous validation errors
            clearValidationErrors();
            
            // Validate all required fields
            const validation = validateBookingDetails();
            
            if (!validation.isValid) {
                // Show validation banner
                showValidationBanner();
                
                // Show field errors with shake animation
                showFieldErrors(validation.errors);
                
                // Keep button enabled so user can try again after fixing errors
                return; // Don't proceed to payment
            }

            // Hide validation banner if it was shown
            hideValidationBanner();

            // Create basket item
            const basketItem = createBasketItem();
            if (!basketItem) {
                alert('Error creating booking item. Please try again.');
                return;
            }

            // Add to basket
            addToBasket(basketItem);

            // Store complete booking data
            const bookingData = {
                ...collectBookingDetails(),
                total: calculateTotal(),
                basketItem: basketItem
            };
            
            localStorage.setItem('bookingData', JSON.stringify(bookingData));
            console.log('✅ Booking data stored, proceeding to payment...');
            window.location.href = 'payment-page.html';
        }

        // Clear all validation errors
        function clearValidationErrors() {
            // Remove error classes from all inputs
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.classList.remove('field-error');
            });
            
            // Hide all error messages
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(error => {
                error.classList.remove('show');
            });
        }

        // Show validation banner
        function showValidationBanner() {
            const banner = document.getElementById('validationBanner');
            banner.classList.add('show');
        }

        // Hide validation banner
        function hideValidationBanner() {
            const banner = document.getElementById('validationBanner');
            banner.classList.remove('show');
        }

        // Show field errors with shake animation
        function showFieldErrors(errors) {
            errors.forEach(error => {
                const fieldId = error.field;
                const errorMessage = error.message;
                
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    const errorElement = document.getElementById(fieldId + 'Error');
                    
                    if (field) {
                        // Add shake animation and gold glow border
                        field.classList.add('field-error');
                        
                        // Remove error class after animation
                        setTimeout(() => {
                            field.classList.remove('field-error');
                        }, 500);
                    }
                    
                    if (errorElement) {
                        // Update error message and show
                        errorElement.textContent = errorMessage;
                        errorElement.classList.add('show');
                    }
                }
            });
        }

        // Setup validation event listeners
        function setupValidationEventListeners() {
            // Clear errors when user starts typing or checking boxes
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    clearFieldError(this.id);
                });
                
                input.addEventListener('change', function() {
                    clearFieldError(this.id);
                });
            });
        }

        // Clear error for specific field
        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (field) {
                field.classList.remove('field-error');
            }
            
            if (errorElement) {
                errorElement.classList.remove('show');
            }
            
            // Hide validation banner if all errors are cleared
            const visibleErrors = document.querySelectorAll('.error-message.show');
            if (visibleErrors.length === 0) {
                hideValidationBanner();
            }
            
            // Re-check form completion to re-enable button if all fields are now valid
            checkFormCompletion();
        }

        // Setup page leave handlers to uncheck terms and conditions
        function setupPageLeaveHandlers() {
            // Handle page unload (refresh, close tab, navigate away)
            window.addEventListener('beforeunload', function() {
                uncheckTermsAndConditions();
            });

            // Handle page visibility change (tab switching)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Page is now hidden (user switched tabs or minimized)
                    uncheckTermsAndConditions();
                }
            });

            // Handle page focus loss (user clicks outside browser)
            window.addEventListener('blur', function() {
                uncheckTermsAndConditions();
            });
        }

        // Uncheck terms and conditions checkboxes
        function uncheckTermsAndConditions() {
            // Uncheck BlkPages terms
            const blkpagesTerms = document.getElementById('blkpagesTerms');
            if (blkpagesTerms) {
                blkpagesTerms.checked = false;
            }

            // Uncheck business terms if it exists
            const businessTerms = document.getElementById('businessTerms');
            if (businessTerms) {
                businessTerms.checked = false;
            }

            // Re-check form completion to disable button if needed
            checkFormCompletion();

            console.log('🔒 Terms and conditions unchecked due to page leave');
        }

        // Setup Business Contact Note component
        function setupBusinessContactNote() {
            const contactNoteContainer = document.getElementById('businessContactNote');
            
            // Get business contact information
            const businessContactInfo = getBusinessContactInfo();
            
            // Generate contact note HTML with serviceType
            const contactNoteHTML = generateBusinessContactNote(businessContactInfo, 'stylist');
            
            console.log('Business Contact Note Debug:', {
                businessContactInfo,
                contactNoteHTML,
                containerExists: !!contactNoteContainer
            });
            
            // Update container
            contactNoteContainer.innerHTML = contactNoteHTML;
            
            // Hide container if no contact info available
            if (!businessContactInfo.hasContactInfo) {
                contactNoteContainer.style.display = 'none';
                console.log('Contact note hidden - no contact info available');
            } else {
                contactNoteContainer.style.display = 'block';
                console.log('Contact note displayed');
            }
        }

        // Get business contact information
        function getBusinessContactInfo() {
            const business = businessInfo || {
                name: 'Royal Hair Studio',
                phone: '+44 20 7123 4567',
                email: 'info@royalhairstudio.com',
                allowCall: true,
                allowEmail: true
            };

            const hasPhone = business.phone && business.allowCall;
            const hasEmail = business.email && business.allowEmail;
            const hasContactInfo = hasPhone || hasEmail;

            console.log('Business Contact Info Debug:', {
                business,
                hasPhone,
                hasEmail,
                hasContactInfo
            });

            return {
                businessName: business.name,
                phone: business.phone,
                email: business.email,
                allowCall: business.allowCall,
                allowEmail: business.allowEmail,
                hasPhone,
                hasEmail,
                hasContactInfo
            };
        }

        // Generate Business Contact Note HTML
        function generateBusinessContactNote(contactInfo, serviceType = 'stylist') {
            let contactLink = null;
            let linkText = `contact ${contactInfo.businessName} directly`;

            // Determine contact method with priority: phone first, then email
            if (contactInfo.allowCall && contactInfo.phone) {
                contactLink = `<a href="tel:${contactInfo.phone}" class="text-gold hover:underline hover:text-gold/80 transition-colors duration-300">${linkText}</a>`;
            } else if (contactInfo.allowEmail && contactInfo.email) {
                contactLink = `<a href="mailto:${contactInfo.email}?subject=BlkPages Enquiry" class="text-gold hover:underline hover:text-gold/80 transition-colors duration-300">${linkText}</a>`;
            } else {
                return ''; // Hide completely if no contact info
            }

            return `
                <div class="text-light-grey text-sm mt-4 italic leading-relaxed animate-[fadeIn_0.3s_ease-in-out]">
                    Note: Bookings are made with the first available ${serviceType}. 
                    For special arrangements or enquiries, please ${contactLink}.
                </div>
            `;
        }

        // Demo function to show different BusinessContactNote configurations
        function demoBusinessContactNote() {
            console.log('=== BusinessContactNote Demo ===');
            
            // Example 1: Royal Hair Studio (Phone only)
            const royalHairConfig = {
                businessName: 'Royal Hair Studio',
                phone: '+44 20 7123 4567',
                allowCall: true,
                allowEmail: false
            };
            
            const royalHairNote = generateBusinessContactNote(royalHairConfig, 'stylist');
            console.log('Royal Hair Studio (Phone):', royalHairNote);
            
            // Example 2: Urban Roots Salon (Email only)
            const urbanRootsConfig = {
                businessName: 'Urban Roots Salon',
                email: 'info@urbanroots.com',
                allowCall: false,
                allowEmail: true
            };
            
            const urbanRootsNote = generateBusinessContactNote(urbanRootsConfig, 'stylist');
            console.log('Urban Roots Salon (Email):', urbanRootsNote);
            
            // Example 3: Spa Business (Therapist)
            const spaConfig = {
                businessName: 'Serenity Spa',
                phone: '+44 20 7654 3210',
                allowCall: true,
                allowEmail: false
            };
            
            const spaNote = generateBusinessContactNote(spaConfig, 'therapist');
            console.log('Serenity Spa (Therapist):', spaNote);
            
            // Example 4: Tattoo Studio (Artist)
            const tattooConfig = {
                businessName: 'Ink & Art Studio',
                email: 'bookings@inkandart.com',
                allowCall: false,
                allowEmail: true
            };
            
            const tattooNote = generateBusinessContactNote(tattooConfig, 'artist');
            console.log('Ink & Art Studio (Artist):', tattooNote);
            
            // Example 5: No contact info (should return empty)
            const noContactConfig = {
                businessName: 'Mystery Business',
                allowCall: false,
                allowEmail: false
            };
            
            const noContactNote = generateBusinessContactNote(noContactConfig, 'stylist');
            console.log('No Contact Info:', noContactNote || '(Hidden - no contact info)');
        }

        // Manual test function for Business Contact Note
        function testBusinessContactNote() {
            console.log('=== Testing Business Contact Note ===');
            
            // Force setup the contact note
            setupBusinessContactNote();
            
            // Check if the container exists and has content
            const container = document.getElementById('businessContactNote');
            if (container) {
                console.log('Container found:', container);
                console.log('Container innerHTML:', container.innerHTML);
                console.log('Container display style:', container.style.display);
                console.log('Container computed display:', window.getComputedStyle(container).display);
            } else {
                console.log('Container not found!');
            }
            
            // Test with different configurations
            console.log('Testing with phone only...');
            businessInfo = {
                name: 'Test Salon',
                phone: '+44 20 1234 5678',
                allowCall: true,
                allowEmail: false
            };
            setupBusinessContactNote();
            
            console.log('Testing with email only...');
            businessInfo = {
                name: 'Test Salon',
                email: 'test@salon.com',
                allowCall: false,
                allowEmail: true
            };
            setupBusinessContactNote();
        }

        // Calculate total with discount
        function calculateTotal() {
            let total = selectedService ? selectedService.price : 0;
            
            if (businessInfo.hasOffer && selectedService) {
                const discount = Math.round(total * (businessInfo.offerDiscount / 100));
                total -= discount;
            }
            
            return total;
        }

        // Go back to business profile
        function goBack() {
            window.history.back();
        }

        // Open waiting list modal
        function openWaitingListModal() {
            const modal = document.getElementById('waitingListModal');
            modal.classList.remove('hidden');
            
            // Add show classes for animation
            setTimeout(() => {
                modal.classList.add('show');
                const modalContent = modal.querySelector('.modal-content');
                modalContent.classList.add('show');
            }, 10);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Close waiting list modal
        function closeWaitingListModal() {
            const modal = document.getElementById('waitingListModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Remove show classes for animation
            modal.classList.remove('show');
            modalContent.classList.remove('show');
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Open waiting list confirmation modal
        function openWaitingListConfirmationModal() {
            const modal = document.getElementById('waitingListConfirmationModal');
            const serviceNameElement = document.getElementById('waitingListServiceName');
            
            // Update service name in confirmation
            if (selectedService) {
                serviceNameElement.innerHTML = `You have joined the waiting list for <span class="font-semibold text-gold">${selectedService.name}</span>.`;
            }
            
            modal.classList.remove('hidden');
            
            // Add show classes for animation
            setTimeout(() => {
                modal.classList.add('show');
                const modalContent = modal.querySelector('.modal-content');
                modalContent.classList.add('show');
            }, 10);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Close waiting list confirmation modal
        function closeWaitingListConfirmationModal() {
            const modal = document.getElementById('waitingListConfirmationModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Remove show classes for animation
            modal.classList.remove('show');
            modalContent.classList.remove('show');
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Select different time slot
        function selectDifferentTime() {
            closeWaitingListModal();
            // Clear current selection to allow user to select again
            selectedTime = null;
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
            updateBookingSummary();
            checkFormCompletion();
        }

        // Join waiting list (redirect to auth)
        function joinWaitingList() {
            const serviceId = businessInfo ? businessInfo.slug : 'royal-hair-studio';
            // Preserve current page and basket data
            const currentUrl = window.location.href;
            const basketData = JSON.stringify(basketItems);
            localStorage.setItem('pendingAuthRedirect', currentUrl);
            localStorage.setItem('pendingAuthBasket', basketData);
            window.location.href = `/auth/signin?redirect=${encodeURIComponent(currentUrl)}`;
        }

        // View waiting list status
        function viewWaitingListStatus() {
            window.location.href = '/customer-dashboard.html#waiting-list';
        }

        // Mock availability data for all businesses and services
        const mockAvailabilityData = {
            'royal-hair-studio': {
                'hair-cut': {
                    '2024-01-15': { status: 'fully-booked', waitingList: true },
                    '2024-01-16': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] },
                    '2024-01-17': { status: 'closed' },
                    '2024-01-18': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] },
                    '2024-01-19': { status: 'fully-booked', waitingList: true },
                    '2024-01-20': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] },
                    '2024-01-21': { status: 'closed' }
                },
                'hair-color': {
                    '2024-01-15': { status: 'available', slots: ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'] },
                    '2024-01-16': { status: 'fully-booked', waitingList: true },
                    '2024-01-17': { status: 'available', slots: ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'] },
                    '2024-01-18': { status: 'closed' },
                    '2024-01-19': { status: 'available', slots: ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'] },
                    '2024-01-20': { status: 'fully-booked', waitingList: true },
                    '2024-01-21': { status: 'available', slots: ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'] }
                },
                'hair-treatment': {
                    '2024-01-15': { status: 'available', slots: ['09:00', '10:30', '12:00', '13:30', '15:00', '16:30'] },
                    '2024-01-16': { status: 'available', slots: ['09:00', '10:30', '12:00', '13:30', '15:00', '16:30'] },
                    '2024-01-17': { status: 'fully-booked', waitingList: true },
                    '2024-01-18': { status: 'available', slots: ['09:00', '10:30', '12:00', '13:30', '15:00', '16:30'] },
                    '2024-01-19': { status: 'closed' },
                    '2024-01-20': { status: 'available', slots: ['09:00', '10:30', '12:00', '13:30', '15:00', '16:30'] },
                    '2024-01-21': { status: 'fully-booked', waitingList: true }
                },
                'special-occasion': {
                    '2024-01-15': { status: 'closed' },
                    '2024-01-16': { status: 'available', slots: ['09:00', '12:00', '15:00'] },
                    '2024-01-17': { status: 'available', slots: ['09:00', '12:00', '15:00'] },
                    '2024-01-18': { status: 'fully-booked', waitingList: true },
                    '2024-01-19': { status: 'available', slots: ['09:00', '12:00', '15:00'] },
                    '2024-01-20': { status: 'closed' },
                    '2024-01-21': { status: 'available', slots: ['09:00', '12:00', '15:00'] }
                }
            },
            'elite-barber': {
                'hair-cut': {
                    '2024-01-15': { status: 'available', slots: ['08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00'] },
                    '2024-01-16': { status: 'fully-booked', waitingList: true },
                    '2024-01-17': { status: 'available', slots: ['08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00'] },
                    '2024-01-18': { status: 'closed' },
                    '2024-01-19': { status: 'available', slots: ['08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00'] },
                    '2024-01-20': { status: 'fully-booked', waitingList: true },
                    '2024-01-21': { status: 'closed' }
                }
            },
            'glamour-beauty': {
                'hair-cut': {
                    '2024-01-15': { status: 'fully-booked', waitingList: true },
                    '2024-01-16': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] },
                    '2024-01-17': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] },
                    '2024-01-18': { status: 'closed' },
                    '2024-01-19': { status: 'fully-booked', waitingList: true },
                    '2024-01-20': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] },
                    '2024-01-21': { status: 'available', slots: ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'] }
                }
            }
        };

        // Check if time slot is available (extended with mock data)
        function checkTimeSlotAvailability(date, time) {
            const businessId = businessInfo ? businessInfo.slug : 'royal-hair-studio';
            const serviceId = selectedService ? selectedService.id : 'hair-cut';
            
            // Get availability data for this business and service
            const businessData = mockAvailabilityData[businessId];
            if (!businessData) return true; // Default to available if no data
            
            const serviceData = businessData[serviceId];
            if (!serviceData) return true; // Default to available if no data
            
            const dayData = serviceData[date];
            if (!dayData) return true; // Default to available if no data
            
            // Check status
            if (dayData.status === 'closed') {
                return false; // No availability, no waiting list
            }
            
            if (dayData.status === 'fully-booked') {
                return false; // No availability, but waiting list active
            }
            
            if (dayData.status === 'available') {
                return dayData.slots.includes(time);
            }
            
            return true; // Default fallback
        }

        // Check if waiting list is active for a date/time
        function isWaitingListActive(date, time) {
            const businessId = businessInfo ? businessInfo.slug : 'royal-hair-studio';
            const serviceId = selectedService ? selectedService.id : 'hair-cut';
            
            const businessData = mockAvailabilityData[businessId];
            if (!businessData) return false;
            
            const serviceData = businessData[serviceId];
            if (!serviceData) return false;
            
            const dayData = serviceData[date];
            if (!dayData) return false;
            
            return dayData.status === 'fully-booked' && dayData.waitingList === true;
        }

        // Check if business is closed for a date
        function isBusinessClosed(date) {
            const businessId = businessInfo ? businessInfo.slug : 'royal-hair-studio';
            const serviceId = selectedService ? selectedService.id : 'hair-cut';
            
            const businessData = mockAvailabilityData[businessId];
            if (!businessData) return false;
            
            const serviceData = businessData[serviceId];
            if (!serviceData) return false;
            
            const dayData = serviceData[date];
            if (!dayData) return false;
            
            return dayData.status === 'closed';
        }

        // Demo function to simulate successful sign-in and show confirmation
        function simulateSuccessfulSignIn() {
            // This would be called after successful authentication
            // For demo purposes, we'll show the confirmation modal
            closeWaitingListModal();
            setTimeout(() => {
                openWaitingListConfirmationModal();
            }, 100);
        }

        // Demo function to test waiting list flow
        function testWaitingListFlow() {
            console.log('Testing Waiting List Flow:');
            console.log('1. Select a full time slot (14:00 on 2024-01-15)');
            console.log('2. Waiting list modal should appear');
            console.log('3. Click "Sign In/Sign Up to Join Waiting List"');
            console.log('4. After successful auth, confirmation modal should appear');
            
            // For demo: simulate the full flow
            selectedDate = '2024-01-15';
            selectedTime = '14:00';
            openWaitingListModal();
        }

        // Demo function to test availability scenarios
        function testAvailabilityScenarios() {
            console.log('🎯 Mock Availability Data Test:');
            console.log('\n📅 Royal Hair Studio - Hair Cut:');
            console.log('• 2024-01-15: Fully Booked (Waiting List Active)');
            console.log('• 2024-01-16: Available (18 slots)');
            console.log('• 2024-01-17: Closed');
            console.log('• 2024-01-18: Available (18 slots)');
            console.log('• 2024-01-19: Fully Booked (Waiting List Active)');
            console.log('• 2024-01-20: Available (18 slots)');
            console.log('• 2024-01-21: Closed');
            
            console.log('\n📅 Royal Hair Studio - Hair Color:');
            console.log('• 2024-01-15: Available (8 slots)');
            console.log('• 2024-01-16: Fully Booked (Waiting List Active)');
            console.log('• 2024-01-17: Available (8 slots)');
            console.log('• 2024-01-18: Closed');
            console.log('• 2024-01-19: Available (8 slots)');
            console.log('• 2024-01-20: Fully Booked (Waiting List Active)');
            console.log('• 2024-01-21: Available (8 slots)');
            
            console.log('\n📅 Elite Barber - Hair Cut:');
            console.log('• 2024-01-15: Available (21 slots)');
            console.log('• 2024-01-16: Fully Booked (Waiting List Active)');
            console.log('• 2024-01-17: Available (21 slots)');
            console.log('• 2024-01-18: Closed');
            console.log('• 2024-01-19: Available (21 slots)');
            console.log('• 2024-01-20: Fully Booked (Waiting List Active)');
            console.log('• 2024-01-21: Closed');
            
            console.log('\n🧪 Test Instructions:');
            console.log('1. Select different dates to see various states');
            console.log('2. Try 2024-01-15 for fully booked (waiting list)');
            console.log('3. Try 2024-01-17 for closed business');
            console.log('4. Try 2024-01-16 for available slots');
            console.log('5. Switch between different services to see different patterns');
        }

        // Get availability summary for a business
        function getAvailabilitySummary(businessId, serviceId) {
            const businessData = mockAvailabilityData[businessId];
            if (!businessData) return null;
            
            const serviceData = businessData[serviceId];
            if (!serviceData) return null;
            
            const summary = {
                totalDays: Object.keys(serviceData).length,
                availableDays: 0,
                fullyBookedDays: 0,
                closedDays: 0,
                waitingListDays: 0
            };
            
            Object.values(serviceData).forEach(dayData => {
                if (dayData.status === 'available') summary.availableDays++;
                if (dayData.status === 'fully-booked') summary.fullyBookedDays++;
                if (dayData.status === 'closed') summary.closedDays++;
                if (dayData.waitingList) summary.waitingListDays++;
            });
            
            return summary;
        }

        // Display basket items (for debugging/demo)
        function displayBasketItems() {
            console.log('Current Basket Items:');
            basketItems.forEach((item, index) => {
                console.log(`${index + 1}. ${item.name} - ${item.date} at ${item.time} - £${item.price} - Payment: ${item.payMode}`);
            });
            return basketItems;
        }

        // Clear basket (for testing)
        function clearBasket() {
            basketItems = [];
            localStorage.setItem('basketItems', JSON.stringify(basketItems));
            updateBasketCount();
            console.log('Basket cleared');
        }

        // Get basket summary
        function getBasketSummary() {
            const totalItems = basketItems.length;
            const totalValue = basketItems.reduce((sum, item) => sum + item.price, 0);
            const pendingItems = basketItems.filter(item => item.payMode === 'pending').length;
            const paidItems = basketItems.filter(item => item.payMode !== 'pending').length;
            
            return {
                totalItems,
                totalValue,
                pendingItems,
                paidItems
            };
        }

        // Fill test customer details for easy testing
        function fillTestCustomerDetails() {
            // Test customer data
            const testCustomer = {
                firstName: 'John',
                lastName: 'Smith',
                email: 'john.smith@example.com',
                phone: '+44 7123 456789',
                addressLine1: '123 Test Street',
                city: 'London',
                postcode: 'SW1A 1AA',
                specialRequests: 'Please use organic products if possible. I have sensitive skin.'
            };
            
            // Fill in the form fields
            document.getElementById('firstName').value = testCustomer.firstName;
            document.getElementById('lastName').value = testCustomer.lastName;
            document.getElementById('email').value = testCustomer.email;
            document.getElementById('phone').value = testCustomer.phone;
            document.getElementById('addressLine1').value = testCustomer.addressLine1;
            document.getElementById('city').value = testCustomer.city;
            document.getElementById('postcode').value = testCustomer.postcode;
            document.getElementById('specialRequests').value = testCustomer.specialRequests;
            
            // Check the required terms checkbox
            document.getElementById('blkpagesTerms').checked = true;
            
            // Trigger form validation to enable continue button when service/time are selected
            checkFormCompletion();
            
            console.log('✅ Test customer details filled in:');
            console.log(`Name: ${testCustomer.firstName} ${testCustomer.lastName}`);
            console.log(`Email: ${testCustomer.email}`);
            console.log(`Phone: ${testCustomer.phone}`);
            console.log(`Address: ${testCustomer.addressLine1}, ${testCustomer.city} ${testCustomer.postcode}`);
            console.log('📝 Now select a service and time slot to test the booking flow!');
        }

        // Setup business terms and cancellation policy
        function setupBusinessTermsAndPolicy() {
            // Setup business terms if business has termsUrl
            const businessTermsContainer = document.getElementById('businessTermsContainer');
            if (businessInfo && businessInfo.termsUrl) {
                businessTermsContainer.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" id="businessTerms" required
                               class="mt-1 w-4 h-4 text-gold bg-dark-grey/50 border-white/20 rounded focus:ring-gold focus:ring-2">
                        <label for="businessTerms" class="text-light-grey text-sm">
                            I agree to this business's 
                            <a href="${businessInfo.termsUrl}" target="_blank" class="text-gold hover:text-gold/80 underline">Terms & Conditions</a>
                            <span class="text-red-400">*</span>
                        </label>
                    </div>
                `;
            }

            // Setup cancellation policy
            const businessNameElement = document.getElementById('businessNameForPolicy');
            if (businessNameElement && businessInfo) {
                businessNameElement.textContent = businessInfo.name || 'Royal Hair Studio';
            }

            // Show/hide cancellation policy section based on payment settings
            const cancellationSection = document.getElementById('cancellationPolicySection');
            const paymentSettings = getBusinessPaymentSettings();
            
            // Only show cancellation policy if payment is being taken
            if (paymentSettings.allowFull || paymentSettings.allowDeposit) {
                cancellationSection.style.display = 'block';
            } else {
                cancellationSection.style.display = 'none';
            }
        }

        // Get business cancellation policy (linked to dashboard)
        function getBusinessCancellationPolicy() {
            // This would normally fetch from business dashboard/API
            const businessId = businessInfo ? businessInfo.id : 'royal-hair-studio';
            const storedPolicy = localStorage.getItem(`business_${businessId}_cancellation_policy`);
            
            if (storedPolicy) {
                return JSON.parse(storedPolicy);
            }
            
            // Default cancellation policy for Royal Hair Studio
            return {
                type: '24hour', // '24hour', '48hour', or 'non-refundable'
                businessName: businessInfo ? businessInfo.name : 'Royal Hair Studio'
            };
        }

        // Open cancellation policy modal
        function openCancellationPolicyModal() {
            const modal = document.getElementById('cancellationPolicyModal');
            const policy = getBusinessCancellationPolicy();
            
            // Set modal title
            document.getElementById('cancellationPolicyTitle').textContent = 
                `${policy.businessName} - Cancellation Policy`;
            
            // Set policy content based on type
            let policyContent = '';
            switch (policy.type) {
                case '24hour':
                    policyContent = `
                        <p class="mb-4"><strong>You may cancel your booking up to 24 hours before your appointment for a full refund.</strong></p>
                        <p class="mb-4">Cancellations made within 24 hours and no-shows will be charged 100% of the service price.</p>
                        <p class="mb-4">Refunds are returned to your original payment method within 5–10 business days.</p>
                        <p class="text-sm text-gray-600 italic">For refunds or payment queries, please contact the business directly.</p>
                    `;
                    break;
                case '48hour':
                    policyContent = `
                        <p class="mb-4"><strong>You may cancel your booking up to 48 hours before your appointment for a full refund.</strong></p>
                        <p class="mb-4">Cancellations made within 48 hours will be charged 50% of the service price.</p>
                        <p class="mb-4">No-shows will be charged 100% of the service price.</p>
                        <p class="mb-4">Refunds are returned to your original payment method within 5–10 business days.</p>
                        <p class="text-sm text-gray-600 italic">For refunds or payment queries, please contact the business directly.</p>
                    `;
                    break;
                case 'non-refundable':
                    policyContent = `
                        <p class="mb-4"><strong>This booking is non-refundable once confirmed.</strong></p>
                        <p class="mb-4">No-shows will be charged 100% of the service price.</p>
                        <p class="mb-4">Refunds are returned to your original payment method within 5–10 business days.</p>
                        <p class="text-sm text-gray-600 italic">For refunds or payment queries, please contact the business directly.</p>
                    `;
                    break;
                default:
                    policyContent = `
                        <p class="mb-4"><strong>You may cancel your booking up to 24 hours before your appointment for a full refund.</strong></p>
                        <p class="mb-4">Cancellations made within 24 hours and no-shows will be charged 100% of the service price.</p>
                        <p class="mb-4">Refunds are returned to your original payment method within 5–10 business days.</p>
                        <p class="text-sm text-gray-600 italic">For refunds or payment queries, please contact the business directly.</p>
                    `;
            }
            
            document.getElementById('cancellationPolicyContent').innerHTML = policyContent;
            
            modal.classList.remove('hidden');
            
            // Add show classes for animation
            setTimeout(() => {
                modal.classList.add('show');
                const modalContent = modal.querySelector('.modal-content');
                modalContent.classList.add('show');
            }, 10);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Close cancellation policy modal
        function closeCancellationPolicyModal() {
            const modal = document.getElementById('cancellationPolicyModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Remove show classes for animation
            modal.classList.remove('show');
            modalContent.classList.remove('show');
            
            // Hide modal after animation
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Refresh time slots with new randomization
        function refreshTimeSlots() {
            console.log('🔄 Refreshing time slots with new randomization...');
            generateTimeSlots();
        }

        // Test randomization function
        function testRandomization() {
            console.log('🎲 Testing randomization logic:');
            for (let i = 0; i < 10; i++) {
                const random = Math.random();
                let status = 'available';
                if (random < 0.2) status = 'waitlist';
                else if (random < 0.3) status = 'closed';
                console.log(`Test ${i + 1}: ${random.toFixed(3)} → ${status}`);
            }
        }

        // Check if user is signed in
        function checkUserAuthentication() {
            // Check localStorage for user session
            const userSession = localStorage.getItem('userSession');
            const userToken = localStorage.getItem('userToken');
            
            if (userSession || userToken) {
                isUserSignedIn = true;
                console.log('✅ User is signed in');
            } else {
                isUserSignedIn = false;
                console.log('👤 User is not signed in (guest mode)');
            }
        }

        // Handle return from authentication
        function handleAuthReturn() {
            // Check if we have pending auth data to restore
            const pendingAuthRedirect = localStorage.getItem('pendingAuthRedirect');
            const pendingAuthBasket = localStorage.getItem('pendingAuthBasket');
            const pendingAuthBooking = localStorage.getItem('pendingAuthBooking');
            
            if (pendingAuthRedirect && pendingAuthBasket && isUserSignedIn) {
                console.log('🔄 Restoring basket and booking state after successful authentication...');
                
                try {
                    // Restore basket data
                    const restoredBasket = JSON.parse(pendingAuthBasket);
                    basketItems = restoredBasket;
                    localStorage.setItem('basketItems', JSON.stringify(basketItems));
                    
                    // Restore booking state if available
                    if (pendingAuthBooking) {
                        const bookingData = JSON.parse(pendingAuthBooking);
                        selectedService = bookingData.selectedService;
                        selectedDate = bookingData.selectedDate;
                        selectedTime = bookingData.selectedTime;
                        businessInfo = bookingData.businessInfo;
                        
                        // Restore UI state
                        if (selectedService) {
                            // Restore service selection
                            document.querySelectorAll('.service-option').forEach(option => {
                                if (option.dataset.service === selectedService.id) {
                                    option.classList.add('selected');
                                    const clickText = option.querySelector('.text-gold.text-xs');
                                    if (clickText) {
                                        clickText.textContent = 'Selected ✓';
                                    }
                                }
                            });
                            
                            // Restore time selection
                            if (selectedTime) {
                                document.querySelectorAll('.time-slot').forEach(slot => {
                                    if (slot.dataset.time === selectedTime) {
                                        slot.classList.add('selected');
                                    }
                                });
                            }
                            
                            // Update summary
                            updateBookingSummary();
                        }
                    }
                    
                    // Clear pending auth data
                    localStorage.removeItem('pendingAuthRedirect');
                    localStorage.removeItem('pendingAuthBasket');
                    localStorage.removeItem('pendingAuthBooking');
                    
                    // Update basket count
                    updateBasketCount();
                    
                    // Show success message
                    showAuthSuccessMessage();
                    
                    console.log('✅ Basket and booking state restored successfully:', basketItems);
                } catch (error) {
                    console.error('❌ Error restoring basket and booking state:', error);
                }
            }
        }

        // Show authentication success message
        function showAuthSuccessMessage() {
            // Create a temporary success message
            const successMessage = document.createElement('div');
            successMessage.className = 'fixed top-20 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            successMessage.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <span>Welcome back! Your basket has been restored.</span>
                </div>
            `;
            
            document.body.appendChild(successMessage);
            
            // Remove message after 3 seconds
            setTimeout(() => {
                successMessage.style.opacity = '0';
                successMessage.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (successMessage.parentNode) {
                        successMessage.parentNode.removeChild(successMessage);
                    }
                }, 300);
            }, 3000);
        }

        // Handle guest sign-in with basket preservation
        function handleGuestSignIn() {
            // Preserve current page and basket data
            const currentUrl = window.location.href;
            const basketData = JSON.stringify(basketItems);
            const bookingData = {
                selectedService: selectedService,
                selectedDate: selectedDate,
                selectedTime: selectedTime,
                businessInfo: businessInfo
            };
            
            // Store data for restoration after auth
            localStorage.setItem('pendingAuthRedirect', currentUrl);
            localStorage.setItem('pendingAuthBasket', basketData);
            localStorage.setItem('pendingAuthBooking', JSON.stringify(bookingData));
            
            console.log('🔄 Preserving basket and booking data before auth...');
            
            // Redirect to sign-in page
            window.location.href = `customer-login.html?redirect=${encodeURIComponent(currentUrl)}`;
        }

        // Setup guest prompts visibility
        function setupGuestPrompts() {
            const guestPrompt = document.getElementById('guestSignInPrompt');
            const waitingListPrompt = document.getElementById('waitingListGuestPrompt');
            
            if (isUserSignedIn) {
                // Hide prompts for signed-in users
                if (guestPrompt) guestPrompt.style.display = 'none';
                if (waitingListPrompt) waitingListPrompt.style.display = 'none';
            } else {
                // Show prompts for guest users
                if (guestPrompt) guestPrompt.style.display = 'block';
                if (waitingListPrompt) waitingListPrompt.style.display = 'block';
            }
        }

        // Validate booking details with legal compliance
        function validateBookingDetails() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const addressLine1 = document.getElementById('addressLine1').value.trim();
            const city = document.getElementById('city').value.trim();
            const postcode = document.getElementById('postcode').value.trim();
            
            const errors = [];
            
            // First Name & Last Name validation
            if (!firstName) {
                errors.push({ field: 'firstName', message: 'Please enter your full name.' });
            } else {
                const nameRegex = /^[a-zA-Z\s]+$/;
                if (!nameRegex.test(firstName)) {
                    errors.push({ field: 'firstName', message: 'Please enter your full name.' });
                }
            }
            
            if (!lastName) {
                errors.push({ field: 'lastName', message: 'Please enter your full name.' });
            } else {
                const nameRegex = /^[a-zA-Z\s]+$/;
                if (!nameRegex.test(lastName)) {
                    errors.push({ field: 'lastName', message: 'Please enter your full name.' });
                }
            }
            
            // Email validation
            if (!email) {
                errors.push({ field: 'email', message: 'Please enter a valid email address.' });
            } else {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    errors.push({ field: 'email', message: 'Please enter a valid email address.' });
                }
            }
            
            // Contact Number validation
            if (!phone) {
                errors.push({ field: 'phone', message: 'Please enter a valid contact number (7–15 digits).' });
            } else {
                const phoneRegex = /^\+?\d{7,15}$/;
                if (!phoneRegex.test(phone.replace(/\s/g, ''))) {
                    errors.push({ field: 'phone', message: 'Please enter a valid contact number (7–15 digits).' });
                }
            }
            
            // Address validation
            if (!addressLine1 || addressLine1.length < 10) {
                errors.push({ field: 'addressLine1', message: 'Please enter a valid address (minimum 10 characters).' });
            }
            
            if (!city) {
                errors.push({ field: 'city', message: 'Please enter your city.' });
            }
            
            if (!postcode) {
                errors.push({ field: 'postcode', message: 'Please enter a valid postcode.' });
            } else {
                const postcodeRegex = /^[A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2}$/i;
                if (!postcodeRegex.test(postcode)) {
                    errors.push({ field: 'postcode', message: 'Please enter a valid postcode.' });
                }
            }
            
            // Terms and conditions validation
            const blkpagesTerms = document.getElementById('blkpagesTerms').checked;
            if (!blkpagesTerms) {
                errors.push({ field: 'blkpagesTerms', message: 'You must agree to BlkPages Terms & Conditions' });
            }
            
            const businessTerms = document.getElementById('businessTerms');
            if (businessTerms && !businessTerms.checked) {
                errors.push({ field: 'businessTerms', message: 'You must agree to the business Terms & Conditions' });
            }
            
            // Service and time validation
            if (!selectedService) errors.push({ field: 'serviceSelection', message: 'Please select a service' });
            if (!selectedDate) errors.push({ field: 'dateSelection', message: 'Please select a date' });
            if (!selectedTime) errors.push({ field: 'timeSelection', message: 'Please select a time slot' });
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Remove selected service
        function removeSelectedService() {
            if (!selectedService) return;
            
            // Remove from basket if it exists
            if (basketItems.length > 0) {
                basketItems = basketItems.filter(item => 
                    !(item.serviceId === selectedService.id && 
                      item.date === selectedDate && 
                      item.time === selectedTime)
                );
                localStorage.setItem('basketItems', JSON.stringify(basketItems));
                updateBasketCount();
            }
            
            // Clear selected service
            selectedService = null;
            selectedTime = null; // Also clear time since it's service-specific
            
            // Reset service selection UI
            document.querySelectorAll('.service-option').forEach(option => {
                option.classList.remove('selected');
                const clickText = option.querySelector('.text-gold.text-xs');
                if (clickText) {
                    clickText.textContent = 'Click to add';
                }
            });
            
            // Reset time selection UI
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            // Update summary and regenerate time slots
            updateBookingSummary();
            generateTimeSlots();
            checkFormCompletion();
            
            console.log('🗑️ Service removed from booking');
        }

        // Collect booking details with validation
        function collectBookingDetails() {
            const validation = validateBookingDetails();
            
            if (!validation.isValid) {
                alert('Please fix the following errors:\n• ' + validation.errors.join('\n• '));
                return null;
            }
            
            const bookingDetails = {
                // Customer details
                customer: {
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    specialRequests: document.getElementById('specialRequests').value.trim()
                },
                
                // Booking details
                booking: {
                    service: selectedService,
                    date: selectedDate,
                    time: selectedTime,
                    business: businessInfo
                },
                
                // Legal compliance
                legal: {
                    termsAccepted: true, // Would be a checkbox in real implementation
                    privacyPolicyAccepted: true, // Would be a checkbox in real implementation
                    dataProcessingConsent: true, // GDPR compliance
                    marketingConsent: false, // Opt-in for marketing
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    ipAddress: 'N/A' // Would be collected server-side
                },
                
                // Authentication
                auth: {
                    isSignedIn: isUserSignedIn,
                    userId: isUserSignedIn ? localStorage.getItem('userId') : null,
                    sessionId: isUserSignedIn ? localStorage.getItem('sessionId') : null
                }
            };
            
            console.log('✅ Booking details collected and validated:', bookingDetails);
            return bookingDetails;
        }

        // Demo functions to test different cancellation policies
        function setCancellationPolicy24Hour() {
            const businessId = businessInfo ? businessInfo.id : 'royal-hair-studio';
            const policy = {
                type: '24hour',
                businessName: businessInfo ? businessInfo.name : 'Royal Hair Studio'
            };
            localStorage.setItem(`business_${businessId}_cancellation_policy`, JSON.stringify(policy));
            console.log('✅ Cancellation policy set to 24-hour');
        }

        function setCancellationPolicy48Hour() {
            const businessId = businessInfo ? businessInfo.id : 'royal-hair-studio';
            const policy = {
                type: '48hour',
                businessName: businessInfo ? businessInfo.name : 'Royal Hair Studio'
            };
            localStorage.setItem(`business_${businessId}_cancellation_policy`, JSON.stringify(policy));
            console.log('✅ Cancellation policy set to 48-hour');
        }

        function setCancellationPolicyNonRefundable() {
            const businessId = businessInfo ? businessInfo.id : 'royal-hair-studio';
            const policy = {
                type: 'non-refundable',
                businessName: businessInfo ? businessInfo.name : 'Royal Hair Studio'
            };
            localStorage.setItem(`business_${businessId}_cancellation_policy`, JSON.stringify(policy));
            console.log('✅ Cancellation policy set to non-refundable');
        }

        // Test function to demonstrate cancellation policies
        function testCancellationPolicies() {
            console.log('🧪 Testing Cancellation Policies:');
            console.log('1. setCancellationPolicy24Hour() - 24-hour cancellation policy');
            console.log('2. setCancellationPolicy48Hour() - 48-hour cancellation policy');
            console.log('3. setCancellationPolicyNonRefundable() - Non-refundable policy');
            console.log('\nTry calling these functions and then click "View cancellation policy"!');
        }
    </script>
</body>
</html>
