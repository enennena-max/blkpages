<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Book • BlkPages</title>
  <style>
    :root{
  --bg:#0A0A0A; --panel:#111; --ink:#fff; --muted:#cfcfcf;
  --gold:#FFD700; --gold-hover:#ffdf33; --border:rgba(255,215,0,.35);
  --danger:#ff6b6b; --shadow:0 8px 24px rgba(0,0,0,.35);
}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;overflow-x:hidden;}
    a{color:var(--gold);text-decoration:none}
a:hover{color:var(--gold-hover);text-decoration:underline}
.wrap{max-width:1200px;margin:0 auto;padding:20px}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;gap:16px;
  padding-bottom:16px;margin-bottom:18px;border-bottom:1px solid var(--border)}
.biz{display:flex;gap:14px;align-items:center;min-width:0}
.logo{width:52px;height:52px;border-radius:10px;background:#1a1a1a;border:1px solid var(--border)}
.bizname{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub{color:var(--muted);font-size:.95rem}
.back{border:1px solid var(--border);padding:10px 14px;border-radius:8px;background:var(--panel);color:var(--ink)}

/* Layout grid */
.layout{display:grid;grid-template-columns:1fr;gap:18px;align-items:start;}
@media(min-width:980px){.layout{grid-template-columns:1.2fr .8fr}}

    /* Panels */
.panel{background:var(--panel);border:1px solid var(--border);
  border-radius:12px;box-shadow:var(--shadow);overflow:visible;}
.panel h2{margin:0;padding:18px 18px 0;font-size:1.1rem;font-weight:700}
    .panel .content{padding:18px}

/* Service Cards */
.svc{display:flex;justify-content:space-between;gap:12px;align-items:center;
  background:#0e0e0e;border:1px solid var(--border);border-radius:12px;
  padding:14px;margin-bottom:12px;}
.svc-name{font-weight:700}
.svc-meta{color:var(--muted);font-size:.9rem;margin-top:2px}
.price{font-weight:700}
.btn{border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;
  background:var(--gold);color:#111;transition:.2s}
.btn:hover{background:var(--gold-hover)}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}

/* Calendar + timeslot section */
.cal{border:1px solid var(--border);border-radius:12px;background:#0e0e0e;margin-bottom:16px}
.cal-head{display:flex;justify-content:space-between;align-items:center;
  padding:10px 12px;border-bottom:1px solid var(--border);}
.cal-title{font-weight:700}
.cal-nav button{background:transparent;border:1px solid var(--border);
  color:var(--ink);border-radius:8px;padding:6px 10px;cursor:pointer;}
.cal-nav button:hover{background:rgba(255,215,0,.15)}
.grid-7{display:grid;grid-template-columns:repeat(7,minmax(44px,1fr));gap:6px;padding:12px}
.dow{font-size:.8rem;color:var(--muted);text-align:center}
.day{aspect-ratio:1/1;min-height:44px;border:1px solid var(--border);border-radius:10px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  background:#101010;transition:.2s;}
.day:hover{background:#1b1b1b}
.day.sel{background:var(--gold);color:#111;font-weight:800}
.day.disabled{opacity:.35;cursor:not-allowed}
.legend{display:flex;gap:12px;padding:0 12px 12px;color:var(--muted);font-size:.85rem}
.legend .sw{width:14px;height:14px;border-radius:4px;border:1px solid var(--border);
  display:inline-block;margin-right:6px}

/* Timeslots grid */
.slots{display:grid;gap:8px;margin-top:8px;}
@media(max-width:499px){.slots{grid-template-columns:repeat(3,1fr)}}
@media(min-width:500px) and (max-width:699px){.slots{grid-template-columns:repeat(4,1fr)}}
@media(min-width:700px) and (max-width:979px){.slots{grid-template-columns:repeat(5,1fr)}}
@media(min-width:980px){.slots{grid-template-columns:repeat(6,1fr)}}
.slot{padding:10px;text-align:center;border-radius:999px;
  border:1px solid var(--border);background:#0e0e0e;color:var(--ink);cursor:pointer;transition:.2s;}
.slot:hover{background:#1b1b1b}
.slot.sel{background:var(--gold);color:#111;font-weight:800}
.slot.disabled{opacity:.35;cursor:not-allowed}

/* Form */
.form-grid{display:grid;grid-template-columns:1fr;gap:14px;}
@media(min-width:650px){.form-grid{grid-template-columns:1fr 1fr}}
.full{grid-column:1/-1}
label{display:block;margin:6px 0 4px;font-size:.95rem}
label.required::after{content:" *";color:var(--danger)}
input[type="text"],input[type="email"],input[type="tel"],textarea{
  width:100%;box-sizing:border-box;padding:12px 14px;border-radius:10px;
  border:1px solid var(--border);background:#0e0e0e;color:var(--ink);font-size:0.95rem}
.error{color:var(--danger);font-size:.85rem;margin-top:4px;display:none}
.terms{display:grid;gap:8px;margin-top:10px}
.terms label{display:flex;gap:10px;align-items:flex-start;color:var(--muted)}

/* Suggestions dropdown */
.suggestions{list-style:none;padding:0;margin:4px 0 0;background:#111;
  border:1px solid var(--border);border-radius:8px;display:none;
  position:absolute;z-index:10;max-height:120px;overflow-y:auto}
.suggestions li{padding:8px 12px;cursor:pointer}
.suggestions li:hover{background:rgba(255,215,0,0.15)}

/* Basket (desktop) */
aside{background:var(--panel);border:1px solid var(--border);
  border-radius:12px;box-shadow:var(--shadow);position:sticky;top:20px;align-self:start;overflow:visible;}
aside h2{margin:0;padding:18px 18px 0;font-size:1.1rem;font-weight:700}
aside .content{padding:18px}
.line{display:flex;justify-content:space-between;align-items:center;
  gap:10px;padding:10px 0;border-bottom:1px dashed rgba(255,215,0,.25)}
.line:last-child{border-bottom:none}
.totals{border-top:1px solid var(--border);margin-top:10px;padding-top:10px}
    .row{display:flex;justify-content:space-between;margin:6px 0}
.row.total{font-weight:800}

/* Mobile bottom bar + drawer */
#mobileBar, #drawer{display:none}
@media(max-width:979px){
  aside{display:none}
  #mobileBar{display:flex}
  #drawer{display:flex}
  .mobile-bar{
    position:fixed;bottom:0;left:0;right:0;background:#0f0f0f;
    border-top:1px solid var(--border);box-shadow:0 -6px 16px rgba(0,0,0,.4);
    padding:10px 14px;justify-content:space-between;align-items:center;z-index:40;
  }
  .mb-total{font-weight:800}
  .mb-actions{display:flex;gap:8px}
  .mb-btn{border:1px solid var(--border);background:#111;color:var(--ink);
    border-radius:10px;padding:8px 12px}
  .mb-pay{background:var(--gold);color:#111;border:none;border-radius:10px;
    padding:10px 16px;font-weight:800}
  .drawer{
    position:fixed;left:0;right:0;bottom:-100vh;background:#111;
    border-top:1px solid var(--border);border-radius:16px 16px 0 0;
    box-shadow:0 -16px 40px rgba(0,0,0,.6);z-index:50;
    transition:transform .25s ease-out;transform:translateY(100%);
    max-height:70vh;display:flex;flex-direction:column;
  }
  .drawer.open{transform:translateY(0)}
  .drawer .handle{display:flex;justify-content:center;padding:10px}
  .drawer .bar{width:56px;height:5px;border-radius:999px;background:var(--border)}
  .drawer .scroll{overflow:auto;padding:12px}
}

/* Floating summary bar styling */
#floatingSummary{position:fixed;bottom:0;left:0;right:0;background:#0f0f0f;
  border-top:1px solid rgba(255,215,0,0.3);box-shadow:0 -8px 24px rgba(0,0,0,0.45);
  padding:10px 20px;z-index:999}
.sum-inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;
  align-items:center;color:#fff;flex-wrap:wrap;gap:10px}
.sum-left{display:flex;flex-direction:column;gap:4px;font-size:0.9rem}
.sum-service{font-weight:700;color:#FFD700}
.sum-meta{font-size:0.85rem;color:#cfcfcf}
.sum-right{display:flex;align-items:center;gap:12px}
.sum-label{font-size:0.9rem;color:#cfcfcf}
.sum-amount{font-weight:800;font-size:1.1rem;color:#FFD700;margin-left:6px}
#floatingPayBtn{background:#FFD700;color:#111;border:none;padding:10px 24px;
  border-radius:8px;font-weight:700;cursor:pointer;transition:0.3s ease}
#floatingPayBtn:hover{background:#ffdf33}

/* Progress Steps */
.progress-steps {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  background: #1a1a1a;
  border-bottom: 1px solid #333;
  margin-bottom: 20px;
}

.step {
  display: flex;
  align-items: center;
  color: #666;
  font-size: 14px;
  font-weight: 500;
}

.step.active {
  color: #FFD700;
}

.step-number {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #333;
  color: #999;
  font-size: 12px;
  font-weight: 700;
  margin-right: 8px;
}

.step.active .step-number {
  background: #FFD700;
  color: #111;
}

.step-label {
  margin-left: 4px;
}

.step:not(:last-child)::after {
  content: '→';
  margin: 0 20px;
  color: #444;
  font-size: 16px;
}

@media (max-width: 768px) {
  .progress-steps {
    padding: 15px 10px;
  }
  
  .step {
    font-size: 12px;
  }
  
  .step:not(:last-child)::after {
    margin: 0 10px;
  }
}

/* 🖤 Booking Summary Panel (desktop) */
#basketPanel{position:sticky;top:20px;align-self:start;max-height:85vh;overflow-y:auto;transition:box-shadow 0.3s ease,border-color 0.3s ease}
#basketPanel:hover,#basketPanel:focus-within{box-shadow:0 0 20px rgba(255,215,0,0.25);border-color:rgba(255,215,0,0.6)}
#basketPanel .content{padding:18px}
#basketPanel .line{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,215,0,0.2)}
#basketPanel .line:last-child{border-bottom:none}
.edit-link{display:inline-block;margin-top:12px;color:var(--gold);font-size:0.9rem}

/* 💛 Hide desktop summary on mobile */
@media(max-width:979px){#basketPanel{display:none}}

/* 📱 Mobile "See Summary" button */
#mobileSummaryBtn{display:none}
@media(max-width:979px){
  #mobileSummaryBtn{position:fixed;bottom:70px;right:20px;z-index:1000}
  #mobileSummaryBtn button{background:#FFD700;color:#111;border:none;padding:12px 20px;
    border-radius:10px;font-weight:700;box-shadow:0 6px 20px rgba(0,0,0,0.4);cursor:pointer;
    display:flex;flex-direction:column;align-items:flex-start;line-height:1.2}
  #summaryBadge{font-size:0.8rem;font-weight:600;color:#222;background:#fff5c4;
    border-radius:6px;padding:2px 6px;margin-top:4px}
}

/* 📱 Mobile Slide-up Drawer */
#summaryDrawer{position:fixed;left:0;right:0;bottom:-100vh;background:#111;
  border-top:1px solid rgba(255,215,0,0.3);border-radius:20px 20px 0 0;
  box-shadow:0 -12px 40px rgba(0,0,0,0.5);transition:transform .3s ease;
  transform:translateY(100%);z-index:9999;padding-bottom:30px}
#summaryDrawer.open{transform:translateY(0);bottom:0}
.drawer-handle{width:50px;height:5px;background:rgba(255,215,0,0.5);
  border-radius:999px;margin:10px auto}
.drawer-content{padding:20px;max-height:70vh;overflow-y:auto}
#summaryDrawer h3{margin-top:0;color:var(--gold)}
#summaryDrawer .line{display:flex;justify-content:space-between;padding:8px 0;
  border-bottom:1px dashed rgba(255,215,0,0.2)}
#summaryDrawer .total strong{font-size:1.05rem}
#summaryDrawer button#closeSummary{width:100%;margin-top:16px;background:#FFD700;
  color:#111;border:none;padding:12px;border-radius:8px;font-weight:700;cursor:pointer}

/* Success modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
.sheet{background:var(--panel);border:1px solid var(--border);border-radius:12px;max-width:520px;width:100%;padding:20px;box-shadow:var(--shadow)}
.sheet h3{margin:0 0 10px}
    .divider{height:1px;background:var(--border);margin:12px 0}
.close{border:1px solid var(--border);background:#0e0e0e;color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}

/* BlkPoints Redemption Status Styles */
.pending-note {
  font-size: 0.8em;
  color: #aaa;
  font-weight: normal;
}

.redemption-status {
  padding: 8px 12px;
  border-radius: 8px;
  margin-top: 10px;
  display: inline-block;
  font-size: 0.9em;
  font-weight: 500;
  transition: all 0.4s ease;
}

.redemption-status.pending {
  background: rgba(255, 215, 0, 0.15);
  color: gold;
  animation: pulse 1.5s infinite;
}

.redemption-status.confirmed {
  background: rgba(76, 175, 80, 0.15);
  color: #4caf50;
}

.redemption-status.released {
  background: rgba(255, 255, 255, 0.1);
  color: #aaa;
}

@keyframes pulse {
  0% { opacity: 0.7; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}

.points-progress {
  background: #333;
  border-radius: 4px;
  height: 6px;
  width: 200px;
  margin-top: 8px;
}

.progress-fill {
  height: 6px;
  width: 0%;
  background: gold;
  border-radius: 4px;
  transition: width 1s ease;
}
  </style>
</head>
<body>
  <div class="wrap">
  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step active">
      <span class="step-number">1</span>
      <span class="step-label">Booking</span>
    </div>
    <div class="step">
      <span class="step-number">2</span>
      <span class="step-label">Payment</span>
    </div>
    <div class="step">
      <span class="step-number">3</span>
      <span class="step-label">Confirmation</span>
    </div>
  </div>

  <header>
    <div class="biz">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="bizname" id="bizName">Selected Business</div>
        <div class="sub" id="bizSub">Location • Rating 4.8 • <a href="#">View reviews</a></div>
      </div>
      </div>
    <a id="backToProfile" class="back" href="#">Back to profile</a>
    </header>

    <div class="layout">
    <!-- LEFT FLOW -->
    <main class="panel">
      <p class="hint" style="margin-bottom:10px;color:#cfcfcf;font-size:0.9rem;">
        Already have an account? <a href="#" onclick="redirectToLoginFromBooking()" style="color:#FFD700;text-decoration:underline;">Sign in</a> or
        <a href="#" onclick="redirectToRegisterFromBooking()" style="color:#FFD700;text-decoration:underline;">Create one</a>.
      </p>
      <h2>Choose services</h2>
        <div class="content" id="services">
        <div class="svc">
          <div>
                <div class="svc-name">Wash & Blow Dry</div>
                <div class="svc-meta">45 min</div>
              </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="price">£35</div>
            <button class="btn add" data-id="svc1" data-name="Wash & Blow Dry" data-price="35" data-duration="45">Add</button>
              </div>
            </div>
        <div class="svc">
          <div>
                <div class="svc-name">Cornrows</div>
                <div class="svc-meta">60 min</div>
              </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="price">£50</div>
            <button class="btn add" data-id="svc2" data-name="Cornrows" data-price="50" data-duration="60">Add</button>
              </div>
            </div>
        <div class="svc">
          <div>
                <div class="svc-name">Beard Trim</div>
                <div class="svc-meta">20 min</div>
              </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="price">£15</div>
            <button class="btn add" data-id="svc3" data-name="Beard Trim" data-price="15" data-duration="20">Add</button>
          </div>
        </div>
              </div>

      <h2>Select date & time</h2>
      <div class="content">
        <!-- Calendar -->
        <div class="cal" id="calendar">
          <div class="cal-head">
            <div class="cal-title" id="calTitle">Month YYYY</div>
            <div class="cal-nav">
              <button id="prevMonth" aria-label="Previous month">‹</button>
              <button id="nextMonth" aria-label="Next month">›</button>
            </div>
          </div>
          <div class="grid-7" id="calGrid"></div>
          <div class="legend">
            <span><span class="sw" style="background:#101010"></span>Available</span>
            <span><span class="sw" style="background:#FFD700"></span>Selected</span>
            <span><span class="sw" style="background:#101010;opacity:.35"></span>Fully booked</span>
            </div>
          </div>

        <!-- Timeslots -->
        <div>
          <div class="hint" id="slotsHint">Choose a date to see available times.</div>
          <div class="slots" id="slots"></div>
        </div>
          </div>

      <h2>Your details</h2>
          <div class="content" id="form">
            <div class="form-grid">
              <div>
            <label for="name" class="required">Full name</label>
            <input id="name" type="text" autocomplete="name" placeholder="e.g., Aisha Johnson" value="Aisha Johnson">
            <div class="error" id="nameErr">Please enter your full name.</div>
              </div>
              <div>
            <label for="email" class="required">Email</label>
            <input id="email" type="email" autocomplete="email" placeholder="name@example.com" value="aisha.johnson@example.com">
            <div class="error" id="emailErr">Please enter a valid email address.</div>
              </div>
              <div>
            <label for="phone" class="required">UK mobile number</label>
            <input id="phone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="07XXXXXXXXX" value="07123456789">
            <div class="error" id="phoneErr">Enter a valid UK number (starts with 07, 11 digits).</div>
              </div>
              <div>
            <label for="postcode">Postcode</label>
            <input id="postcode" type="text" autocomplete="postal-code" placeholder="e.g., SW1A 1AA" value="SW1A 1AA">
            <ul id="postcodeSuggestions" class="suggestions"></ul>
          </div>
          <div class="full">
            <label for="notes">Notes for the business (optional)</label>
            <textarea id="notes" rows="3" placeholder="Any access needs or preferences?"></textarea>
              </div>
              <div class="full new-customer">
            <label style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="isNewCustomer">
              This is my first booking through BlkPages.
            </label>
            <p class="hint" style="font-size:0.85rem;margin-top:4px;">
              (Used to help businesses welcome new customers and apply new customer rewards.)
            </p>
          </div>
              <div class="full terms">
            <label><input id="agreeBlk" type="checkbox" checked> I agree to the <a href="#" target="_blank" rel="noopener">BlkPages Terms & Conditions</a></label>
            <label><input id="agreeBiz" type="checkbox" checked> I agree to the <a href="#" target="_blank" rel="noopener"><span id="bizNameInline">Business</span> Terms & Conditions</a></label>
              </div>
          <div class="full">
            <button id="clearBtn" class="btn-ghost">Clear basket</button>
          </div>
          </div>
        </div>
      </main>

    <!-- RIGHT: Booking Summary Panel (desktop) -->
    <aside class="panel sticky" id="basketPanel">
      <h2>Your Booking Summary</h2>
      <div class="content" id="summaryPanel">
        <div id="summaryServices"></div>

        <div class="line"><strong>Duration</strong><span id="summaryDuration">—</span></div>
        <div class="line"><strong>Date</strong><span id="summaryDate">—</span></div>
        <div class="line"><strong>Time</strong><span id="summaryTime">—</span></div>
        <div class="line"><strong>Total</strong><span id="summaryTotal">£0.00</span></div>

        <a href="#calendar" class="edit-link">Change date/time</a>
        </div>
      </aside>
    </div>
  </div>

<!-- MOBILE bottom summary bar -->
<div class="mobile-bar" id="mobileBar">
  <div>
    <div style="font-size:.85rem;color:var(--muted)">Total</div>
    <div class="mb-total" id="mbTotal">£0.00</div>
  </div>
  <div class="mb-actions">
    <button id="openDrawer" class="mb-btn">Basket</button>
    <button id="mbPay" class="mb-pay" disabled>Pay Now</button>
  </div>
</div>

<!-- Mobile "See Summary" Button -->
<div id="mobileSummaryBtn">
  <button id="openSummary">
    See Summary
    <span id="summaryBadge">0 items • £0.00</span>
  </button>
</div>

<!-- MOBILE basket drawer -->
<div class="drawer" id="drawer">
  <div class="handle"><div class="bar"></div></div>
  <div class="scroll">
    <h3 style="margin:0 0 8px">Your Basket</h3>
    <div id="drawerLines"></div>
    <div class="totals">
      <div class="row"><span>Subtotal</span><span id="dSubtotal">£0.00</span></div>
      <div class="row total"><span>Total</span><span id="dTotal">£0.00</span></div>
    </div>
  </div>
</div>

<!-- Mobile Slide-Up Drawer -->
<div id="summaryDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-content">
    <h3>Your Booking Summary</h3>
    <div id="drawerServices"></div>

    <div class="line"><strong>Duration</strong><span id="drawerDuration">—</span></div>
    <div class="line"><strong>Date</strong><span id="drawerDate">—</span></div>
    <div class="line"><strong>Time</strong><span id="drawerTime">—</span></div>
    <div class="line total"><strong>Total</strong><span id="drawerTotal">£0.00</span></div>

    <a href="#calendar" class="edit-link">Change date/time</a>
    <button id="closeSummary">Close</button>
  </div>
</div>

<!-- Floating summary -->
<div id="floatingSummary">
  <div class="sum-inner">
    <div class="sum-left">
      <div class="sum-service" id="floatingService">—</div>
      <div class="sum-meta" id="floatingDateTime">Select a date & time</div>
    </div>
    <div class="sum-right">
      <div class="sum-total">
        <span class="sum-label">Total</span>
        <span class="sum-amount" id="floatingTotal">£0.00</span>
      </div>
      <button id="floatingPayBtn">Pay Now</button>
    </div>
  </div>
      </div>

<!-- Success Modal -->
<div id="successModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="sheet">
    <h3 id="mTitle">Booking request sent</h3>
    <div class="divider"></div>
    <div id="mBody"></div>
      <div class="divider"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="closeSuccess" class="close">Close</button>
    </div>
    </div>
  </div>

  <script>
/* ===== Utils ===== */
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const gbp=n=>"£"+Number(n||0).toFixed(2);

/* Header via ?business= */
const p=new URLSearchParams(location.search); const slug=p.get('business')||'selected-business';
const biz=slug.replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase());
qs('#bizName').textContent=biz; qs('#bizNameInline').textContent=biz;
qs('#backToProfile').href=`/profile.html?business=${encodeURIComponent(slug)}`;

/* Simulated availability per service - Updated with current dates */
function getAvailableDates() {
  const dates = {};
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Generate availability for next 30 days
  for (let i = 0; i < 30; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    const dateStr = date.toISOString().slice(0, 10);
    
    // Skip past dates
    if (date < today) continue;
    
    // Different availability patterns for different days
    const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
    
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      // Weekend: Reduced hours
      dates[dateStr] = ["10:00", "11:00", "12:00", "13:00", "14:00", "15:00"];
    } else {
      // Weekday: Full hours
      dates[dateStr] = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
    }
  }
  
  return dates;
}

const availabilityDB = {
  svc1: getAvailableDates(), // Wash & Blow Dry
  svc2: getAvailableDates(), // Cornrows
  svc3: Object.fromEntries(
    // Beard Trim has more frequent slots (every 30 min)
    Object.entries(getAvailableDates()).map(([date, times]) => [
      date,
      times.flatMap(time => {
        const [hours, mins] = time.split(':');
        const hour = parseInt(hours);
        if (hour >= 9 && hour < 17) {
          return [`${hours}:00`, `${hours}:30`];
        }
        return [time];
      }).filter(t => {
        const [h] = t.split(':');
        return parseInt(h) >= 9 && parseInt(h) < 17;
      })
    ])
  )
};

function fetchAvailability(serviceId){return new Promise(r=>setTimeout(()=>r(availabilityDB[serviceId]||{}),120));}

/* State */
const state={items:[], selDate:null, selTime:null, svc:null};
let blkPointsRedemptionValue = 0; // Global variable to store the redemption value
let blkPointsRedemptionPoints = 0; // Points to be redeemed
let redemptionValidationError = null; // Store validation error

// Helper function to show/hide elements
function show(element, visible) {
  if (!element) return;
  element.style.display = visible ? 'block' : 'none';
}

// Apply any stored BlkPoints redemption intent (localStorage), respecting rules
function getAppliedRedemption(subtotal){
  try{
    const stored = localStorage.getItem('blkpoints_redemption');
    if(!stored) return 0;
    const desired = Math.max(0, Number(stored)); // currency amount (e.g., 10)
    if(!isFinite(desired) || desired <= 0) return 0;
    // Rule: booking must be at least 2x redemption
    if(subtotal < desired * 2) return 0;
    // Rule: max 50% of booking value
    const maxAllowed = subtotal / 2;
    return Math.min(desired, maxAllowed);
  }catch(_e){ return 0; }
}

/* Basket render (desktop + mobile mirrors) */
    function renderBasket(){
  // Mobile drawer lines (if exists)
  const dlines=qs('#drawerLines');
  
  if (dlines) {
    dlines.innerHTML='';
    
    if(state.items.length===0){
      dlines.innerHTML='<div class="hint">Your basket is empty. Add services to continue.</div>';
    }else{
      state.items.forEach(i=>{
        const html=`<div class="line"><div>${i.name}</div><div style="display:flex;gap:8px;align-items:center"><strong>${gbp(i.price)}</strong><button class="btn-ghost rm" data-id="${i.id}">Remove</button></div></div>`;
        dlines.insertAdjacentHTML('beforeend',html);
      });
    }
  }
  
  // Setup remove button handlers
  qsa('.rm').forEach(b=>b.onclick=()=>removeItem(b.dataset.id));
  const sub=state.items.reduce((s,i)=>s+Number(i.price||0),0);

  const appliedRedemption = getAppliedRedemption(sub);
  const payable = Math.max(0, sub - appliedRedemption);

  // Update totals across UI (fallback where elements exist)
  const setIf = (sel, val)=>{const el=qs(sel); if(el) el.textContent = gbp(val);} 
  setIf('#subtotal', sub);
  setIf('#total', payable);
  setIf('#dSubtotal', sub);
  setIf('#dTotal', payable);
  setIf('#mbTotal', payable);

  // Also update floating total immediately
  const floating = qs('#floatingTotal'); if(floating) floating.textContent = gbp(payable);

  // If there's a desktop summary reduction line, reflect it (optional, only if present)
  const summaryPanel = qs('#summaryPanel');
  if(summaryPanel){
    let appliedLine = qs('#summaryAppliedLine');
    if(appliedRedemption > 0){
      if(!appliedLine){
        appliedLine = document.createElement('div');
        appliedLine.id = 'summaryAppliedLine';
        appliedLine.className = 'line';
        summaryPanel.insertBefore(appliedLine, summaryPanel.querySelector('.line:last-child'));
      }
      appliedLine.innerHTML = `<strong>BlkPoints applied</strong><span>-${gbp(appliedRedemption)} <span class="pending-note">(pending until booking completed)</span></span>`;
    } else if(appliedLine){
      appliedLine.remove();
    }
    const totalEl = qs('#summaryTotal'); if(totalEl) totalEl.textContent = gbp(payable);
  }

  // toggle Add/Remove states
  qsa('.add').forEach(b=>{
    const id=b.dataset.id;
    if(state.items.find(i=>i.id===id)){ b.textContent='Remove'; b.classList.add('btn-ghost'); }
    else { b.textContent='Add'; b.classList.remove('btn-ghost'); }
  });

  // Re-setup service button listeners after render
  setupServiceButtons();
  
  // Update floating summary and booking summary to reflect current state
  updateFloatingSummary();
  updateBookingSummary();

  validateAll();
}

/* Add/Remove/Clear */
function addItem(item){
  console.log('addItem called with:', item);
  if (!item || !item.id || !item.name) {
    console.error('Invalid item:', item);
    return;
  }
  if (!state.items.find(i => i.id === item.id)) {
    state.items.push(item);
    console.log('Item added. State items:', state.items);
  }
  if (!state.svc) {                 // <-- make the first added service the active one
    state.svc = item.id;
    console.log('Set active service to:', state.svc);
  }
  renderBasket();  // This updates totals and calls updateBookingSummary
  buildCalendar(curY, curM);        // <-- refresh the grid
  loadSlots();                       // <-- load times immediately
  updateFloatingSummary();          // <-- update floating summary
  updateBookingSummary();           // <-- ensure booking summary is updated
  validateAll();                    // <-- re-validate after adding service
}
function removeItem(id){
  state.items = state.items.filter(i => i.id !== id);
  if (state.svc === id) {
    state.svc = state.items[0]?.id || null; // pick next service or clear
    state.selDate = null;
    state.selTime = null;
  }
  renderBasket();
  buildCalendar(curY, curM);
  loadSlots();
  updateFloatingSummary();  // <-- update floating summary after removal
}
// Add event listeners for service buttons
function setupServiceButtons() {
  const buttons = qsa('.add');
  if (!buttons || buttons.length === 0) {
    console.warn('No service buttons found');
    return;
  }
  buttons.forEach(b => {
    // Remove any existing listeners
    b.onclick = null;
    // Add new listener
    b.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      const {id, name, price, duration} = b.dataset;
      console.log('Button clicked:', {id, name, price, duration});
      if (!id || !name || !price || !duration) {
        console.warn('Missing data attributes on button', b, b.dataset);
        return;
      }
      if (state.items.find(i => i.id === id)) {
        console.log('Removing item:', id);
        removeItem(id);
      } else {
        console.log('Adding item:', {id, name, price: Number(price), duration: Number(duration)});
        addItem({id, name, price: Number(price), duration: Number(duration)});
      }
    };
  });
}

// Initialize service buttons - wait for DOM
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setupServiceButtons();
    const clearBtn = qs('#clearBtn');
    if (clearBtn) clearBtn.onclick = () => {state.items=[];state.selDate=null;state.selTime=null;state.svc=null;renderBasket();}
  });
} else {
  setupServiceButtons();
  const clearBtn = qs('#clearBtn');
  if (clearBtn) clearBtn.onclick = () => {state.items=[];state.selDate=null;state.selTime=null;state.svc=null;renderBasket();}
}

/* Calendar */
const grid=qs('#calGrid'); const title=qs('#calTitle');
let today=new Date(); today.setHours(0,0,0,0); 
let curY=today.getFullYear(); 
let curM=today.getMonth();
function ymd(d){return d.toISOString().slice(0,10)}
function buildCalendar(y,m){
  if (!grid || !title) {
    console.warn('Calendar elements not ready');
    return;
  }
  grid.innerHTML='';
  const first=new Date(y,m,1), start=(first.getDay()+6)%7, daysIn=new Date(y,m+1,0).getDate();
  const dows=['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; grid.innerHTML=dows.map(d=>`<div class="dow">${d}</div>`).join('');
  const svc=state.svc||state.items[0]?.id; const map=availabilityDB[svc]||{};
  // blanks
  for(let i=0;i<start;i++) grid.insertAdjacentHTML('beforeend','<div></div>');
  for(let d=1;d<=daysIn;d++){
    const date=new Date(y,m,d); const dateStr=ymd(date);
    const el=document.createElement('button'); el.className='day'; el.textContent=d;
    if(ymd(date)===ymd(today)) el.classList.add('today');
    const isPast=date<today;
    const hasAvailability=(map[dateStr]||[]).length>0;
    if(isPast){el.classList.add('disabled'); el.disabled=true; el.title='Past date';}
    else if(!hasAvailability){el.classList.add('disabled'); el.disabled=true; el.title='Fully booked';}
    if(state.selDate===dateStr) el.classList.add('sel');
    el.onclick = () => {
      state.selDate = dateStr;
      state.selTime = null;
      buildCalendar(y, m);
      loadSlots();
      const slotOk = document.getElementById('slotOk');
      const slotErr = document.getElementById('slotErr');
      if (slotOk) slotOk.style.display = 'none';
      if (slotErr) slotErr.style.display = 'block';
      validateAll();  // Re-validate when date is selected
      updateBookingSummary();  // Update summary
    };
    grid.appendChild(el);
  }
  title.textContent=new Date(y,m,1).toLocaleString('en-GB',{month:'long',year:'numeric'});
}
// Setup calendar navigation buttons
const prevBtn = qs('#prevMonth');
const nextBtn = qs('#nextMonth');
if (prevBtn) {
  prevBtn.onclick = () => {
    if(curM===0){curM=11;curY--;}else curM--; 
    buildCalendar(curY,curM); 
    loadSlots();
  };
}
if (nextBtn) {
  nextBtn.onclick = () => {
    if(curM===11){curM=0;curY++;}else curM++; 
    buildCalendar(curY,curM); 
    loadSlots();
  };
}

// Initialize calendar on page load (after DOM is ready)
function initCalendar() {
  if (!grid || !title) {
    console.warn('Calendar elements not found');
    return;
  }
  buildCalendar(curY, curM);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCalendar);
} else {
  // DOM already loaded
  initCalendar();
}

/* Timeslots */
async function loadSlots(){
  const wrap=qs('#slots'), hint=qs('#slotsHint'); wrap.innerHTML='';
  const svc=state.svc||state.items[0]?.id; if(!svc){hint.textContent='Add a service to choose date and time.';return;}
  if(!state.selDate){hint.textContent='Choose a date to see available times.';return;}
  hint.textContent='Select a time.'; const avail=await fetchAvailability(svc); const times=avail[state.selDate]||[];
  if(times.length===0){ wrap.innerHTML='<div class="hint">Fully booked on this date. Choose another day.</div>'; return; }
  times.forEach(t=>{const b=document.createElement('button'); b.className='slot'; b.textContent=t;
    if(state.selTime===t) b.classList.add('sel');
    b.onclick = () => {
      state.selTime = t;
      qsa('.slot', wrap).forEach(s => s.classList.remove('sel'));
      b.classList.add('sel');
      show(qs('#slotOk'), true);
      show(qs('#slotErr'), false);
      validateAll();
      updateBookingSummary();  // Update summary when time selected
    };
    wrap.appendChild(b);
  });
}

/* Validation */
const emailOk=v=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
const phoneOk=v=>/^07\d{9}$/.test(v.replace(/\s+/g,''));
const nameOk=v=>/^[A-Za-z][A-Za-z\s'.-]{1,}$/.test(v.trim());

function validateAll(scroll=false){
  const slotValid=!!(state.selDate&&state.selTime);
  const nameEl = qs('#name');
  const emailEl = qs('#email');
  const phoneEl = qs('#phone');
  const agreeBlkEl = qs('#agreeBlk');
  const agreeBizEl = qs('#agreeBiz');
  
  const name = nameEl ? nameEl.value.trim() : '';
  const email = emailEl ? emailEl.value.trim() : '';
  const phone = phoneEl ? phoneEl.value.trim() : '';
  
  const v={
    name: nameOk(name), 
    email: emailOk(email), 
    phone: phoneOk(phone), 
    items: state.items.length > 0, 
    terms: agreeBlkEl && agreeBizEl && agreeBlkEl.checked && agreeBizEl.checked, 
    slot: slotValid
  };
  
  const ok = v.items && v.slot && v.name && v.email && v.phone && v.terms;
  
  const mbPay = qs('#mbPay');
  const floatingPay = qs('#floatingPayBtn');
  
  if (mbPay) {
    if (ok) {
      mbPay.removeAttribute('disabled');
      mbPay.classList.remove('disabled');
    } else {
      mbPay.setAttribute('disabled', 'true');
      mbPay.classList.add('disabled');
    }
  }
  
  if (floatingPay) {
    if (ok) {
      floatingPay.removeAttribute('disabled');
      floatingPay.classList.remove('disabled');
    } else {
      floatingPay.setAttribute('disabled', 'true');
      floatingPay.classList.add('disabled');
    }
  }
  
  // Debug logging to help identify what's missing
  if (!ok) {
    console.log('Validation failed:', {
      items: v.items,
      slot: v.slot,
      name: v.name,
      email: v.email,
      phone: v.phone,
      terms: v.terms,
      stateItems: state.items,
      selDate: state.selDate,
      selTime: state.selTime
    });
  }
  
  return ok;
}
['name','email','phone'].forEach(id=>qs('#'+id).addEventListener('input',()=>validateAll(false)));
['agreeBlk','agreeBiz'].forEach(id=>qs('#'+id).addEventListener('change',()=>validateAll(false)));

/* Pay - Redirect to payment screen */
async function doPay(){
  console.log('doPay function called');
  console.log('Current state:', JSON.parse(JSON.stringify(state)));
  
  // Check state before validation
  if (!state.items || state.items.length === 0) {
    console.error('No items in state!', state);
    alert('Please add at least one service to your booking.');
    return;
  }
  
  if (!state.selDate || !state.selTime) {
    console.error('No date/time selected!', { date: state.selDate, time: state.selTime });
    alert('Please select a date and time for your booking.');
    return;
  }
  
  const validationResult = validateAll(true);
  console.log('Validation result:', validationResult);
  if(!validationResult) {
    console.log('Validation failed, not proceeding with payment');
    alert('Please complete all required fields before proceeding.');
    return;
  }
  
  // Capture new customer status
  const isNewCustomer = qs('#isNewCustomer').checked;
  
  // Calculate total
  const total = state.items.reduce((sum, item) => sum + item.price, 0);
  
  console.log('doPay called with state:', {
    items: state.items,
    selDate: state.selDate,
    selTime: state.selTime,
    total: total
  });
  
  // Prepare booking data
  const bookingData = {
    business: biz,
    services: state.items,
    total: total,
    date: state.selDate,
    time: state.selTime,
    customerName: qs('#name').value,
    customerEmail: qs('#email').value,
    customerPhone: qs('#phone').value,
    postcode: qs('#postcode') ? qs('#postcode').value : '',
    notes: qs('#notes') ? qs('#notes').value : '',
    isNewCustomer: isNewCustomer
  };
  
  // Create booking summary for payment page
  const bookingSummary = {
    services: state.items,
    total: total,
    date: state.selDate,
    time: state.selTime,
    customerName: qs('#name').value,
    customerEmail: qs('#email').value,
    customerPhone: qs('#phone').value,
    duration: state.items.reduce((sum, item) => sum + (item.duration || 0), 0)
  };

  // Save to localStorage before redirecting
  localStorage.setItem("bookingSummary", JSON.stringify(bookingSummary));
  
  console.log('Stored booking summary:', bookingSummary);

  // Redirect to payment page
  window.location.href = "payment.html";
}
// Set up click handlers after DOM is ready
function setupPayButtons() {
  console.log('Setting up click handlers...');
  console.log('Page loaded, DOM ready');

  const mbPayBtn = document.getElementById('mbPay');
  const floatingPayBtn = document.getElementById('floatingPayBtn');

  console.log('Found buttons:', { 
    mbPay: !!mbPayBtn, 
    floatingPay: !!floatingPayBtn,
    mbPayDisabled: mbPayBtn?.disabled,
    floatingPayDisabled: floatingPayBtn?.disabled
  });

  if (mbPayBtn) {
    // Remove any existing listeners
    mbPayBtn.replaceWith(mbPayBtn.cloneNode(true));
    const newMbPayBtn = document.getElementById('mbPay');
    
    newMbPayBtn.addEventListener('click', (e) => {
      console.log('Mobile Pay button clicked', e);
      e.preventDefault();
      e.stopPropagation();
      console.log('About to call doPay()');
      doPay();
      return false;
    });
    
    // Also add onclick as backup
    newMbPayBtn.onclick = function(e) {
      console.log('Mobile Pay button onclick triggered');
      e.preventDefault();
      doPay();
      return false;
    };
    console.log('Mobile pay button handler attached');
  } else {
    console.error('Mobile pay button not found');
  }

  if (floatingPayBtn) {
    // Remove any existing listeners
    floatingPayBtn.replaceWith(floatingPayBtn.cloneNode(true));
    const newFloatingPayBtn = document.getElementById('floatingPayBtn');
    
    newFloatingPayBtn.addEventListener('click', (e) => {
      console.log('Floating Pay button clicked', e);
      e.preventDefault();
      e.stopPropagation();
      console.log('About to call doPay()');
      doPay();
      return false;
    });
    
    // Also add onclick as backup
    newFloatingPayBtn.onclick = function(e) {
      console.log('Floating Pay button onclick triggered');
      e.preventDefault();
      doPay();
      return false;
    };
    console.log('Floating pay button handler attached');
  } else {
    console.error('Floating pay button not found');
  }
}

// Setup when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupPayButtons);
} else {
  setupPayButtons();
}

// Also try a small delay in case of async loading
setTimeout(setupPayButtons, 500);

// Test if the page is working at all
console.log('Booking page script loaded');
console.log('State object:', state);
console.log('qs function:', typeof qs);

// Test button click manually
window.testPay = function() {
  console.log('Manual testPay called');
  doPay();
};
qs('#closeSuccess').onclick=()=>qs('#successModal').style.display='none';

/* Mobile drawer */
const drawer=qs('#drawer'); qs('#openDrawer').onclick=()=>drawer.classList.toggle('open');

/* Authentication redirects for booking context */
function redirectToLoginFromBooking() {
    // Store current booking page URL and basket contents
    const currentUrl = window.location.href;
    const basketData = {
        items: state.items,
        selDate: state.selDate,
        selTime: state.selTime,
        svc: state.svc
    };
    
    // Store basket data for restoration after login
    localStorage.setItem('bookingBasket', JSON.stringify(basketData));
    
    // Set context for booking-based authentication
    if (window.setAuthReturnUrl) {
        window.setAuthReturnUrl(currentUrl, 'booking');
    } else {
        localStorage.setItem('returnUrl', currentUrl);
        localStorage.setItem('authContext', 'booking');
    }
    
    window.location.href = 'customer-login.html';
}

function redirectToRegisterFromBooking() {
    // Store current booking page URL and basket contents
    const currentUrl = window.location.href;
    const basketData = {
        items: state.items,
        selDate: state.selDate,
        selTime: state.selTime,
        svc: state.svc
    };
    
    // Store basket data for restoration after registration
    localStorage.setItem('bookingBasket', JSON.stringify(basketData));
    
    // Set context for booking-based authentication
    if (window.setAuthReturnUrl) {
        window.setAuthReturnUrl(currentUrl, 'booking');
    } else {
        localStorage.setItem('returnUrl', currentUrl);
        localStorage.setItem('authContext', 'booking');
    }
    
    window.location.href = 'customer-register.html';
}

/* Restore booking state after authentication */
function restoreBookingState() {
    const savedBasket = localStorage.getItem('bookingBasket');
    if (savedBasket) {
        try {
            const basketData = JSON.parse(savedBasket);
            state.items = basketData.items || [];
            state.selDate = basketData.selDate;
            state.selTime = basketData.selTime;
            state.svc = basketData.svc;
            
            // Re-render the booking page with restored state
            renderBasket();
            if (state.selDate) {
                buildCalendar(curY, curM);
                loadSlots();
            }
            
            // Clear saved basket data
            localStorage.removeItem('bookingBasket');
            
            console.log('Booking state restored:', basketData);
        } catch (error) {
            console.error('Failed to restore booking state:', error);
        }
    }
}

// Restore booking state on page load
document.addEventListener('DOMContentLoaded', restoreBookingState);

/* Postcode suggestions */
const postcodeSuggestions = [
  "B1 1AA", "B1 2AB", "SW1A 1AA", "E1 6AN", "M1 1AE", "L1 8JQ"
];

function suggestPostcode() {
  const input = document.getElementById("postcode");
  const list = document.getElementById("postcodeSuggestions");
  const val = input.value.toUpperCase();
  list.innerHTML = "";
  if (!val || val.length < 2) {
    list.style.display = "none";
    return;
  }
  const matches = postcodeSuggestions.filter(p => p.startsWith(val));
  if (matches.length === 0) {
    list.style.display = "none";
    return;
  }
  matches.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p;
    li.onclick = () => {
      input.value = p;
      list.style.display = "none";
      validateAll();
    };
    list.appendChild(li);
  });
  list.style.display = "block";
}

// Add event listener for postcode input
qs('#postcode').addEventListener('input', suggestPostcode);

// ✅ Keep floating total synced
function updateFloatingTotal() {
  const total = document.getElementById("total")?.textContent || "£0.00";
  document.getElementById("floatingTotal").textContent = total;
}

// ✅ Update selected service, date & time in floating summary
function updateFloatingSummary() {
  const service = state.items.map(i => i.name).join(", ") || "No service selected";
  const date = state.selDate ? new Date(state.selDate).toLocaleDateString("en-GB", {
    weekday: "short", day: "numeric", month: "short"
  }) : "No date selected";
  const time = state.selTime || "No time selected";

  const floatingServiceEl = document.getElementById("floatingService");
  const floatingDateTimeEl = document.getElementById("floatingDateTime");
  
  if (floatingServiceEl) {
    floatingServiceEl.textContent = service;
  }
  if (floatingDateTimeEl) {
    floatingDateTimeEl.textContent = state.selDate && state.selTime ? `${date} • ${time}` : `${date}`;
  }
}

// Observe total updates
const totalObserver = new MutationObserver(updateFloatingTotal);
const totalNode = document.getElementById("total");
if (totalNode) {
  totalObserver.observe(totalNode, { childList: true });
}
updateFloatingTotal();

// Whenever selections change, refresh floating summary
["click", "change", "input"].forEach(evt => {
  document.body.addEventListener(evt, updateFloatingSummary, true);
});

// Removed conflicting onclick handler - doPay() already handles navigation

// ✅ Auto-updating Booking Summary (desktop + mobile)

// main update function
function updateBookingSummary() {
  console.log('updateBookingSummary called with state:', state);
  const services = state.items.map(i => `<div>${i.name} <strong>${gbp(i.price)}</strong></div>`).join("") || "—";
  
  // Calculate total from state instead of reading from DOM
  const sub = state.items.reduce((s,i)=>s+Number(i.price||0),0);
  const appliedRedemption = getAppliedRedemption(sub);
  const payable = Math.max(0, sub - appliedRedemption);
  const total = gbp(payable);
  
  const date = state.selDate
    ? new Date(state.selDate).toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short" })
    : "—";
  const time = state.selTime || "—";

  // Calculate total duration from all services
  const duration = state.items.length
    ? `${state.items.reduce((sum, i) => sum + (i.duration || 0), 0)} min`
    : "—";

  // desktop panel (with safety checks)
  const summaryServices = document.getElementById("summaryServices");
  if (summaryServices) summaryServices.innerHTML = services;
  
  const summaryDuration = document.getElementById("summaryDuration");
  if (summaryDuration) summaryDuration.textContent = duration;
  
  const summaryDate = document.getElementById("summaryDate");
  if (summaryDate) summaryDate.textContent = date;
  
  const summaryTime = document.getElementById("summaryTime");
  if (summaryTime) summaryTime.textContent = time;
  
  const summaryTotal = document.getElementById("summaryTotal");
  if (summaryTotal) summaryTotal.textContent = total;

  // mobile drawer (with safety checks)
  const drawerServices = document.getElementById("drawerServices");
  if (drawerServices) drawerServices.innerHTML = services;
  
  const drawerDuration = document.getElementById("drawerDuration");
  if (drawerDuration) drawerDuration.textContent = duration;
  
  const drawerDate = document.getElementById("drawerDate");
  if (drawerDate) drawerDate.textContent = date;
  
  const drawerTime = document.getElementById("drawerTime");
  if (drawerTime) drawerTime.textContent = time;
  
  const drawerTotal = document.getElementById("drawerTotal");
  if (drawerTotal) drawerTotal.textContent = total;
}

// run when anything changes anywhere on page
["click", "input", "change"].forEach(evt => {
  document.body.addEventListener(evt, updateBookingSummary, true);
});

// also observe the total for mutation (live recalculation)
const summaryTotalObserver = new MutationObserver(updateBookingSummary);
const summaryTotalNode = document.getElementById("total");
if (summaryTotalNode) {
  summaryTotalObserver.observe(summaryTotalNode, { childList: true });
}
updateBookingSummary();

// ✅ Mobile drawer open/close
const summaryDrawer = document.getElementById("summaryDrawer");
const openBtn = document.getElementById("openSummary");
const closeBtn = document.getElementById("closeSummary");

openBtn.onclick = () => summaryDrawer.classList.add("open");
closeBtn.onclick = () => summaryDrawer.classList.remove("open");
summaryDrawer.addEventListener("click", e => {
  if (e.target === summaryDrawer) summaryDrawer.classList.remove("open");
});

// ✅ Update mobile summary badge live
function updateSummaryBadge() {
  const count = state.items.length;
  const total = document.getElementById("total")?.textContent || "£0.00";
  const badge = document.getElementById("summaryBadge");

  if (!badge) return;

  if (count === 0) {
    badge.textContent = "No items";
    document.getElementById("openSummary").disabled = true;
    document.getElementById("openSummary").style.opacity = 0.5;
  } else {
    badge.textContent = `${count} ${count === 1 ? "item" : "items"} • ${total}`;
    document.getElementById("openSummary").disabled = false;
    document.getElementById("openSummary").style.opacity = 1;
  }
}

// observe basket & listen for changes
["click", "input", "change"].forEach(evt => {
  document.body.addEventListener(evt, updateSummaryBadge, true);
});

const totalObserver2 = new MutationObserver(updateSummaryBadge);
const totalNode2 = document.getElementById("total");
if (totalNode2) totalObserver2.observe(totalNode2, { childList: true });

updateSummaryBadge();

// ──────────────────────────────
//  BLKPOINTS STATUS TRACKING
// ──────────────────────────────

function updateRedemptionStatus(newStatus) {
  const redemptionStatusEl = document.getElementById("redemptionStatus");
  if (!redemptionStatusEl) return;

  redemptionStatusEl.classList.remove("pending", "confirmed", "released");

  if (newStatus === "completed") {
    redemptionStatusEl.classList.add("confirmed");
    redemptionStatusEl.innerHTML = "✅ BlkPoints discount confirmed — booking completed";
    updateProgress("completed");
  } 
  else if (newStatus === "cancelled") {
    redemptionStatusEl.classList.add("released");
    redemptionStatusEl.innerHTML = "🔁 Booking cancelled — BlkPoints returned to your balance";
    updateProgress("cancelled");
  } 
  else {
    redemptionStatusEl.classList.add("pending");
    redemptionStatusEl.innerHTML = "⏳ BlkPoints discount applied — pending until booking completed";
    updateProgress("pending");
  }
}

function updateProgress(status) {
  const fill = document.getElementById("progressFill");
  if (!fill) return;
  
  if (status === "pending") fill.style.width = "30%";
  if (status === "completed") fill.style.width = "100%";
  if (status === "cancelled") fill.style.width = "0%";
}

function addRedemptionStatusBadge() {
  const appliedRedemption = getAppliedRedemption(state.items.reduce((s,i)=>s+Number(i.price||0),0));
  
  if (appliedRedemption > 0) {
    // Add status badge to booking summary
    const summaryPanel = qs('#summaryPanel');
    if (summaryPanel && !qs('#redemptionStatusBadge')) {
      const badge = document.createElement('div');
      badge.id = 'redemptionStatusBadge';
      badge.className = 'redemption-status pending';
      badge.innerHTML = `⏳ £${appliedRedemption.toFixed(2)} BlkPoints discount (pending until booking completed)`;
      
      // Add progress bar
      const progressContainer = document.createElement('div');
      progressContainer.className = 'points-progress';
      progressContainer.innerHTML = '<div class="progress-fill" id="progressFill"></div>';
      
      badge.appendChild(progressContainer);
      summaryPanel.appendChild(badge);
      
      // Initialize progress
      updateProgress("pending");
    }
  }
}

// Poll for booking status updates (simulate real-time updates)
function startStatusPolling() {
  const appliedRedemption = getAppliedRedemption(state.items.reduce((s,i)=>s+Number(i.price||0),0));
  
  if (appliedRedemption > 0) {
    // Simulate status updates for demo (replace with real API polling)
    setTimeout(() => {
      // Simulate booking completion after 5 seconds
      updateRedemptionStatus("completed");
    }, 5000);
  }
}

/* Init */
let curDate=new Date(); curDate.setHours(0,0,0,0);
buildCalendar(curDate.getFullYear(),curDate.getMonth());
renderBasket();
loadSlots();

// Initialize BlkPoints status tracking
addRedemptionStatusBadge();
startStatusPolling();

// Initialize dummy customer data and validate on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    // Trigger validation to show form is valid
    setTimeout(() => validateAll(), 100);
  });
} else {
  // DOM already loaded
  setTimeout(() => validateAll(), 100);
}
  </script>
</body>
</html>